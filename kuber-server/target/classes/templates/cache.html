<!DOCTYPE html>
<!--
  ~ Copyright Â© 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  -->
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout :: head('Cache Browser')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div th:replace="~{layout :: alerts}"></div>
    
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col">
                <h2 class="mb-0">
                    <i class="fas fa-box me-2"></i>
                    Cache Browser
                </h2>
            </div>
            <div class="col-auto">
                <a th:href="@{/api/export/region/{region}(region=${currentRegion})}" class="btn btn-success me-2">
                    <i class="fas fa-download me-1"></i> Export CSV
                </a>
                <a th:href="@{/cache/insert(region=${currentRegion})}" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Insert Entry
                </a>
                <a th:href="@{/cache/query}" class="btn btn-outline-secondary">
                    <i class="fas fa-search me-1"></i> Query
                </a>
            </div>
        </div>
        
        <!-- Region Selector -->
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <label for="regionSelect" class="form-label fw-semibold">
                            <i class="fas fa-layer-group me-1"></i> Select Region
                        </label>
                        <select id="regionSelect" class="form-select" onchange="changeRegion(this.value)">
                            <option th:each="region : ${regions}" 
                                    th:value="${region.name}" 
                                    th:text="${region.name}"
                                    th:selected="${region.name == currentRegion}">
                            </option>
                        </select>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <label for="limitInput" class="form-label fw-semibold">
                            <i class="fas fa-list-ol me-1"></i> Display Limit
                        </label>
                        <div class="input-group">
                            <input type="number" id="limitInput" class="form-control" 
                                   th:value="${limit}" min="1" max="100000" placeholder="10000">
                            <button class="btn btn-outline-primary" type="button" onclick="applyLimit()">
                                Apply
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Limit Warning Alert -->
        <div th:if="${hasMore}" class="alert alert-warning alert-dismissible fade show mb-4" role="alert">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Results Limited!</strong> 
            More than <span th:text="${limit}">10000</span> entries exist in this region 
            (Total: <span th:text="${totalKeys}">0</span>). 
            Only <span th:text="${resultCount}">10000</span> entries are displayed.
            Please refine your query or increase the limit to see more results.
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
        
        <!-- Keys Table -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-3">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-key me-2 text-primary"></i>
                        Keys in <code th:text="${currentRegion}">default</code>
                    </h5>
                    <span class="badge bg-secondary" th:text="'Total: ' + ${totalKeys}">Total: 0</span>
                </div>
            </div>
            
            <!-- Table Controls -->
            <div class="card-body border-bottom py-2">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <div class="d-flex align-items-center">
                            <label class="me-2 text-muted small">Show:</label>
                            <select id="rowsPerPage" class="form-select form-select-sm" style="width: auto;" onchange="updateTable()">
                                <option value="10">10</option>
                                <option value="25" selected>25</option>
                                <option value="50">50</option>
                                <option value="100">100</option>
                                <option value="all">All</option>
                            </select>
                            <span class="ms-2 text-muted small">entries</span>
                        </div>
                    </div>
                    <div class="col">
                        <div class="input-group input-group-sm" style="max-width: 300px;">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="tableSearch" class="form-control" 
                                   placeholder="Search keys..." oninput="updateTable()">
                            <button class="btn btn-outline-secondary" type="button" onclick="clearSearch()">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                    </div>
                    <div class="col-auto">
                        <span id="tableInfo" class="text-muted small"></span>
                    </div>
                </div>
            </div>
            
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="keysTable">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4" style="cursor: pointer;" onclick="sortTable('key')">
                                    Key <i id="sortIcon" class="fas fa-sort ms-1 text-muted"></i>
                                </th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr th:each="key : ${keys}" class="data-row" th:data-key="${key}">
                                <td class="ps-4">
                                    <a th:href="@{/cache/entry(region=${currentRegion},key=${key})}" 
                                       class="text-decoration-none key-name">
                                        <i class="fas fa-key me-2 text-muted"></i>
                                        <span th:text="${key}">key-name</span>
                                    </a>
                                </td>
                                <td class="text-end pe-4">
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{/cache/entry(region=${currentRegion},key=${key})}" 
                                           class="btn btn-outline-primary" title="View">
                                            <i class="fas fa-eye"></i>
                                        </a>
                                        <form th:action="@{/cache/delete}" method="post" class="d-inline"
                                              onsubmit="return confirm('Delete this entry?')">
                                            <input type="hidden" name="region" th:value="${currentRegion}">
                                            <input type="hidden" name="key" th:value="${key}">
                                            <button type="submit" class="btn btn-outline-danger" title="Delete"
                                                    sec:authorize="hasAnyRole('ADMIN', 'OPERATOR', 'USER')">
                                                <i class="fas fa-trash"></i>
                                            </button>
                                        </form>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(keys)}" class="empty-row">
                                <td colspan="2" class="text-center py-5 text-muted">
                                    <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                    No entries found in this region
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            
            <!-- Pagination -->
            <div class="card-footer bg-white border-0">
                <div class="d-flex justify-content-between align-items-center">
                    <div id="paginationInfo" class="text-muted small"></div>
                    <nav>
                        <ul class="pagination pagination-sm mb-0" id="pagination"></ul>
                    </nav>
                </div>
            </div>
        </div>
        
        <!-- Glossary Card -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm bg-light">
                    <div class="card-body">
                        <h6 class="card-title text-muted mb-3">
                            <i class="fas fa-question-circle me-2"></i>Glossary
                        </h6>
                        <div class="row small">
                            <div class="col-md-4">
                                <dl class="mb-0">
                                    <dt>Key</dt>
                                    <dd class="text-muted">Unique identifier for a cache entry within a region.</dd>
                                    <dt>Region</dt>
                                    <dd class="text-muted">Logical namespace grouping related cache entries.</dd>
                                </dl>
                            </div>
                            <div class="col-md-4">
                                <dl class="mb-0">
                                    <dt>Entry</dt>
                                    <dd class="text-muted">A key-value pair stored in the cache with optional TTL.</dd>
                                    <dt>Export CSV</dt>
                                    <dd class="text-muted">Download all entries as comma-separated values file.</dd>
                                </dl>
                            </div>
                            <div class="col-md-4">
                                <dl class="mb-0">
                                    <dt>Insert Entry</dt>
                                    <dd class="text-muted">Add a new key-value pair to the current region.</dd>
                                    <dt>Query</dt>
                                    <dd class="text-muted">Search entries using JSONPath expressions.</dd>
                                    <dt>Display Limit</dt>
                                    <dd class="text-muted">Max entries shown (default: 10,000). Increase if results are truncated.</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{layout :: footer}"></footer>
<th:block th:replace="~{layout :: scripts}"></th:block>

<script>
    // Table state
    let allRows = [];
    let filteredRows = [];
    let currentPage = 1;
    let sortDirection = 'asc';
    
    // Initialize on page load
    document.addEventListener('DOMContentLoaded', function() {
        // Collect all data rows
        document.querySelectorAll('.data-row').forEach(row => {
            allRows.push({
                element: row.cloneNode(true),
                key: row.dataset.key.toLowerCase()
            });
        });
        filteredRows = [...allRows];
        updateTable();
    });
    
    function changeRegion(region) {
        const limit = document.getElementById('limitInput').value;
        let url = '/cache?region=' + encodeURIComponent(region);
        if (limit && limit != 10000) {
            url += '&limit=' + limit;
        }
        window.location.href = url;
    }
    
    function applyLimit() {
        const region = document.getElementById('regionSelect').value;
        const limit = document.getElementById('limitInput').value;
        let url = '/cache?region=' + encodeURIComponent(region);
        if (limit) {
            url += '&limit=' + limit;
        }
        window.location.href = url;
    }
    
    function clearSearch() {
        document.getElementById('tableSearch').value = '';
        updateTable();
    }
    
    function getRowsPerPage() {
        const select = document.getElementById('rowsPerPage');
        return select.value === 'all' ? filteredRows.length : parseInt(select.value);
    }
    
    function sortTable(column) {
        sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        
        filteredRows.sort((a, b) => {
            const aVal = a.key;
            const bVal = b.key;
            if (sortDirection === 'asc') {
                return aVal.localeCompare(bVal);
            } else {
                return bVal.localeCompare(aVal);
            }
        });
        
        // Update sort icon
        const icon = document.getElementById('sortIcon');
        icon.className = sortDirection === 'asc' ? 'fas fa-sort-up ms-1 text-primary' : 'fas fa-sort-down ms-1 text-primary';
        
        currentPage = 1;
        renderTable();
    }
    
    function updateTable() {
        const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
        
        // Filter rows
        if (searchTerm) {
            filteredRows = allRows.filter(row => row.key.includes(searchTerm));
        } else {
            filteredRows = [...allRows];
        }
        
        currentPage = 1;
        renderTable();
    }
    
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const rowsPerPage = getRowsPerPage();
        const totalRows = filteredRows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;
        
        // Ensure current page is valid
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;
        
        // Calculate slice
        const start = (currentPage - 1) * rowsPerPage;
        const end = Math.min(start + rowsPerPage, totalRows);
        const pageRows = filteredRows.slice(start, end);
        
        // Clear and render table body
        tbody.innerHTML = '';
        
        if (pageRows.length === 0) {
            tbody.innerHTML = `
                <tr class="empty-row">
                    <td colspan="2" class="text-center py-5 text-muted">
                        <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                        No entries found
                    </td>
                </tr>
            `;
        } else {
            pageRows.forEach(row => {
                tbody.appendChild(row.element.cloneNode(true));
            });
        }
        
        // Update info text
        document.getElementById('tableInfo').textContent = 
            totalRows > 0 ? `Showing ${start + 1} to ${end} of ${totalRows} entries` : 'No entries';
        
        document.getElementById('paginationInfo').textContent = 
            totalPages > 1 ? `Page ${currentPage} of ${totalPages}` : '';
        
        // Render pagination
        renderPagination(totalPages);
    }
    
    function renderPagination(totalPages) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">&laquo;</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers (show max 7 pages)
        let startPage = Math.max(1, currentPage - 3);
        let endPage = Math.min(totalPages, startPage + 6);
        if (endPage - startPage < 6) {
            startPage = Math.max(1, endPage - 6);
        }
        
        if (startPage > 1) {
            pagination.appendChild(createPageItem(1));
            if (startPage > 2) {
                const dots = document.createElement('li');
                dots.className = 'page-item disabled';
                dots.innerHTML = '<span class="page-link">...</span>';
                pagination.appendChild(dots);
            }
        }
        
        for (let i = startPage; i <= endPage; i++) {
            pagination.appendChild(createPageItem(i));
        }
        
        if (endPage < totalPages) {
            if (endPage < totalPages - 1) {
                const dots = document.createElement('li');
                dots.className = 'page-item disabled';
                dots.innerHTML = '<span class="page-link">...</span>';
                pagination.appendChild(dots);
            }
            pagination.appendChild(createPageItem(totalPages));
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">&raquo;</a>`;
        pagination.appendChild(nextLi);
    }
    
    function createPageItem(page) {
        const li = document.createElement('li');
        li.className = `page-item ${page === currentPage ? 'active' : ''}`;
        li.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${page}); return false;">${page}</a>`;
        return li;
    }
    
    function goToPage(page) {
        currentPage = page;
        renderTable();
    }
</script>

</body>
</html>
