<!DOCTYPE html>
<!--
  ~ Copyright Â© 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  -->
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout :: head('Dashboard')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div th:replace="~{layout :: alerts}"></div>
    
    <div class="container-fluid py-4">
        <!-- Page Header -->
        <div class="row mb-4">
            <div class="col">
                <h2 class="mb-0">
                    <i class="fas fa-tachometer-alt me-2"></i>
                    Dashboard
                </h2>
                <p class="text-muted mb-0">
                    Node: <code th:text="${nodeId}">node-id</code>
                </p>
            </div>
            <div class="col-auto">
                <span th:if="${isPrimary}" class="badge bg-success fs-6">
                    <i class="fas fa-crown me-1"></i> PRIMARY
                </span>
                <span th:unless="${isPrimary}" class="badge bg-warning text-dark fs-6">
                    <i class="fas fa-clone me-1"></i> SECONDARY (Read-Only)
                </span>
            </div>
        </div>
        
        <!-- Stats Cards -->
        <div class="row g-4 mb-4">
            <!-- Total Entries -->
            <div class="col-xl-3 col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 bg-primary bg-gradient rounded-3 p-3">
                                <i class="fas fa-database fa-2x text-white"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="text-muted mb-1">Total Entries</h6>
                                <h3 class="mb-0" th:text="${#numbers.formatInteger(totalEntries, 1, 'COMMA')}">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-0">
                        <small class="text-muted">
                            Max: <span th:text="${#numbers.formatInteger(maxMemoryEntries, 1, 'COMMA')}">100000</span>
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Regions -->
            <div class="col-xl-3 col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 bg-success bg-gradient rounded-3 p-3">
                                <i class="fas fa-layer-group fa-2x text-white"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="text-muted mb-1">Regions</h6>
                                <h3 class="mb-0" th:text="${regionCount}">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-0">
                        <a th:href="@{/regions}" class="text-decoration-none small">
                            View all regions <i class="fas fa-arrow-right ms-1"></i>
                        </a>
                    </div>
                </div>
            </div>
            
            <!-- Connections -->
            <div class="col-xl-3 col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 bg-info bg-gradient rounded-3 p-3">
                                <i class="fas fa-plug fa-2x text-white"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="text-muted mb-1">Active Connections</h6>
                                <h3 class="mb-0" th:text="${activeConnections}">0</h3>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-0">
                        <small th:if="${serverRunning}" class="text-success">
                            <i class="fas fa-circle fa-xs me-1"></i> Server running on port <span th:text="${redisPort}">6380</span>
                        </small>
                        <small th:unless="${serverRunning}" class="text-danger">
                            <i class="fas fa-circle fa-xs me-1"></i> Server stopped
                        </small>
                    </div>
                </div>
            </div>
            
            <!-- Mode -->
            <div class="col-xl-3 col-md-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div th:class="'flex-shrink-0 rounded-3 p-3 bg-gradient ' + (${isPrimary} ? 'bg-warning' : 'bg-secondary')">
                                <i th:class="'fa-2x text-white fas ' + (${isPrimary} ? 'fa-crown' : 'fa-clone')"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="text-muted mb-1">Replication Mode</h6>
                                <h3 class="mb-0" th:text="${replicationMode}">STANDALONE</h3>
                            </div>
                        </div>
                    </div>
                    <div class="card-footer bg-transparent border-0">
                        <small class="text-muted">
                            <span th:if="${persistentMode}"><i class="fas fa-check text-success me-1"></i> Persistent mode</span>
                            <span th:unless="${persistentMode}"><i class="fas fa-bolt text-warning me-1"></i> Async persistence</span>
                        </small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Persistence Backend Card -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body">
                        <div class="d-flex align-items-center">
                            <div class="flex-shrink-0 bg-dark bg-gradient rounded-3 p-3">
                                <i class="fas fa-hdd fa-2x text-white"></i>
                            </div>
                            <div class="flex-grow-1 ms-3">
                                <h6 class="text-muted mb-1">Persistence Backend</h6>
                                <div class="d-flex align-items-center">
                                    <h4 class="mb-0 me-3" th:text="${persistenceType}">MONGODB</h4>
                                    <span th:if="${persistenceAvailable}" class="badge bg-success">
                                        <i class="fas fa-check-circle me-1"></i> Connected
                                    </span>
                                    <span th:unless="${persistenceAvailable}" class="badge bg-danger">
                                        <i class="fas fa-times-circle me-1"></i> Unavailable
                                    </span>
                                </div>
                            </div>
                            <div class="flex-grow-1 ms-3 text-end">
                                <small class="text-muted d-block">Configuration</small>
                                <code class="small" th:text="${persistenceConfig}">mongodb://localhost:27017</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Regions Table -->
        <div class="row">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-layer-group me-2 text-primary"></i>
                                Cache Regions
                            </h5>
                            <a th:href="@{/regions/create}" class="btn btn-primary btn-sm" sec:authorize="hasAnyRole('ADMIN', 'OPERATOR')">
                                <i class="fas fa-plus me-1"></i> Create Region
                            </a>
                        </div>
                    </div>
                    <!-- Table Controls -->
                    <div class="card-body border-bottom py-2">
                        <div class="row align-items-center">
                            <div class="col-auto">
                                <div class="d-flex align-items-center">
                                    <label class="me-2 text-muted small">Show:</label>
                                    <select id="rowsPerPage" class="form-select form-select-sm" style="width: auto;" onchange="updateTable()">
                                        <option value="10" selected>10</option>
                                        <option value="25">25</option>
                                        <option value="50">50</option>
                                        <option value="all">All</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col">
                                <div class="input-group input-group-sm" style="max-width: 250px;">
                                    <span class="input-group-text"><i class="fas fa-search"></i></span>
                                    <input type="text" id="tableSearch" class="form-control" 
                                           placeholder="Search regions..." oninput="updateTable()">
                                </div>
                            </div>
                            <div class="col-auto">
                                <span id="tableInfo" class="text-muted small"></span>
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover align-middle mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th class="ps-4" style="cursor: pointer;" onclick="sortTable(0)">
                                            Name <i class="fas fa-sort ms-1 text-muted sort-icon"></i>
                                        </th>
                                        <th>Description</th>
                                        <th class="text-center" style="cursor: pointer;" onclick="sortTable(2)">
                                            Entries <i class="fas fa-sort ms-1 text-muted sort-icon"></i>
                                        </th>
                                        <th class="text-center">Type</th>
                                        <th class="text-center">Status</th>
                                        <th class="text-end pe-4">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="tableBody">
                                    <tr th:each="region : ${regions}" class="data-row"
                                        th:data-name="${region.name}" 
                                        th:data-entries="${region.entryCount}">
                                        <td class="ps-4">
                                            <a th:href="@{/regions/{name}(name=${region.name})}" class="fw-semibold text-decoration-none">
                                                <i th:class="'fas me-2 ' + (${region.default} ? 'fa-star text-warning' : 'fa-folder text-primary')"></i>
                                                <span th:text="${region.name}">default</span>
                                            </a>
                                        </td>
                                        <td class="text-muted" th:text="${region.description} ?: 'No description'">Description</td>
                                        <td class="text-center">
                                            <span class="badge bg-light text-dark" th:text="${#numbers.formatInteger(region.entryCount, 1, 'COMMA')}">0</span>
                                        </td>
                                        <td class="text-center">
                                            <span th:if="${region.captive}" class="badge bg-warning text-dark">Captive</span>
                                            <span th:unless="${region.captive}" class="badge bg-secondary">Standard</span>
                                        </td>
                                        <td class="text-center">
                                            <span th:if="${region.enabled}" class="badge bg-success">Active</span>
                                            <span th:unless="${region.enabled}" class="badge bg-danger">Disabled</span>
                                        </td>
                                        <td class="text-end pe-4">
                                            <div class="btn-group btn-group-sm">
                                                <a th:href="@{/cache(region=${region.name})}" class="btn btn-outline-primary" title="Browse">
                                                    <i class="fas fa-search"></i>
                                                </a>
                                                <a th:href="@{/regions/{name}(name=${region.name})}" class="btn btn-outline-secondary" title="Details">
                                                    <i class="fas fa-info-circle"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                    <tr th:if="${#lists.isEmpty(regions)}" class="empty-row">
                                        <td colspan="6" class="text-center py-5 text-muted">
                                            <i class="fas fa-inbox fa-3x mb-3 d-block"></i>
                                            No regions found
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    <!-- Pagination -->
                    <div class="card-footer bg-white border-0">
                        <div class="d-flex justify-content-between align-items-center">
                            <div id="paginationInfo" class="text-muted small"></div>
                            <nav><ul class="pagination pagination-sm mb-0" id="pagination"></ul></nav>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Quick Actions -->
        <div class="row mt-4">
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0">
                            <i class="fas fa-terminal me-2 text-primary"></i>
                            Quick Connect
                        </h5>
                    </div>
                    <div class="card-body">
                        <p class="text-muted mb-3">Connect using Redis CLI or any Redis client:</p>
                        <div class="bg-dark text-light p-3 rounded font-monospace">
                            <code>redis-cli -p <span th:text="${redisPort}">6380</span></code>
                        </div>
                        <p class="text-muted mt-3 mb-2">Or use the REST API:</p>
                        <div class="bg-dark text-light p-3 rounded font-monospace">
                            <code>curl http://localhost:8080/api/info</code>
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0">
                            <i class="fas fa-bolt me-2 text-warning"></i>
                            Server Configuration
                        </h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="fas fa-server me-2 text-muted"></i> Redis Port</span>
                                <code th:text="${redisPort}">6380</code>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="fas fa-memory me-2 text-muted"></i> Max Memory Entries</span>
                                <code th:text="${#numbers.formatInteger(maxMemoryEntries, 1, 'COMMA')}">100,000</code>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="fas fa-save me-2 text-muted"></i> Persistence Mode</span>
                                <span th:if="${persistentMode}" class="badge bg-success">Sync</span>
                                <span th:unless="${persistentMode}" class="badge bg-info">Async</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
                                <span><i class="fas fa-sync me-2 text-muted"></i> Replication</span>
                                <span th:text="${replicationMode}">STANDALONE</span>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Glossary Card -->
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm bg-light">
                    <div class="card-body">
                        <h6 class="card-title text-muted mb-3">
                            <i class="fas fa-question-circle me-2"></i>Glossary
                        </h6>
                        <div class="row small">
                            <div class="col-md-3">
                                <dl class="mb-0">
                                    <dt>Regions</dt>
                                    <dd class="text-muted">Logical namespaces for organizing cache entries.</dd>
                                    <dt>Total Keys</dt>
                                    <dd class="text-muted">Total number of unique key-value pairs stored.</dd>
                                </dl>
                            </div>
                            <div class="col-md-3">
                                <dl class="mb-0">
                                    <dt>Hit Ratio</dt>
                                    <dd class="text-muted">Percentage of cache lookups that found data. Higher is better.</dd>
                                    <dt>Sets/Gets</dt>
                                    <dd class="text-muted">Count of write and read operations performed.</dd>
                                </dl>
                            </div>
                            <div class="col-md-3">
                                <dl class="mb-0">
                                    <dt>Persistence Type</dt>
                                    <dd class="text-muted">Backend storage: RocksDB, MongoDB, SQLite, PostgreSQL, or Memory.</dd>
                                    <dt>Persistence Mode</dt>
                                    <dd class="text-muted">Sync writes immediately; Async batches writes for performance.</dd>
                                </dl>
                            </div>
                            <div class="col-md-3">
                                <dl class="mb-0">
                                    <dt>Replication</dt>
                                    <dd class="text-muted">Data synchronization mode: Standalone, Leader, or Follower.</dd>
                                    <dt>Server Uptime</dt>
                                    <dd class="text-muted">Time since the server was last started.</dd>
                                </dl>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{layout :: footer}"></footer>
<th:block th:replace="~{layout :: scripts}"></th:block>

<script>
    let allRows = [];
    let filteredRows = [];
    let currentPage = 1;
    let sortCol = -1;
    let sortDir = 'asc';
    
    document.addEventListener('DOMContentLoaded', function() {
        document.querySelectorAll('.data-row').forEach(row => {
            allRows.push({
                element: row.cloneNode(true),
                searchText: row.textContent.toLowerCase(),
                name: (row.dataset.name || '').toLowerCase(),
                entries: parseInt(row.dataset.entries || 0)
            });
        });
        filteredRows = [...allRows];
        updateTable();
    });
    
    function getRowsPerPage() {
        const select = document.getElementById('rowsPerPage');
        return select.value === 'all' ? filteredRows.length || 1 : parseInt(select.value);
    }
    
    function sortTable(col) {
        if (sortCol === col) {
            sortDir = sortDir === 'asc' ? 'desc' : 'asc';
        } else {
            sortCol = col;
            sortDir = 'asc';
        }
        
        if (col === 0) {
            filteredRows.sort((a, b) => sortDir === 'asc' ? a.name.localeCompare(b.name) : b.name.localeCompare(a.name));
        } else if (col === 2) {
            filteredRows.sort((a, b) => sortDir === 'asc' ? a.entries - b.entries : b.entries - a.entries);
        }
        
        document.querySelectorAll('.sort-icon').forEach((icon, idx) => {
            if (idx === col || (idx === 1 && col === 2)) {
                icon.className = sortDir === 'asc' ? 'fas fa-sort-up ms-1 text-primary sort-icon' : 'fas fa-sort-down ms-1 text-primary sort-icon';
            } else {
                icon.className = 'fas fa-sort ms-1 text-muted sort-icon';
            }
        });
        
        currentPage = 1;
        renderTable();
    }
    
    function updateTable() {
        const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
        filteredRows = searchTerm ? allRows.filter(row => row.searchText.includes(searchTerm)) : [...allRows];
        currentPage = 1;
        renderTable();
    }
    
    function renderTable() {
        const tbody = document.getElementById('tableBody');
        const rowsPerPage = getRowsPerPage();
        const totalRows = filteredRows.length;
        const totalPages = Math.ceil(totalRows / rowsPerPage) || 1;
        
        if (currentPage > totalPages) currentPage = totalPages;
        if (currentPage < 1) currentPage = 1;
        
        const start = (currentPage - 1) * rowsPerPage;
        const end = Math.min(start + rowsPerPage, totalRows);
        const pageRows = filteredRows.slice(start, end);
        
        tbody.innerHTML = '';
        if (pageRows.length === 0) {
            tbody.innerHTML = '<tr class="empty-row"><td colspan="6" class="text-center py-5 text-muted"><i class="fas fa-inbox fa-3x mb-3 d-block"></i>No regions found</td></tr>';
        } else {
            pageRows.forEach(row => tbody.appendChild(row.element.cloneNode(true)));
        }
        
        document.getElementById('tableInfo').textContent = totalRows > 0 ? `Showing ${start + 1} to ${end} of ${totalRows}` : '';
        document.getElementById('paginationInfo').textContent = totalPages > 1 ? `Page ${currentPage} of ${totalPages}` : '';
        renderPagination(totalPages);
    }
    
    function renderPagination(totalPages) {
        const pagination = document.getElementById('pagination');
        pagination.innerHTML = '';
        if (totalPages <= 1) return;
        
        const prev = document.createElement('li');
        prev.className = `page-item ${currentPage === 1 ? 'disabled' : ''}`;
        prev.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">&laquo;</a>`;
        pagination.appendChild(prev);
        
        let startPage = Math.max(1, currentPage - 2);
        let endPage = Math.min(totalPages, startPage + 4);
        if (endPage - startPage < 4) startPage = Math.max(1, endPage - 4);
        
        for (let i = startPage; i <= endPage; i++) {
            const li = document.createElement('li');
            li.className = `page-item ${i === currentPage ? 'active' : ''}`;
            li.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>`;
            pagination.appendChild(li);
        }
        
        const next = document.createElement('li');
        next.className = `page-item ${currentPage === totalPages ? 'disabled' : ''}`;
        next.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">&raquo;</a>`;
        pagination.appendChild(next);
    }
    
    function goToPage(page) {
        currentPage = page;
        renderTable();
    }
</script>

</body>
</html>
