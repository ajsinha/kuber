<!DOCTYPE html>
<!--
  ~ Copyright Â© 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  -->
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout :: head('Regions')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div th:replace="~{layout :: alerts}"></div>
    
    <div class="container-fluid py-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="fas fa-layer-group me-2"></i>
                Cache Regions
            </h2>
            <div class="d-flex gap-2">
                <button class="btn btn-outline-secondary btn-sm" onclick="refreshAllStats(this)">
                    <i class="fas fa-sync-alt me-1"></i> Refresh All Stats
                </button>
                <a th:href="@{/regions/create}" class="btn btn-primary" sec:authorize="hasAnyRole('ADMIN', 'OPERATOR')">
                    <i class="fas fa-plus me-1"></i> Create Region
                </a>
            </div>
        </div>
        
        <!-- Regions Table -->
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <div data-kuber-table="regionsTable" data-page-sizes="10,25,50,All" data-default-page-size="25">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th data-sort="string">Region Name</th>
                                <th data-sort="string">Description</th>
                                <th data-sort="number" class="text-end">Total Entries</th>
                                <th data-sort="number" class="text-end">Memory</th>
                                <th data-sort="number" class="text-end">Persistence</th>
                                <th data-sort="number" class="text-end">Hit Ratio</th>
                                <th data-sort="string">Collection</th>
                                <th data-sort="date">Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr th:each="region : ${regions}" class="data-row">
                                <td>
                                    <i th:class="'fas me-1 ' + (${region.default} ? 'fa-star text-warning' : 'fa-folder text-primary')"></i>
                                    <strong><a th:href="@{/regions/{name}(name=${region.name})}" class="text-decoration-none" th:text="${region.name}">Region</a></strong>
                                    <span th:if="${region.captive}" class="badge bg-warning text-dark ms-1" title="System-protected region">Captive</span>
                                </td>
                                <td class="text-muted small" style="max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap" th:title="${region.description}" th:text="${region.description} ?: 'No description'">-</td>
                                <td class="text-end fw-bold" th:text="${#numbers.formatInteger(region.entryCount, 1, 'COMMA')}">0</td>
                                <td class="text-end">
                                    <span class="text-primary" th:text="${#numbers.formatInteger(region.memoryEntryCount, 1, 'COMMA')}">0</span>
                                </td>
                                <td class="text-end">
                                    <span class="text-warning" th:text="${#numbers.formatInteger(region.persistenceEntryCount, 1, 'COMMA')}">0</span>
                                </td>
                                <td class="text-end">
                                    <span th:class="${region.hitRatio > 0.8} ? 'text-success fw-bold' : (${region.hitRatio > 0.5} ? 'text-warning' : 'text-danger')"
                                          th:text="${#numbers.formatPercent(region.hitRatio, 1, 1)}">0%</span>
                                </td>
                                <td><code class="small" th:text="${region.collectionName}">coll</code></td>
                                <td class="small text-muted" th:text="${region.createdAt != null} ? ${#temporals.format(region.createdAt, 'yyyy-MM-dd')} : 'N/A'">-</td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <a th:href="@{/cache(region=${region.name})}" class="btn btn-outline-primary" title="Browse entries">
                                            <i class="fas fa-search"></i>
                                        </a>
                                        <a th:href="@{/regions/{name}(name=${region.name})}" class="btn btn-outline-secondary" title="Details">
                                            <i class="fas fa-info-circle"></i>
                                        </a>
                                        <a th:href="@{/admin/indexes/region/{name}(name=${region.name})}" class="btn btn-outline-info" title="Indexes">
                                            <i class="fas fa-list-alt"></i>
                                        </a>
                                        <a th:href="@{/api/export/region/{name}(name=${region.name})}" class="btn btn-outline-success" title="Export CSV">
                                            <i class="fas fa-download"></i>
                                        </a>
                                        <button type="button" class="btn btn-outline-secondary refresh-stats-btn"
                                                th:attr="data-region=${region.name}" title="Refresh stats">
                                            <i class="fas fa-sync-alt"></i>
                                        </button>
                                        <button sec:authorize="hasAnyRole('ADMIN', 'OPERATOR')" type="button" class="btn btn-outline-warning reload-cache-btn"
                                                th:attr="data-region=${region.name}" title="Reload from persistence">
                                            <i class="fas fa-database"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr class="empty-row" style="display:none">
                                <td colspan="9" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox me-2"></i>No regions found
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Glossary -->
        <div class="card border-0 shadow-sm bg-light mt-4">
            <div class="card-body">
                <h6 class="card-title text-muted mb-3"><i class="fas fa-question-circle me-2"></i>Glossary</h6>
                <div class="row small">
                    <div class="col-md-4">
                        <dl class="mb-0">
                            <dt>Region</dt>
                            <dd class="text-muted">A logical namespace for grouping related cache entries. Provides isolation between different data sets.</dd>
                            <dt>Captive</dt>
                            <dd class="text-muted">A system-protected region that cannot be deleted (e.g., "default" region).</dd>
                        </dl>
                    </div>
                    <div class="col-md-4">
                        <dl class="mb-0">
                            <dt>Total Entries</dt>
                            <dd class="text-muted">Total key-value pairs stored in this region (source of truth from KeyIndex).</dd>
                            <dt>Hit Ratio</dt>
                            <dd class="text-muted">Percentage of cache lookups that found data vs total lookups. Higher is better.</dd>
                        </dl>
                    </div>
                    <div class="col-md-4">
                        <dl class="mb-0">
                            <dt>Memory</dt>
                            <dd class="text-muted">Hot values currently held in fast in-memory cache for quick access.</dd>
                            <dt>Persistence</dt>
                            <dd class="text-muted">Entries stored in the backing store (RocksDB, LMDB, MongoDB, etc.) for durability.</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{layout :: footer}"></footer>
<th:block th:replace="~{layout :: scripts}"></th:block>

<script>
document.addEventListener('DOMContentLoaded', function() {
    document.querySelectorAll('.refresh-stats-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const regionName = this.dataset.region;
            const icon = this.querySelector('i');
            this.disabled = true;
            icon.className = 'fas fa-spinner fa-spin';
            fetch('/api/monitoring/stats/refresh/' + encodeURIComponent(regionName), { method: 'POST' })
                .then(r => r.json())
                .then(d => { if (d.success) location.reload(); else { alert('Failed: ' + (d.error || 'Unknown')); this.disabled = false; icon.className = 'fas fa-sync-alt'; }})
                .catch(e => { alert('Error: ' + e.message); this.disabled = false; icon.className = 'fas fa-sync-alt'; });
        });
    });
    document.querySelectorAll('.reload-cache-btn').forEach(function(btn) {
        btn.addEventListener('click', function() {
            const regionName = this.dataset.region;
            if (!confirm('Evict memory cache for "' + regionName + '" and reload from persistence?')) return;
            const icon = this.querySelector('i');
            this.disabled = true;
            icon.className = 'fas fa-spinner fa-spin';
            fetch('/api/regions/' + encodeURIComponent(regionName) + '/reload', { method: 'POST' })
                .then(r => r.json())
                .then(d => { if (d.entriesLoaded !== undefined) { alert('Reloaded ' + d.entriesLoaded + ' entries'); location.reload(); } else if (d.error) alert('Failed: ' + d.error); this.disabled = false; icon.className = 'fas fa-database'; })
                .catch(e => { alert('Error: ' + e.message); this.disabled = false; icon.className = 'fas fa-database'; });
        });
    });
});
function refreshAllStats(btn) {
    btn.disabled = true; btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Refreshing...';
    fetch('/api/monitoring/stats/refresh', { method: 'POST' })
        .then(r => r.json())
        .then(d => { if (d.success) location.reload(); else { alert('Failed'); btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Refresh All Stats'; }})
        .catch(() => { btn.disabled = false; btn.innerHTML = '<i class="fas fa-sync-alt me-1"></i> Refresh All Stats'; });
}
</script>

</body>
</html>
