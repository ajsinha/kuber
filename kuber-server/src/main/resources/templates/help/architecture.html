<!DOCTYPE html>
<!--
  ~ Copyright © 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  -->
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('Architecture &amp; Internals')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div class="container-fluid py-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/help"><i class="fas fa-book me-1"></i>Help</a></li>
                <li class="breadcrumb-item active" aria-current="page">Architecture &amp; Internals</li>
            </ol>
        </nav>

        <!-- Content -->
        <div class="row">
            <div class="col-lg-10 mx-auto">
                <h1 class="display-5 mb-4"><i class="fas fa-sitemap me-3 text-primary"></i>System Architecture</h1>
                
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Version 2.6.4</strong> - This document describes the architecture of <span th:text="${appName} ?: 'Kuber'">Kuber</span> Distributed Cache, 
                    an enterprise-grade caching system with Redis protocol compatibility and advanced features.
                </div>

                <!-- Table of Contents -->
                <div class="card mb-5">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Table of Contents</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <ol>
                                    <li><a href="#overview">Overview &amp; Key Principles</a></li>
                                    <li><a href="#high-level">High-Level Architecture</a></li>
                                    <li><a href="#startup-orchestration">Startup Orchestration</a></li>
                                    <li><a href="#hybrid-memory">Hybrid Memory Architecture</a></li>
                                    <li><a href="#core-components">Core Components</a></li>
                                    <li><a href="#persistence">Persistence Layer</a></li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <ol start="7">
                                    <li><a href="#protocol">Protocol Design</a></li>
                                    <li><a href="#replication">Replication Architecture</a></li>
                                    <li><a href="#event-publishing">Event Publishing</a> <span class="badge bg-warning text-dark">v2.6.4</span></li>
                                    <li><a href="#request-response">Request/Response Messaging</a> <span class="badge bg-success">v1.7.1</span></li>
                                    <li><a href="#prometheus">Prometheus Monitoring</a> <span class="badge bg-info">v2.2.0</span></li>
                                    <li><a href="#security">Security Architecture</a></li>
                                    <li><a href="#data-flow">Data Flow</a></li>
                                    <li><a href="#deployment">Deployment Patterns</a></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 1. Overview -->
                <section id="overview" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-eye me-2 text-primary"></i>1. Overview</h2>
                    <p><span th:text="${appName} ?: 'Kuber'">Kuber</span> is an enterprise-grade distributed caching system designed for high-performance, 
                    scalability, and flexibility. It provides Redis protocol compatibility while extending functionality with advanced features 
                    like region-based partitioning, JSON document queries, and pluggable persistence.</p>
                    
                    <h4 class="mt-4">Key Architectural Principles</h4>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr><th>Principle</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>Protocol Compatibility</strong></td><td>Full Redis RESP protocol support for drop-in replacement</td></tr>
                            <tr><td><strong>Hybrid Memory</strong></td><td>All keys in memory (KeyIndex), values can overflow to disk (v1.2.1+)</td></tr>
                            <tr><td><strong>Pluggable Persistence</strong></td><td>Configurable backends: RocksDB, LMDB, MongoDB, PostgreSQL, SQLite, Memory</td></tr>
                            <tr><td><strong>Region Isolation</strong></td><td>Logical namespaces for multi-tenant data organization</td></tr>
                            <tr><td><strong>High Availability</strong></td><td>Primary/Secondary replication via ZooKeeper</td></tr>
                            <tr><td><strong>Mandatory Security</strong></td><td>All clients must authenticate with username and password</td></tr>
                            <tr><td><strong>Off-Heap Keys</strong></td><td>Optional DRAM-based key storage outside Java heap (v1.2.2+)</td></tr>
                        </tbody>
                    </table>
                </section>

                <!-- 2. High-Level Architecture -->
                <section id="high-level" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-layer-group me-2 text-success"></i>2. High-Level Architecture</h2>
                    <pre class="bg-dark text-light p-4 rounded" style="font-size: 0.75rem; overflow-x: auto;">
┌─────────────────────────────────────────────────────────────────────────────┐
│                              CLIENT LAYER                                    │
├──────────────────┬──────────────────┬────────────────────┬──────────────────┤
│  Python Client   │  Java Client     │   C# / .NET Client │  Messaging       │
│  (Redis + REST)  │  (Redis + REST)  │   (Redis + REST)   │  (Kafka/MQ)      │
│ (Auth Required)  │ (Auth Required)  │  (Auth Required)   │  (API Key)       │
└────────┬─────────┴────────┬─────────┴─────────┬──────────┴────────┬─────────┘
         │                  │                   │                    │
         │ Redis/HTTP       │ Redis/HTTP        │ Redis/HTTP         │ Broker
         ▼                  ▼                   ▼                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                           PROTOCOL LAYER                                     │
├─────────────────────────────────┬──────────────────────┬────────────────────┤
│       Redis Protocol Server     │  REST API Server     │  Message Broker    │
│       (Apache MINA - Port 6380) │  (Spring Boot 8080)  │  Adapter (v1.7.1)  │
└─────────────────┬───────────────┴──────────┬───────────┴──────────┬─────────┘
                  │                                   │
                  ▼                                   ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                            SERVICE LAYER                                     │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  ┌─────────────────────┐ │
│  │   Cache     │  │   Region    │  │    JSON     │  │   Authentication    │ │
│  │  Service    │  │   Manager   │  │   Service   │  │      Service        │ │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘  └──────────┬──────────┘ │
│         │                │                │                     │           │
│         └────────────────┴────────┬───────┴─────────────────────┘           │
│                                   ▼                                          │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │               Hybrid Memory Architecture (v1.2.1+)                    │   │
│  │  ┌──────────────────┐    ┌─────────────────────────────────────┐    │   │
│  │  │  KeyIndex        │    │     Value Cache (Caffeine)          │    │   │
│  │  │  (All keys in    │◄──►│     (Hot values in memory)          │    │   │
│  │  │   memory always) │    │                                     │    │   │
│  │  └──────────────────┘    └─────────────────────────────────────┘    │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
└───────────────────────────────────┬─────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                         PERSISTENCE LAYER                                    │
├─────────────────────────────────────────────────────────────────────────────┤
│  ┌────────┐ ┌──────┐ ┌────────┐ ┌──────────┐ ┌────────┐ ┌────────┐         │
│  │RocksDB │ │ LMDB │ │ SQLite │ │PostgreSQL│ │MongoDB │ │In-Memory│         │
│  │(default)│ │      │ │        │ │          │ │        │ │        │         │
│  └────────┘ └──────┘ └────────┘ └──────────┘ └────────┘ └────────┘         │
└─────────────────────────────────────────────────────────────────────────────┘
                                    │
                                    ▼
┌─────────────────────────────────────────────────────────────────────────────┐
│                       REPLICATION LAYER (Optional)                           │
├─────────────────────────────────────────────────────────────────────────────┤
│         ┌─────────┐         ┌─────────┐         ┌─────────┐                 │
│         │ Primary │ ──────► │Secondary│ ──────► │Secondary│                 │
│         │  Node   │         │  Node 1 │         │  Node 2 │                 │
│         └────┬────┘         └─────────┘         └─────────┘                 │
│              │                                                               │
│              └──────────────► ZooKeeper Coordination ◄──────────────────────│
└─────────────────────────────────────────────────────────────────────────────┘</pre>
                </section>

                <!-- 3. Startup Orchestration -->
                <section id="startup-orchestration" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-play-circle me-2 text-success"></i>3. Startup Orchestration</h2>
                    <p>Kuber uses a <code>StartupOrchestrator</code> to ensure correct initialization order and prevent race conditions 
                    during application startup. This is critical for data integrity and system stability.</p>
                    
                    <h4 class="mt-4">The Problem</h4>
                    <p>Without proper orchestration, several race conditions can occur:</p>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr><th>Race Condition</th><th>Description</th><th>Impact</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>Early Data Recovery</strong></td><td>Persistence recovery starts before Spring context is fully loaded</td><td>Missing bean dependencies</td></tr>
                            <tr><td><strong>Premature Connections</strong></td><td>Redis server accepts connections before cache is ready</td><td>Clients receive errors</td></tr>
                            <tr><td><strong>Autoload Race</strong></td><td>Files processed before persistence recovery completes</td><td>Data overwrites</td></tr>
                            <tr><td><strong>Scheduled Conflicts</strong></td><td>@Scheduled methods run before initialization</td><td>Operations on uninitialized caches</td></tr>
                        </tbody>
                    </table>
                    
                    <h4 class="mt-4">Startup Sequence (v1.5.0)</h4>
                    <div class="alert alert-info mb-3">
                        <i class="fas fa-bolt me-2"></i>
                        <strong>v1.5.0:</strong> All startup operations (compaction, loading) run sequentially for data consistency.
                        This ensures no concurrent operations that could cause corruption.
                    </div>
                    <pre class="bg-dark text-white p-3 rounded">
┌─────────────────────────────────────────────────────────────────────────────┐
│                         STARTUP SEQUENCE (v1.5.0)                            │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ PHASE 0: Spring Boot Initialization                                  │   │
│  │ • Spring context loads all beans                                     │   │
│  │ • Dependency injection completes                                     │   │
│  │ • ApplicationReadyEvent fires                                        │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ STABILIZATION: Wait 10 seconds                                       │   │
│  │ • Allows all Spring beans to fully initialize                        │   │
│  │ • Ensures async initializations complete                             │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼                                         │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ PHASE 1: Persistence Maintenance (CONCURRENT)                        │   │
│  │ • RocksDB: Full compaction of all region databases (parallel)        │   │
│  │ • SQLite: VACUUM on all region database files (parallel)             │   │
│  │ • LMDB/Other: Skip (not required)                                    │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼ (2 second wait)                         │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ PHASE 2: Cache Service Initialization (CONCURRENT)                   │   │
│  │ • Load regions from persistence store (parallel per region)          │   │
│  │ • Recover all cached data from disk/database                         │   │
│  │ • Build KeyIndex for each region (all keys in memory)                │   │
│  │ • Mark CacheService as initialized                                   │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼ (2 second wait)                         │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ PHASE 3: Redis Protocol Server                                       │   │
│  │ • Bind to configured port (default: 6380)                            │   │
│  │ • Start accepting client connections                                 │   │
│  │ • Clients can now safely connect with full data available            │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼ (2 second wait)                         │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ PHASE 4: Autoload Service                                            │   │
│  │ • Initialize inbox/outbox directories                                │   │
│  │ • Start file watcher for new data files                              │   │
│  │ • Process any pending files in inbox                                 │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                    │                                         │
│                                    ▼ (2 second wait)                         │
│  ┌──────────────────────────────────────────────────────────────────────┐   │
│  │ SYSTEM READY: Final Announcement                                     │   │
│  │ • Mark startup as complete                                           │   │
│  │ • Log system ready message                                           │   │
│  └──────────────────────────────────────────────────────────────────────┘   │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘</pre>
                    
                    <h4 class="mt-4">Scheduled Task Protection</h4>
                    <p>All <code>@Scheduled</code> methods check for cache initialization before executing:</p>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr><th>Service</th><th>Method</th><th>Protection</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>CacheService</td><td>cleanupExpiredEntries()</td><td><code>initialized.get()</code></td></tr>
                            <tr><td>MemoryWatcherService</td><td>checkMemoryUsage()</td><td><code>cacheService.isInitialized()</code></td></tr>
                            <tr><td>PersistenceExpirationService</td><td>cleanupExpiredEntries()</td><td><code>cacheService.isInitialized()</code></td></tr>
                            <tr><td>RocksDbCompactionService</td><td>scheduledCompaction()</td><td><code>enabled.get()</code></td></tr>
                        </tbody>
                    </table>
                    
                    <h4 class="mt-4">Startup Logging</h4>
                    <p>The orchestrator provides clear visual logging of each phase:</p>
                    <pre class="bg-dark text-white p-3 rounded" style="font-size: 0.85rem;">
╔════════════════════════════════════════════════════════════════════╗
║  Spring context ready - starting initialization sequence...        ║
╚════════════════════════════════════════════════════════════════════╝
Waiting 10 seconds for Spring context stabilization...

╔════════════════════════════════════════════════════════════════════╗
║  Phase 1: Persistence Maintenance                                  ║
║           Running database compaction/vacuum...                    ║
╚════════════════════════════════════════════════════════════════════╝
Persistence maintenance completed successfully in 523 ms

╔════════════════════════════════════════════════════════════════════╗
║  Phase 2: Cache Service Initialization                             ║
║           Recovering data from persistence store...                ║
╚════════════════════════════════════════════════════════════════════╝
Cache service initialization completed in 1234 ms

╔════════════════════════════════════════════════════════════════════╗
║  Phase 3: Redis Protocol Server                                    ║
║           Starting server to accept client connections...          ║
╚════════════════════════════════════════════════════════════════════╝

╔════════════════════════════════════════════════════════════════════╗
║  Phase 4: Autoload Service                                         ║
║           Starting file monitoring and processing...               ║
╚════════════════════════════════════════════════════════════════════╝

╔════════════════════════════════════════════════════════════════════╗
║   SYSTEM READY - Version 2.6.4                                     ║
║   ✓ Persistence maintenance: complete                              ║
║   ✓ Cache service: initialized                                     ║
║   ✓ Redis server: accepting connections                            ║
║   ✓ Autoload service: running                                      ║
╚════════════════════════════════════════════════════════════════════╝</pre>
                </section>

                <!-- 4. Hybrid Memory Architecture -->
                <section id="hybrid-memory" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-memory me-2 text-info"></i>4. Hybrid Memory Architecture</h2>
                    <p>Introduced in v1.2.1, the hybrid memory architecture ensures <strong>all keys are always in memory</strong> 
                    while values can overflow to disk. This provides O(1) key existence checks without disk I/O.</p>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">KeyIndex (Per Region)</div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>Stores ALL key metadata in memory</li>
                                        <li>Tracks: key, TTL, value location, access stats</li>
                                        <li>EXISTS: O(1) pure memory lookup</li>
                                        <li>KEYS: O(n) memory scan, never disk</li>
                                        <li>DBSIZE: O(1) instant count</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">Value Cache (Caffeine)</div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>Stores HOT values in memory</li>
                                        <li>LRU eviction when capacity reached</li>
                                        <li>Evicted values still on disk</li>
                                        <li>Cache miss loads from persistence</li>
                                        <li>Write-through to persistence</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-4">
                        <h5><i class="fas fa-microchip me-2"></i>Off-Heap Key Index - Segmented Buffers (v1.3.2)</h5>
                        <p>Store keys in direct memory (DRAM) outside Java heap for zero GC pressure.</p>
                        <div class="row mt-3">
                            <div class="col-md-6">
                                <strong>Architecture:</strong>
                                <ul class="mb-0">
                                    <li>Multiple 1GB ByteBuffer segments</li>
                                    <li>Supports >2GB total per region</li>
                                    <li>Auto-growth as data increases</li>
                                    <li>Automatic compaction when fragmented</li>
                                </ul>
                            </div>
                            <div class="col-md-6">
                                <strong>Configuration:</strong>
                                <pre class="bg-dark text-light p-2 rounded small mb-0">kuber.cache.off-heap-key-index=true
kuber.cache.off-heap-key-index-initial-size-mb=16
kuber.cache.off-heap-key-index-max-size-mb=8192</pre>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="mt-4">Off-Heap Memory Layout</h4>
                    <p>Each key entry uses a compact binary format in off-heap memory:</p>
                    <table class="table table-bordered table-sm">
                        <thead class="table-light">
                            <tr><th>Bytes</th><th>Field</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>2</td><td>keyLength</td><td>Length of key in bytes (short)</td></tr>
                            <tr><td>variable</td><td>keyBytes</td><td>UTF-8 encoded key string</td></tr>
                            <tr><td>8</td><td>expiresAt</td><td>Expiration timestamp (long, -1 = never)</td></tr>
                            <tr><td>1</td><td>location</td><td>Value location (0=MEMORY, 1=DISK, 2=BOTH)</td></tr>
                            <tr><td>4</td><td>valueSize</td><td>Size of value in bytes (int)</td></tr>
                            <tr><td>8</td><td>lastAccess</td><td>Last access timestamp (long)</td></tr>
                            <tr><td>4</td><td>accessCount</td><td>Number of accesses (int)</td></tr>
                        </tbody>
                    </table>
                    
                    <h4 class="mt-4">Performance Comparison</h4>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr><th>Operation</th><th>Before v1.2.1</th><th>After v1.2.1</th><th>Improvement</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>EXISTS</td><td>May hit disk</td><td>Pure memory O(1)</td><td>10-100x faster</td></tr>
                            <tr><td>KEYS pattern</td><td>May hit disk</td><td>Pure memory scan</td><td>10-100x faster</td></tr>
                            <tr><td>DBSIZE</td><td>Count iteration</td><td>O(1) from index</td><td>Instant</td></tr>
                            <tr><td>Negative lookup</td><td>Disk check</td><td>Memory check</td><td>No disk I/O</td></tr>
                        </tbody>
                    </table>
                </section>

                <!-- 4. Core Components -->
                <section id="core-components" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-cubes me-2 text-warning"></i>5. Core Components</h2>
                    
                    <h4>4.1 Cache Service</h4>
                    <p>The central component managing all cache operations including regions, TTL, and persistence coordination.</p>
                    
                    <h4 class="mt-4">4.2 Region Manager</h4>
                    <p>Regions provide logical isolation for cache entries:</p>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr><th>Feature</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>Auto-Creation</strong></td><td>Regions are automatically created when data is stored to a non-existent region</td></tr>
                            <tr><td><strong>Namespace Isolation</strong></td><td>Keys are scoped within regions</td></tr>
                            <tr><td><strong>Independent TTL</strong></td><td>Each region can have default TTL settings</td></tr>
                            <tr><td><strong>Separate Statistics</strong></td><td>Per-region hit/miss tracking</td></tr>
                            <tr><td><strong>Attribute Mapping</strong></td><td>JSON attribute transformation on storage</td></tr>
                            <tr><td><strong>Region Isolation</strong></td><td>Each region has dedicated database instance (RocksDB/LMDB/SQLite)</td></tr>
                        </tbody>
                    </table>
                    
                    <h4 class="mt-4">4.3 JSON Service</h4>
                    <p>Native JSON document support with JSONPath queries:</p>
                    <ul>
                        <li><strong>Equality:</strong> <code>$.name=Alice</code></li>
                        <li><strong>Comparison:</strong> <code>$.age&gt;25</code>, <code>$.age&lt;=35</code></li>
                        <li><strong>Pattern:</strong> <code>$.name LIKE %Ali%</code></li>
                        <li><strong>Contains:</strong> <code>$.roles CONTAINS admin</code></li>
                        <li><strong>Nested:</strong> <code>$.address.city=New York</code></li>
                    </ul>
                </section>

                <!-- 5. Persistence Layer -->
                <section id="persistence" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-database me-2 text-danger"></i>6. Persistence Layer</h2>
                    
                    <h4>Backend Comparison</h4>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr><th>Backend</th><th>Use Case</th><th>Pros</th><th>Cons</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>RocksDB</strong></td><td>High-performance (Default)</td><td>Embedded, LSM-tree, per-region isolation</td><td>Complex tuning</td></tr>
                            <tr><td><strong>LMDB</strong></td><td>Zero-copy reads</td><td>ACID, crash-safe, memory-mapped</td><td>Write-heavy workloads</td></tr>
                            <tr><td><strong>MongoDB</strong></td><td>Production clusters</td><td>Distributed, scalable</td><td>Requires separate server</td></tr>
                            <tr><td><strong>PostgreSQL</strong></td><td>Enterprise</td><td>ACID, mature tooling</td><td>Requires separate server</td></tr>
                            <tr><td><strong>SQLite</strong></td><td>Development/Single-node</td><td>Zero config, file-based</td><td>Single-writer, limited scale</td></tr>
                            <tr><td><strong>InMemory</strong></td><td>Testing/Dev</td><td>Fastest, no I/O</td><td>No persistence</td></tr>
                        </tbody>
                    </table>
                    
                    <div class="alert alert-info mt-3">
                        <i class="fas fa-info-circle me-2"></i>
                        <strong>Region Isolation:</strong> RocksDB, LMDB, and SQLite use separate database instances per region 
                        for better concurrency, isolation, and independent compaction.
                    </div>
                </section>

                <!-- 6. Protocol Design -->
                <section id="protocol" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-code me-2 text-secondary"></i>7. Protocol Design</h2>
                    
                    <h4>7.1 Redis RESP Protocol</h4>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr><th>Type</th><th>Prefix</th><th>Example</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Simple String</td><td><code>+</code></td><td><code>+OK\r\n</code></td></tr>
                            <tr><td>Error</td><td><code>-</code></td><td><code>-ERR unknown command\r\n</code></td></tr>
                            <tr><td>Integer</td><td><code>:</code></td><td><code>:1000\r\n</code></td></tr>
                            <tr><td>Bulk String</td><td><code>$</code></td><td><code>$5\r\nhello\r\n</code></td></tr>
                            <tr><td>Array</td><td><code>*</code></td><td><code>*2\r\n$3\r\nGET\r\n$3\r\nkey\r\n</code></td></tr>
                            <tr><td>Null</td><td><code>$-1</code></td><td><code>$-1\r\n</code></td></tr>
                        </tbody>
                    </table>
                    
                    <h4 class="mt-4">7.2 Kuber Protocol Extensions</h4>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr><th>Command</th><th>Description</th><th>Example</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><code>RSELECT region</code></td><td>Select region</td><td><code>RSELECT users</code></td></tr>
                            <tr><td><code>RCREATE name desc</code></td><td>Create region</td><td><code>RCREATE orders "Order data"</code></td></tr>
                            <tr><td><code>REGIONS</code></td><td>List regions</td><td><code>REGIONS</code></td></tr>
                            <tr><td><code>JSET key json</code></td><td>Set JSON</td><td><code>JSET user:1 {"name":"Alice"}</code></td></tr>
                            <tr><td><code>JGET key [path]</code></td><td>Get JSON</td><td><code>JGET user:1 $.name</code></td></tr>
                            <tr><td><code>JUPDATE key json [ttl]</code></td><td>Merge JSON (upsert)</td><td><code>JUPDATE user:1 {"age":31}</code></td></tr>
                            <tr><td><code>JREMOVE key ["attr",...]</code></td><td>Remove JSON attributes</td><td><code>JREMOVE user:1 ["temp"]</code></td></tr>
                            <tr><td><code>JSEARCH query</code></td><td>Search JSON</td><td><code>JSEARCH $.age&gt;30</code></td></tr>
                            <tr><td><code>STATUS</code></td><td>Server status</td><td><code>STATUS</code></td></tr>
                        </tbody>
                    </table>
                </section>

                <!-- 7. Replication Architecture -->
                <section id="replication" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-sync me-2 text-info"></i>8. Replication Architecture</h2>
                    <p>Primary/Secondary replication with ZooKeeper coordination for high availability:</p>
                    <ul>
                        <li><strong>Primary Node:</strong> Handles all write operations</li>
                        <li><strong>Secondary Nodes:</strong> Read-only replicas for scale-out reads</li>
                        <li><strong>ZooKeeper:</strong> Leader election, configuration management, health monitoring</li>
                        <li><strong>Automatic Failover:</strong> Secondary promoted to Primary on failure</li>
                    </ul>
                    
                    <pre class="bg-dark text-light p-3 rounded" style="font-size: 0.8rem;">
┌─────────────────────────────────────────────────────────────────┐
│                    Load Balancer                                 │
│              (HAProxy / AWS ALB / etc.)                          │
└───────────────────────┬─────────────────────────────────────────┘
                        │
        ┌───────────────┼───────────────┐
        ▼               ▼               ▼
┌───────────┐   ┌───────────┐   ┌───────────┐
│  Primary  │   │Secondary 1│   │Secondary 2│
│   (R/W)   │   │  (R only) │   │  (R only) │
└─────┬─────┘   └─────┬─────┘   └─────┬─────┘
      │               │               │
      └───────────────┼───────────────┘
                      ▼
        ┌─────────────────────────┐
        │   ZooKeeper Cluster     │
        └─────────────────────────┘</pre>
                </section>

                <!-- 9. Event Publishing -->
                <section id="event-publishing" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-broadcast-tower me-2 text-warning"></i>9. Event Publishing <span class="badge bg-warning text-dark">v2.6.4</span></h2>
                    <p>Kuber can stream cache events to external messaging systems for real-time integrations, analytics, and event-driven architectures.</p>
                    
                    <h4 class="mt-4">Publishing Architecture</h4>
                    <pre class="bg-dark text-light p-3 rounded" style="font-size: 0.8rem;">
CacheService.set() / delete()     AutoloadService.processFile()
         │                                 │
         │ Submit to async queue           │ autoload_start / autoload_end
         │ (non-blocking)                  │
         ▼                                 ▼
┌──────────────────────────────────────────────┐
│  RegionEventPublishingService                │
│  └── Publishing Thread Pool (default: 4)     │
└────────────────────┬─────────────────────────┘
                     │
                     ▼
              PublisherRegistry
                     │
            ┌────┬───┴───┬────┬────┐
            ▼    ▼       ▼    ▼    ▼
         Kafka  AMQ  RabbitMQ IBM  File
                              MQ</pre>
                    
                    <h4 class="mt-4">Supported Publishers</h4>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr><th>Publisher</th><th>Type</th><th>Features</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>Apache Kafka</strong></td><td>kafka</td><td>High throughput, auto topic creation, producer pooling</td></tr>
                            <tr><td><strong>RabbitMQ</strong></td><td>rabbitmq</td><td>AMQP messaging, exchange routing, channel pooling</td></tr>
                            <tr><td><strong>IBM MQ</strong></td><td>ibmmq</td><td>Enterprise messaging, SSL/TLS, queue manager integration</td></tr>
                            <tr><td><strong>Apache ActiveMQ</strong></td><td>activemq</td><td>JMS messaging, connection pooling, queue/topic support</td></tr>
                            <tr><td><strong>File System</strong></td><td>file</td><td>JSON Lines format, date/size rotation, network share support</td></tr>
                        </tbody>
                    </table>
                    
                    <h4 class="mt-4">Configuration Model (v1.3.2)</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-info text-white">Centralized Brokers</div>
                                <div class="card-body">
                                    <pre class="bg-light p-2 rounded mb-0"><code>kuber.publishing.brokers:
  prod-kafka:
    type: kafka
    kafka:
      bootstrapServers: kafka1:9092
  
  backup-file:
    type: file
    file:
      directory: ./events</code></pre>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">Region Destinations</div>
                                <div class="card-body">
                                    <pre class="bg-light p-2 rounded mb-0"><code>kuber.publishing.regions:
  customers:
    destinations:
      - broker: prod-kafka
        topic: customer-events
      - broker: backup-file
        prefix: customers</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-4">
                        <strong><i class="fas fa-info-circle me-2"></i>Full Documentation:</strong> 
                        See <a href="/help/publishing" class="alert-link">Event Publishing Guide</a> for complete configuration options, 
                        message formats, and examples.
                    </div>
                </section>

                <!-- 10. Request/Response Messaging -->
                <section id="request-response" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-exchange-alt me-2 text-info"></i>10. Request/Response Messaging <span class="badge bg-success">v1.7.1</span></h2>
                    <p>Kuber can accept cache operation requests via message brokers, enabling asynchronous cache access for event-driven architectures.</p>
                    
                    <h4 class="mt-4">Request/Response Architecture</h4>
                    <pre class="bg-dark text-light p-3 rounded" style="font-size: 0.8rem;">
External Applications
         │
         │ JSON Request (api_key, message_id, operation, ...)
         ▼
┌─────────────────────────────────────────────────────────────┐
│               Message Broker (Kafka/AMQ/RabbitMQ/IBM MQ)    │
│                      Request Topics                          │
│    ccs_cache_request    order_cache_request    ...          │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
┌─────────────────────────────────────────────────────────────┐
│              RequestResponseService                          │
│  ┌─────────────────┐  ┌───────────────────────────────────┐ │
│  │ Broker Adapters │  │  Request Processing Thread Pool   │ │
│  │ • Kafka         │  │  (configurable, default: 10)      │ │
│  │ • ActiveMQ      │  └───────────────────────────────────┘ │
│  │ • RabbitMQ      │  ┌───────────────────────────────────┐ │
│  │ • IBM MQ        │  │  Blocking Queue (max: 100)        │ │
│  └─────────────────┘  │  Backpressure: pause at 80%       │ │
│                       └───────────────────────────────────┘ │
└────────────────────────────┬────────────────────────────────┘
                             │
                             ▼
                        CacheService
                             │
                             ▼ JSON Response
┌─────────────────────────────────────────────────────────────┐
│               Message Broker Response Topics                 │
│    ccs_cache_response   order_cache_response   ...          │
└─────────────────────────────────────────────────────────────┘</pre>
                    
                    <h4 class="mt-4">Key Features</h4>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr><th>Feature</th><th>Description</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>Multi-Broker</strong></td><td>Connect to multiple brokers simultaneously (Kafka, Confluent Kafka, ActiveMQ, RabbitMQ, IBM MQ)</td></tr>
                            <tr><td><strong>Hot Reload</strong></td><td>Configuration changes detected automatically, broker connections update without restart</td></tr>
                            <tr><td><strong>Backpressure</strong></td><td>Automatic pause/resume when queue exceeds thresholds (80%/50%)</td></tr>
                            <tr><td><strong>API Key Auth</strong></td><td>All requests must include valid API key for authentication</td></tr>
                            <tr><td><strong>Full Operations</strong></td><td>All cache operations supported: GET, SET, DELETE, MGET, MSET, JSON ops, etc.</td></tr>
                            <tr><td><strong>Admin UI</strong></td><td>Web interface for broker management and queue monitoring</td></tr>
                            <tr><td><strong>Test Clients <span class="badge bg-success">v2.2.0</span></strong></td><td>Python, Java, C# test clients for all 4 broker types</td></tr>
                        </tbody>
                    </table>
                    
                    <h4 class="mt-4">Test Clients <span class="badge bg-success">v2.2.0</span></h4>
                    <p>Ready-to-use test clients demonstrate request/response messaging for all brokers:</p>
                    <div class="table-responsive">
                        <table class="table table-bordered table-sm">
                            <thead class="table-light">
                                <tr><th>Broker</th><th>Python</th><th>Java</th><th>C#</th></tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><strong>Kafka</strong></td>
                                    <td><code>kafka_request_response_test.py</code></td>
                                    <td><code>KafkaRequestResponseTest.java</code></td>
                                    <td><code>KafkaRequestResponseTest.cs</code></td>
                                </tr>
                                <tr>
                                    <td><strong>ActiveMQ</strong></td>
                                    <td><code>activemq_request_response_test.py</code></td>
                                    <td><code>ActiveMqRequestResponseTest.java</code></td>
                                    <td><code>ActiveMqRequestResponseTest.cs</code></td>
                                </tr>
                                <tr>
                                    <td><strong>RabbitMQ</strong></td>
                                    <td><code>rabbitmq_request_response_test.py</code></td>
                                    <td><code>RabbitMqRequestResponseTest.java</code></td>
                                    <td><code>RabbitMqRequestResponseTest.cs</code></td>
                                </tr>
                                <tr>
                                    <td><strong>IBM MQ</strong></td>
                                    <td><code>ibmmq_request_response_test.py</code></td>
                                    <td><code>IbmMqRequestResponseTest.java</code></td>
                                    <td><code>IbmMqRequestResponseTest.cs</code></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    
                    <h4 class="mt-4">Request/Response Flow</h4>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">Request Format</div>
                                <div class="card-body">
                                    <pre class="bg-light p-2 rounded mb-0"><code>{
  "api_key": "kub_abc123...",
  "message_id": "req-12345",
  "operation": "GET",
  "region": "users",
  "key": "user:1001"
}</code></pre>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">Response Format</div>
                                <div class="card-body">
                                    <pre class="bg-light p-2 rounded mb-0"><code>{
  "request_receive_timestamp": "...",
  "response_time": "...",
  "processing_time_ms": 2,
  "request": { ... },
  "response": {
    "success": true,
    "result": {...}
  }
}</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-4">
                        <strong><i class="fas fa-info-circle me-2"></i>Full Documentation:</strong> 
                        See <a href="/help/messaging" class="alert-link">Request/Response Messaging Guide</a> for complete configuration, 
                        supported operations, and examples.
                    </div>
                </section>

                <!-- Prometheus Monitoring (v2.1.0) -->
                <section id="prometheus" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-chart-line me-2 text-warning"></i>Prometheus Monitoring <span class="badge bg-info">v2.2.0</span></h2>
                    <p>Kuber integrates with Prometheus for comprehensive metrics monitoring and alerting via Spring Actuator and Micrometer.</p>
                    
                    <h4 class="mt-4">Architecture Overview</h4>
                    <pre class="bg-dark text-light p-3 rounded" style="font-size: 0.75rem;">
┌─────────────────────────────────────────────────────────────────────────────┐
│                            MONITORING STACK                                  │
├─────────────────────────────────────────────────────────────────────────────┤
│                                                                              │
│  ┌─────────────┐     ┌─────────────┐     ┌─────────────┐     ┌───────────┐ │
│  │   Grafana   │◄────│  Prometheus │◄────│    Kuber    │◄────│  Clients  │ │
│  │  Dashboard  │     │   Server    │     │   Server    │     │           │ │
│  │  (port 3000)│     │  (port 9090)│     │  (port 8080)│     │           │ │
│  └─────────────┘     └──────┬──────┘     └──────┬──────┘     └───────────┘ │
│                             │                    │                          │
│                             │ scrape /actuator/  │                          │
│                             │    prometheus      │                          │
│                             │◄───────────────────│                          │
│                                                                              │
└─────────────────────────────────────────────────────────────────────────────┘</pre>

                    <h4 class="mt-4">Exposed Metrics</h4>
                    <div class="row">
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">Cache Operations</div>
                                <div class="card-body">
                                    <ul class="small mb-0">
                                        <li><code>kuber_cache_gets_total</code></li>
                                        <li><code>kuber_cache_sets_total</code></li>
                                        <li><code>kuber_cache_deletes_total</code></li>
                                        <li><code>kuber_cache_hits_total</code></li>
                                        <li><code>kuber_cache_misses_total</code></li>
                                        <li><code>kuber_cache_hit_rate</code></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">Memory Usage</div>
                                <div class="card-body">
                                    <ul class="small mb-0">
                                        <li><code>kuber_heap_used_bytes</code></li>
                                        <li><code>kuber_heap_max_bytes</code></li>
                                        <li><code>kuber_heap_usage_ratio</code></li>
                                        <li><code>kuber_value_cache_size</code></li>
                                        <li><code>kuber_value_cache_limit</code></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card h-100">
                                <div class="card-header bg-warning">Per-Region Metrics</div>
                                <div class="card-body">
                                    <ul class="small mb-0">
                                        <li><code>kuber_total_keys</code></li>
                                        <li><code>kuber_regions_count</code></li>
                                        <li><code>kuber_region_keys{region}</code></li>
                                        <li><code>kuber_region_memory_bytes{region}</code></li>
                                        <li><code>kuber_server_info</code></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>

                    <h4 class="mt-4">Configuration</h4>
                    <pre class="bg-dark text-light p-3 rounded"><code># Enable Prometheus endpoint
kuber.prometheus.enabled=true
kuber.prometheus.update-interval-ms=5000

# Actuator endpoints
management.endpoints.web.exposure.include=health,info,metrics,prometheus
management.metrics.tags.application=kuber</code></pre>

                    <div class="alert alert-info mt-4">
                        <strong><i class="fas fa-info-circle me-2"></i>Full Documentation:</strong> 
                        See <a href="/help/prometheus" class="alert-link">Prometheus Integration Guide</a> for complete setup, 
                        Grafana dashboards, and alerting rules.
                    </div>
                </section>

                <!-- 12. Security Architecture -->
                <section id="security" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-shield-alt me-2 text-success"></i>12. Security Architecture</h2>
                    <p><strong>All access requires authentication.</strong> Kuber supports multiple authentication methods for different use cases.</p>
                    
                    <h4 class="mt-4">Authentication Methods</h4>
                    <table class="table table-bordered">
                        <thead class="table-light">
                            <tr><th>Method</th><th>Use Case</th><th>Protocol</th></tr>
                        </thead>
                        <tbody>
                            <tr><td><strong>Username/Password</strong></td><td>Web UI, interactive use</td><td>Form login, HTTP Basic</td></tr>
                            <tr><td><strong>API Key</strong></td><td>Programmatic access, CI/CD, services</td><td>Header, query param</td></tr>
                            <tr><td><strong>Redis AUTH</strong></td><td>Redis protocol clients</td><td>AUTH command</td></tr>
                        </tbody>
                    </table>
                    
                    <h4 class="mt-4">API Key Authentication (v1.2.5)</h4>
                    <p>API keys provide secure, revocable access for applications and services.</p>
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-primary text-white">REST API</div>
                                <div class="card-body">
                                    <pre class="bg-light p-2 rounded mb-0"><code># X-API-Key header
curl -H "X-API-Key: kub_xxx..." /api/cache/key

# Authorization header
curl -H "Authorization: ApiKey kub_xxx..." /api/cache/key

# Query parameter
curl "/api/cache/key?api_key=kub_xxx..."</code></pre>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-success text-white">Redis Protocol</div>
                                <div class="card-body">
                                    <pre class="bg-light p-2 rounded mb-0"><code># API Key authentication
AUTH APIKEY kub_xxx...

# Direct API key
AUTH kub_xxx...

# Traditional password
AUTH password</code></pre>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 class="mt-4">API Key Features</h4>
                    <ul>
                        <li><strong>Secure Generation</strong>: 64-character cryptographically random keys</li>
                        <li><strong>Role-Based</strong>: Keys inherit roles (USER, OPERATOR, ADMIN)</li>
                        <li><strong>Expiration</strong>: Optional expiration dates for temporary access</li>
                        <li><strong>Revocation</strong>: Instantly disable compromised keys</li>
                        <li><strong>Audit</strong>: Track last-used timestamps</li>
                    </ul>
                    
                    <h4 class="mt-4"><i class="fas fa-user-shield me-2"></i>Role-Based Access Control (v2.2.0)</h4>
                    <p>Kuber implements enterprise-grade RBAC with region-specific permissions:</p>
                    
                    <div class="card mb-3">
                        <div class="card-header bg-danger text-white">Authorization Flow</div>
                        <div class="card-body">
                            <pre class="bg-light p-3 rounded mb-0" style="font-size: 0.85rem;">
┌──────────┐      ┌────────────┐      ┌─────────────────────┐      ┌──────────────┐
│   User   │─────▶│   Roles    │─────▶│   Permissions       │─────▶│   Regions    │
└──────────┘      └────────────┘      └─────────────────────┘      └──────────────┘

admin ──────────▶ [admin] ───────────▶ ALL ────────────────────────▶ * (all regions)
operator ───────▶ [default_full] ───▶ READ, WRITE, DELETE ─────────▶ default
readonly ───────▶ [orders_readonly]─▶ READ ─────────────────────────▶ orders</pre>
                        </div>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h5>Permission Types</h5>
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr><th>Permission</th><th>Operations</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td><span class="badge bg-success">READ</span></td><td>GET, EXISTS, KEYS, SCAN, SEARCH</td></tr>
                                    <tr><td><span class="badge bg-warning text-dark">WRITE</span></td><td>SET, SETEX, INCR, HSET, JSET</td></tr>
                                    <tr><td><span class="badge bg-danger">DELETE</span></td><td>DEL, HDEL, JDEL, FLUSHDB</td></tr>
                                    <tr><td><span class="badge bg-dark">ADMIN</span></td><td>Region mgmt, User/Role mgmt</td></tr>
                                </tbody>
                            </table>
                        </div>
                        <div class="col-md-6">
                            <h5>Role Naming Convention</h5>
                            <table class="table table-sm table-bordered">
                                <thead class="table-light">
                                    <tr><th>Pattern</th><th>Example</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td><code>admin</code></td><td>System admin (reserved)</td></tr>
                                    <tr><td><code>{region}_readonly</code></td><td>orders_readonly</td></tr>
                                    <tr><td><code>{region}_readwrite</code></td><td>orders_readwrite</td></tr>
                                    <tr><td><code>{region}_full</code></td><td>orders_full</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <h5 class="mt-3">Hot Reload</h5>
                    <ul>
                        <li><strong>Automatic:</strong> Security files checked every 30 seconds</li>
                        <li><strong>Linked:</strong> Changes to users.json OR roles.json reload BOTH files</li>
                        <li><strong>No Restart:</strong> Security changes take effect without server restart</li>
                    </ul>
                    
                    <h5 class="mt-3">Authorization Enforcement</h5>
                    <table class="table table-sm table-bordered">
                        <thead class="table-light">
                            <tr><th>Layer</th><th>Enforcement Point</th></tr>
                        </thead>
                        <tbody>
                            <tr><td>Web UI</td><td>CacheController, RegionController, HomeController</td></tr>
                            <tr><td>REST API</td><td>ApiController - all /api/* endpoints</td></tr>
                            <tr><td>Redis Protocol</td><td>RedisProtocolHandler after AUTH</td></tr>
                        </tbody>
                    </table>
                    
                    <h4 class="mt-4">User Configuration (users.json)</h4>
                    <pre class="bg-dark text-light p-3 rounded"><code>{
  "users": [
    {
      "userId": "admin",
      "password": "admin123",
      "fullName": "System Administrator",
      "roles": ["admin"],
      "enabled": true,
      "systemUser": true
    },
    {
      "userId": "operator",
      "password": "operator123", 
      "fullName": "Cache Operator",
      "roles": ["default_full", "orders_readwrite"],
      "enabled": true
    }
  ]
}</code></pre>
                    
                    <h4 class="mt-4">Role Configuration (roles.json)</h4>
                    <pre class="bg-dark text-light p-3 rounded"><code>{
  "roles": [
    {
      "name": "admin",
      "displayName": "System Administrator",
      "region": "*",
      "permissions": ["READ", "WRITE", "DELETE", "ADMIN"],
      "systemRole": true
    },
    {
      "name": "default_readonly",
      "region": "default",
      "permissions": ["READ"]
    },
    {
      "name": "orders_full",
      "region": "orders",
      "permissions": ["READ", "WRITE", "DELETE"]
    }
  ]
}</code></pre>
                </section>

                <!-- 13. Data Flow -->
                <section id="data-flow" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-exchange-alt me-2 text-primary"></i>13. Data Flow</h2>
                    
                    <h4>Write Operation Flow</h4>
                    <pre class="bg-dark text-light p-3 rounded" style="font-size: 0.8rem;">
Client          Protocol Handler       CacheService         KeyIndex          Persistence
   │                  │                     │                   │                  │
   │ SET key value    │                     │                   │                  │
   │─────────────────►│                     │                   │                  │
   │                  │ set(region,key,val) │                   │                  │
   │                  │────────────────────►│                   │                  │
   │                  │                     │ put(key,metadata) │                  │
   │                  │                     │──────────────────►│                  │
   │                  │                     │                   │                  │
   │                  │                     │ save(region,key,entry)               │
   │                  │                     │─────────────────────────────────────►│
   │                  │                     │                   │                  │
   │ +OK              │                     │                   │                  │
   │◄─────────────────│◄────────────────────│                   │                  │</pre>
                    
                    <h4 class="mt-4">Read Operation Flow (Cache Hit)</h4>
                    <pre class="bg-dark text-light p-3 rounded" style="font-size: 0.8rem;">
Client          Protocol Handler       CacheService         KeyIndex         Value Cache
   │                  │                     │                   │                  │
   │ GET key          │                     │                   │                  │
   │─────────────────►│                     │                   │                  │
   │                  │ get(region,key)     │                   │                  │
   │                  │────────────────────►│                   │                  │
   │                  │                     │ containsKey(key)  │                  │
   │                  │                     │──────────────────►│                  │
   │                  │                     │ true              │                  │
   │                  │                     │◄──────────────────│                  │
   │                  │                     │                   │  get(key)        │
   │                  │                     │──────────────────────────────────────►│
   │                  │                     │                   │  CACHE HIT       │
   │                  │                     │◄──────────────────────────────────────│
   │ $value           │                     │                   │                  │
   │◄─────────────────│◄────────────────────│                   │                  │</pre>
                </section>

                <!-- 14. Deployment Patterns -->
                <section id="deployment" class="mb-5">
                    <h2 class="border-bottom pb-2 mb-4"><i class="fas fa-server me-2 text-secondary"></i>14. Deployment Patterns</h2>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-primary text-white">Single Node (Development)</div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>Redis Protocol: Port 6380</li>
                                        <li>REST API: Port 8080</li>
                                        <li>Web UI: Port 8080</li>
                                        <li>Persistence: RocksDB/SQLite</li>
                                        <li>No ZooKeeper required</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card h-100">
                                <div class="card-header bg-success text-white">HA Cluster (Production)</div>
                                <div class="card-body">
                                    <ul class="mb-0">
                                        <li>1 Primary + N Secondaries</li>
                                        <li>Load Balancer (HAProxy/ALB)</li>
                                        <li>ZooKeeper Cluster (3+ nodes)</li>
                                        <li>Shared Persistence (MongoDB/PostgreSQL)</li>
                                        <li>Automatic failover</li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Deep Dive -->
                <section class="mb-5">
                    <div class="card shadow-sm border-secondary">
                        <div class="card-header bg-secondary text-white">
                            <h2 class="mb-0"><i class="fas fa-microscope me-2"></i>Deep Dive: System Internals</h2>
                        </div>
                        <div class="card-body">
                            <p>For detailed documentation on operational mechanics, see the <a href="#system-internals" class="fw-bold">System Internals</a> page:</p>
                            <div class="row">
                                <div class="col-md-3">
                                    <ul class="mb-0">
                                        <li><a href="#memory-management">Memory Management</a></li>
                                        <li><a href="#key-management">Key Management</a></li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <ul class="mb-0">
                                        <li><a href="#persistence-management">Persistence Management</a></li>
                                        <li><a href="#compaction">Compaction &amp; Optimization</a></li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <ul class="mb-0">
                                        <li><a href="#thread-management">Thread Management</a></li>
                                        <li><a href="#data-safety">Data Safety &amp; Recovery</a></li>
                                    </ul>
                                </div>
                                <div class="col-md-3">
                                    <ul class="mb-0">
                                        <li><a href="#event-publishing">Event Publishing</a></li>
                                        <li><a href="/help/publishing">Publishing Guide</a></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Back to Help -->

                <!-- System Internals (merged from internals.html) -->
                <hr class="my-5">
                <h1 id="system-internals" class="display-5 mb-4"><i class="fas fa-cogs me-3 text-primary"></i>System Internals</h1>
                <div class="alert alert-info">
                    <i class="fas fa-info-circle me-2"></i>
                    <strong>Version 2.6.4</strong> - Deep dive into <span th:text="${appName} ?: 'Kuber'">Kuber</span>'s 
                    architecture and operational mechanics.
                </div>

                <!-- Table of Contents -->
                <div class="card mb-5">
                    <div class="card-header bg-dark text-white">
                        <h5 class="mb-0"><i class="fas fa-list me-2"></i>Table of Contents</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <ol>
                                    <li><a href="#memory-management">Memory Management</a></li>
                                    <li><a href="#key-management">Key Management</a></li>
                                    <li><a href="#persistence-management">Persistence Management</a></li>
                                    <li><a href="#compaction">Compaction &amp; Optimization</a></li>
                                    <li><a href="#thread-management">Thread Management</a></li>
                                </ol>
                            </div>
                            <div class="col-md-6">
                                <ol start="6">
                                    <li><a href="#data-safety">Data Safety &amp; Recovery</a></li>
                                    <li><a href="#concurrency-safety">Concurrency Safety &amp; Shutdown</a></li>
                                    <li><a href="#shutdown-utility">Shutdown Utility</a> <span class="badge bg-success">v1.3.6</span></li>
                                    <li><a href="#event-publishing">Event Publishing</a></li>
                                </ol>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 1. Memory Management -->
                <section id="memory-management" class="mb-5">
                    <div class="card shadow-sm">
                        <div class="card-header bg-success text-white">
                            <h2 class="mb-0"><i class="fas fa-memory me-2"></i>1. Memory Management</h2>
                        </div>
                        <div class="card-body">
                            <h4>1.1 Hybrid Memory Architecture</h4>
                            <p>Kuber uses a <strong>Hybrid Memory Architecture</strong> inspired by Aerospike's storage model. This design ensures optimal memory usage while maintaining sub-millisecond response times.</p>
                            
                            <div class="alert alert-info">
                                <strong><i class="fas fa-info-circle me-2"></i>Core Principle:</strong> 
                                ALL keys are ALWAYS kept in memory (KeyIndex). Values can be hot (in memory) or cold (on disk only).
                            </div>

                            <h5>Memory Structure</h5>
                            <pre class="bg-dark text-white p-3 rounded">
┌─────────────────────────────────────────────────────────────────────┐
│                         JVM HEAP MEMORY                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  ┌─────────────────────────────┐  ┌─────────────────────────────┐   │
│  │      KeyIndex (per region)   │  │    Value Cache (Caffeine)   │   │
│  ├─────────────────────────────┤  ├─────────────────────────────┤   │
│  │ • ALL keys always in memory │  │ • Hot values (recently used)│   │
│  │ • ~100 bytes per key        │  │ • Subject to eviction       │   │
│  │ • O(1) lookup               │  │ • LRU eviction policy       │   │
│  │ • Never evicted             │  │ • Configurable size limit   │   │
│  └─────────────────────────────┘  └─────────────────────────────┘   │
│                                                                      │
│  Optional: Off-Heap KeyIndex (DRAM outside Java heap)               │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ • Zero GC pressure           • Memory-mapped direct buffers │    │
│  │ • Millions of keys           • Auto-growing buffers         │    │
│  └─────────────────────────────────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────────┐
│                      PERSISTENCE LAYER (DISK)                        │
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐            │
│  │ RocksDB  │  │  SQLite  │  │   LMDB   │  │ MongoDB  │            │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘            │
│                      Cold values stored here                         │
└─────────────────────────────────────────────────────────────────────┘</pre>

                            <h4 class="mt-4">1.2 Value Retrieval Flow</h4>
                            <p>When a client requests a key using <code>GET</code>:</p>
                            
                            <pre class="bg-dark text-white p-3 rounded">
GET key → KeyIndex Check
             │
             ├── Key NOT in index → Return NULL (O(1), no disk I/O)
             │
             └── Key EXISTS in index
                      │
                      ├── Value in memory cache → Return immediately (O(1))
                      │
                      └── Value NOT in memory (cold)
                               │
                               └── Load from persistence store
                                        │
                                        ├── Found → Add to memory cache, return value
                                        │
                                        └── Not found → Cleanup index, return NULL</pre>

                            <div class="row mt-4">
                                <div class="col-md-6">
                                    <div class="card border-success">
                                        <div class="card-header bg-success text-white">Memory Cache Hit</div>
                                        <div class="card-body">
                                            <ul class="mb-0">
                                                <li>Latency: &lt; 1 microsecond</li>
                                                <li>No disk I/O</li>
                                                <li>Updates access time for LRU</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-warning">
                                        <div class="card-header bg-warning">Cold Value (Disk Read)</div>
                                        <div class="card-body">
                                            <ul class="mb-0">
                                                <li>Latency: 1-10 milliseconds</li>
                                                <li>Reads from persistence store</li>
                                                <li>Promotes value to memory cache</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h4 class="mt-4">1.3 Automatic Memory Protection (OOM Prevention)</h4>
                            <p>Kuber includes a <strong>Memory Watcher Service</strong> that prevents out-of-memory crashes:</p>

                            <pre class="bg-dark text-white p-3 rounded">
┌─────────────────────────────────────────────────────────────────────┐
│                    MEMORY WATCHER SERVICE                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  Monitoring: Every 5 seconds (configurable)                         │
│                                                                      │
│  ┌─────────────────────────────────────────────────────────────┐    │
│  │ Heap Usage Monitoring                                        │    │
│  │                                                              │    │
│  │  0%────────────────50%────────────────85%────────────100%   │    │
│  │  │                  │                  │                │    │    │
│  │  │   Normal Zone    │   Warning Zone   │  DANGER ZONE   │    │    │
│  │  │   (No action)    │   (Prepare)      │  (EVICT NOW)   │    │    │
│  │  └──────────────────┴──────────────────┴────────────────┘    │    │
│  │                     ▲                  ▲                      │    │
│  │              Low Watermark      High Watermark                │    │
│  │                 (50%)              (85%)                      │    │
│  └─────────────────────────────────────────────────────────────┘    │
│                                                                      │
│  When heap &gt; 85%:                                                   │
│  1. Persist cold values to disk                                     │
│  2. Evict values from memory cache (keys stay in KeyIndex!)        │
│  3. Update KeyIndex: ValueLocation.BOTH → ValueLocation.DISK       │
│  4. Repeat until heap &lt; 50%                                         │
│                                                                      │
│  Safety: Max 100 eviction iterations per cycle                      │
└─────────────────────────────────────────────────────────────────────┘</pre>

                            <h5>Memory Watcher Configuration</h5>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr><th>Property</th><th>Default</th><th>Description</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td><code>kuber.cache.memory-watcher-enabled</code></td><td>true</td><td>Enable/disable automatic memory management</td></tr>
                                    <tr><td><code>kuber.cache.memory-watcher-interval-ms</code></td><td>5000</td><td>Check interval in milliseconds</td></tr>
                                    <tr><td><code>kuber.cache.memory-high-watermark-percent</code></td><td>85</td><td>Start eviction when heap exceeds this %</td></tr>
                                    <tr><td><code>kuber.cache.memory-low-watermark-percent</code></td><td>50</td><td>Stop eviction when heap drops below this %</td></tr>
                                    <tr><td><code>kuber.cache.memory-eviction-batch-size</code></td><td>1000</td><td>Entries evicted per batch</td></tr>
                                </tbody>
                            </table>

                            <div class="alert alert-success">
                                <strong><i class="fas fa-check-circle me-2"></i>Key Guarantee:</strong>
                                During eviction, only VALUES are removed from memory. KEYS always remain in the KeyIndex, 
                                ensuring EXISTS and KEYS operations remain O(1) even under memory pressure.
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 2. Key Management -->
                <section id="key-management" class="mb-5">
                    <div class="card shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h2 class="mb-0"><i class="fas fa-key me-2"></i>2. Key Management</h2>
                        </div>
                        <div class="card-body">
                            <h4>2.1 KeyIndex Architecture</h4>
                            <p>The KeyIndex is the heart of Kuber's O(1) key operations. Every key ever written is tracked here.</p>

                            <pre class="bg-dark text-white p-3 rounded">
┌─────────────────────────────────────────────────────────────────────┐
│                         KEY INDEX ENTRY                              │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  KeyIndexEntry {                                                    │
│      String key;           // The actual key                        │
│      long valueSizeBytes;  // Size of value (for memory estimation)│
│      Instant createdAt;    // When key was first created           │
│      Instant expiresAt;    // TTL expiration time (nullable)       │
│      String valueType;     // STRING, HASH, LIST, etc.             │
│      ValueLocation location; // MEMORY, DISK, or BOTH              │
│      long accessCount;     // Access count for statistics          │
│      Instant lastAccessedAt; // For LRU tracking                   │
│  }                                                                  │
│                                                                      │
│  Memory footprint: ~100-150 bytes per key                           │
│  With 10 million keys: ~1.5 GB                                      │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘</pre>

                            <h4 class="mt-4">2.2 On-Heap vs Off-Heap KeyIndex</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-light">On-Heap (Default)</div>
                                        <div class="card-body">
                                            <p><code>kuber.cache.off-heap-key-index=false</code></p>
                                            <ul>
                                                <li>Uses ConcurrentHashMap</li>
                                                <li>Subject to GC pauses</li>
                                                <li>Good for &lt; 5 million keys</li>
                                                <li>Simpler debugging</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-header bg-success text-white">Off-Heap - Segmented (v1.3.2)</div>
                                        <div class="card-body">
                                            <p><code>kuber.cache.off-heap-key-index=true</code></p>
                                            <ul>
                                                <li>Multiple 1GB ByteBuffer segments</li>
                                                <li>Zero GC pressure</li>
                                                <li>Supports >2GB per region</li>
                                                <li>Ideal for 10+ million keys</li>
                                                <li>Auto-compaction at 30% fragmentation</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <h4 class="mt-4">2.3 Off-Heap Segmented Buffer Architecture (v1.3.2)</h4>
                            <div class="alert alert-info">
                                <strong>Why Segmented?</strong> Java's ByteBuffer.allocateDirect() is limited to ~2GB per buffer. 
                                Kuber uses multiple 1GB segments to support 8GB+ per region.
                            </div>
                            <pre class="bg-dark text-white p-3 rounded">
┌─────────────────────────────────────────────────────────────────────┐
│                    OFF-HEAP KEY INDEX                                │
├─────────────────────────────────────────────────────────────────────┤
│  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐                  │
│  │  Segment 0  │  │  Segment 1  │  │  Segment 2  │  ...             │
│  │   (1 GB)    │  │   (1 GB)    │  │   (1 GB)    │                  │
│  └──────┬──────┘  └──────┬──────┘  └──────┬──────┘                  │
│         │                │                │                          │
│         └────────────────┴────────────────┴──────────────────────────│
│                             │                                        │
│              Global Offset (long): position across segments          │
├─────────────────────────────────────────────────────────────────────┤
│  On-Heap Index:  ConcurrentHashMap&lt;String, Long&gt;  (key → offset)    │
└─────────────────────────────────────────────────────────────────────┘</pre>

                            <h5 class="mt-3">Memory Layout Per Key Entry</h5>
                            <table class="table table-bordered table-sm">
                                <thead class="table-light">
                                    <tr><th>Bytes</th><th>Field</th><th>Type</th><th>Description</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>2</td><td>keyLength</td><td>short</td><td>Length of key bytes</td></tr>
                                    <tr><td>variable</td><td>keyBytes</td><td>byte[]</td><td>UTF-8 encoded key</td></tr>
                                    <tr><td>8</td><td>expiresAt</td><td>long</td><td>TTL timestamp (-1 = never)</td></tr>
                                    <tr><td>1</td><td>location</td><td>byte</td><td>0=MEMORY, 1=DISK, 2=BOTH</td></tr>
                                    <tr><td>4</td><td>valueSize</td><td>int</td><td>Size of value in bytes</td></tr>
                                    <tr><td>8</td><td>lastAccess</td><td>long</td><td>Last access timestamp</td></tr>
                                    <tr><td>4</td><td>accessCount</td><td>int</td><td>Access counter for LFU</td></tr>
                                </tbody>
                            </table>
                            <p class="small text-muted">Total metadata: 27 bytes + key length</p>

                            <h5 class="mt-3">Off-Heap Configuration</h5>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr><th>Property</th><th>Default</th><th>Description</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td><code>kuber.cache.off-heap-key-index</code></td><td>false</td><td>Enable off-heap storage</td></tr>
                                    <tr><td><code>kuber.cache.off-heap-key-index-initial-size-mb</code></td><td>16</td><td>Initial segment size (MB)</td></tr>
                                    <tr><td><code>kuber.cache.off-heap-key-index-max-size-mb</code></td><td>8192</td><td>Max total size across all segments (MB)</td></tr>
                                </tbody>
                            </table>

                            <h4 class="mt-4">2.4 Key Operation Performance</h4>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr><th>Operation</th><th>Complexity</th><th>Disk I/O</th><th>Notes</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td><code>EXISTS key</code></td><td>O(1)</td><td>Never</td><td>Pure memory lookup in KeyIndex</td></tr>
                                    <tr><td><code>KEYS pattern</code></td><td>O(n)</td><td>Never</td><td>Scans KeyIndex only, not disk</td></tr>
                                    <tr><td><code>DBSIZE</code></td><td>O(1)</td><td>Never</td><td>Returns keyIndex.size()</td></tr>
                                    <tr><td><code>TYPE key</code></td><td>O(1)</td><td>Never</td><td>Stored in KeyIndex metadata</td></tr>
                                    <tr><td><code>TTL key</code></td><td>O(1)</td><td>Never</td><td>Stored in KeyIndex metadata</td></tr>
                                </tbody>
                            </table>

                            <h4 class="mt-4">2.5 Key Lifecycle</h4>
                            <pre class="bg-dark text-white p-3 rounded">
SET key value
    │
    ▼
┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│ 1. Update KeyIndex│ ──▶ │ 2. Add to Cache   │ ──▶ │ 3. Persist Async  │
│ (location=BOTH)   │     │ (value in memory) │     │ (write to disk)   │
└───────────────────┘     └───────────────────┘     └───────────────────┘

Memory Pressure (Eviction)
    │
    ▼
┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│ 1. Persist Value  │ ──▶ │ 2. Remove from    │ ──▶ │ 3. Update KeyIndex│
│ (ensure on disk)  │     │    Memory Cache   │     │ (location=DISK)   │
└───────────────────┘     └───────────────────┘     └───────────────────┘

DELETE key
    │
    ▼
┌───────────────────┐     ┌───────────────────┐     ┌───────────────────┐
│ 1. Remove from    │ ──▶ │ 2. Remove from    │ ──▶ │ 3. Delete from    │
│    KeyIndex       │     │    Memory Cache   │     │    Persistence    │
└───────────────────┘     └───────────────────┘     └───────────────────┘</pre>
                        </div>
                    </div>
                </section>

                <!-- 3. Persistence Management -->
                <section id="persistence-management" class="mb-5">
                    <div class="card shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h2 class="mb-0"><i class="fas fa-database me-2"></i>3. Persistence Management</h2>
                        </div>
                        <div class="card-body">
                            <h4>3.1 Supported Persistence Backends</h4>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr><th>Backend</th><th>Use Case</th><th>Characteristics</th><th>Configuration</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>RocksDB</strong> (Default)</td>
                                        <td>High performance, no external deps</td>
                                        <td>LSM-tree, embedded, fast writes</td>
                                        <td><code>kuber.persistence.type=lmdb</code></td>
                                    </tr>
                                    <tr>
                                        <td><strong>LMDB</strong></td>
                                        <td>Zero-copy reads, ACID transactions</td>
                                        <td>B+ tree, memory-mapped, crash-safe</td>
                                        <td><code>kuber.persistence.type=lmdb</code></td>
                                    </tr>
                                    <tr>
                                        <td><strong>SQLite</strong></td>
                                        <td>Portability, SQL queries</td>
                                        <td>Single file, ACID, SQL support</td>
                                        <td><code>kuber.persistence.type=sqlite</code></td>
                                    </tr>
                                    <tr>
                                        <td><strong>MongoDB</strong></td>
                                        <td>Distributed, flexible queries</td>
                                        <td>Document store, replication</td>
                                        <td><code>kuber.persistence.type=mongodb</code></td>
                                    </tr>
                                    <tr>
                                        <td><strong>Memory</strong></td>
                                        <td>Testing, volatile cache</td>
                                        <td>No persistence, pure cache</td>
                                        <td><code>kuber.persistence.type=memory</code></td>
                                    </tr>
                                </tbody>
                            </table>

                            <h4 class="mt-4">3.2 Write Path (v1.5.0)</h4>
                            <p>Individual writes support two modes configured via <code>kuber.persistence.sync-individual-writes</code>:</p>
                            
                            <div class="alert alert-info mb-3">
                                <strong>ASYNC Mode (default):</strong> Memory updated first, disk write in background - 10-100x faster<br>
                                <strong>SYNC Mode:</strong> Disk write completes before returning - maximum durability
                            </div>
                            
                            <pre class="bg-dark text-white p-3 rounded">
<span class="text-success">═══════════════════════════════════════════════════════════════════
  ASYNC MODE (default) - sync-individual-writes: false
═══════════════════════════════════════════════════════════════════</span>

Client SET Command
        │
        ▼
┌───────────────────────────────────────────────────────────────────┐
│                       CacheService.set()                           │
│                                                                    │
│  1. Validate region exists                                         │
│  2. Apply attribute mapping (if JSON)                             │
│  3. Create CacheEntry with TTL, timestamps                        │
│  4. putEntry() →                                                   │
│       │                                                            │
│       ├── 1. Update KeyIndex (IMMEDIATE)     ← Key is "on disk"   │
│       ├── 2. Update Value Cache (IMMEDIATE)  ← Data readable now  │
│       └── 3. saveEntryAsync() (BACKGROUND)   ← Non-blocking       │
│                                                                    │
│  Return: +OK (after memory update, ~0.01-0.1ms)                   │
└───────────────────────────────────────────────────────────────────┘
        │
        │  (background thread)
        ▼
┌───────────────────────────────────────────────────────────────────┐
│              PersistenceStore.saveEntryAsync()                     │
│              Eventually written to disk                            │
└───────────────────────────────────────────────────────────────────┘

<span class="text-warning">═══════════════════════════════════════════════════════════════════
  SYNC MODE - sync-individual-writes: true
═══════════════════════════════════════════════════════════════════</span>

Client SET Command
        │
        ▼
┌───────────────────────────────────────────────────────────────────┐
│                       CacheService.set()                           │
│                                                                    │
│  1. Validate region exists                                         │
│  2. Apply attribute mapping (if JSON)                             │
│  3. Create CacheEntry with TTL, timestamps                        │
│  4. putEntry() →                                                   │
│       │                                                            │
│       ├── 1. saveEntry() (BLOCKING)          ← Wait for disk      │
│       │       └── fsync() to disk                                 │
│       ├── 2. Update KeyIndex (after disk)    ← Confirmed on disk  │
│       └── 3. Update Value Cache              ← Data readable      │
│                                                                    │
│  Return: +OK (after disk write, ~1-5ms)                           │
└───────────────────────────────────────────────────────────────────┘</pre>

                            <h5 class="mt-4">Write Mode Comparison</h5>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr><th>Aspect</th><th>ASYNC (default)</th><th>SYNC</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td>Latency</td><td>~0.01-0.1ms</td><td>~1-5ms</td></tr>
                                    <tr><td>Throughput</td><td>10,000-100,000 ops/sec</td><td>200-1,000 ops/sec</td></tr>
                                    <tr><td>Durability</td><td>Eventually consistent</td><td>Immediate</td></tr>
                                    <tr><td>Crash Risk</td><td>Entry may be lost</td><td>No data loss</td></tr>
                                    <tr><td>Use Case</td><td>Performance critical</td><td>Durability critical</td></tr>
                                </tbody>
                            </table>

                            <h4 class="mt-4">3.3 Region-Based Organization</h4>
                            <p>Data is organized into <strong>regions</strong> for logical separation:</p>
                            <pre class="bg-dark text-white p-3 rounded">
./data/rocksdb/
├── default/          # Default region
│   ├── 000001.sst    # RocksDB SST files
│   └── CURRENT
├── customers/        # Customer data region
│   ├── 000001.sst
│   └── CURRENT
└── products/         # Product catalog region
    ├── 000001.sst
    └── CURRENT

Each region has:
• Its own KeyIndex (in memory)
• Its own Value Cache (Caffeine instance)
• Its own persistence directory/collection
• Independent memory limits</pre>
                        </div>
                    </div>
                </section>

                <!-- 4. Compaction and Optimization -->
                <section id="compaction" class="mb-5">
                    <div class="card shadow-sm">
                        <div class="card-header bg-warning text-dark">
                            <h2 class="mb-0"><i class="fas fa-compress-arrows-alt me-2"></i>4. Compaction &amp; Optimization</h2>
                        </div>
                        <div class="card-body">
                            <h4>4.1 Why Compaction Matters</h4>
                            <p>Databases like RocksDB and SQLite accumulate dead space from updates and deletes. Compaction reclaims this space and improves read performance.</p>

                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-danger mb-3">
                                        <div class="card-header bg-danger text-white">Before Compaction</div>
                                        <div class="card-body">
                                            <ul class="mb-0">
                                                <li>Multiple SST files with overlapping keys</li>
                                                <li>Tombstones for deleted entries</li>
                                                <li>Fragmented disk space</li>
                                                <li>Slower read amplification</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-success mb-3">
                                        <div class="card-header bg-success text-white">After Compaction</div>
                                        <div class="card-body">
                                            <ul class="mb-0">
                                                <li>Merged, optimized SST files</li>
                                                <li>Tombstones removed</li>
                                                <li>Disk space reclaimed</li>
                                                <li>Faster reads</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <h4 class="mt-4">4.2 When Compaction Runs</h4>
                            <pre class="bg-dark text-white p-3 rounded">
┌─────────────────────────────────────────────────────────────────────┐
│                   COMPACTION SCHEDULE (v1.2.6)                       │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  STARTUP COMPACTION (PersistenceMaintenanceService)                 │
│  ─────────────────────────────────────────────────────              │
│  • Runs AFTER Spring context initialization                         │
│  • BEFORE cache service loads data                                  │
│  • Ensures databases are optimized before serving requests          │
│                                                                      │
│  Sequence:                                                          │
│  Spring Ready → 10s wait → COMPACTION → 2s wait → Cache Init        │
│                                                                      │
│                                                                      │
│  SCHEDULED COMPACTION (RocksDbCompactionService)                    │
│  ─────────────────────────────────────────────────                  │
│  • Default: 2:00 AM daily                                           │
│  • Configurable via cron expression                                 │
│  • Non-blocking (runs in background)                                │
│                                                                      │
│  kuber.persistence.rocksdb.compaction-cron=0 0 2 * * ?              │
│                                                                      │
│  Examples:                                                          │
│  • "0 0 3 * * SUN"    → 3:00 AM every Sunday                       │
│  • "0 0 */6 * * ?"    → Every 6 hours                              │
│  • "0 30 1 * * ?"     → 1:30 AM daily                              │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘</pre>

                            <h4 class="mt-4">4.3 Backend-Specific Optimization</h4>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr><th>Backend</th><th>Operation</th><th>What It Does</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>RocksDB</strong></td>
                                        <td><code>compactRange()</code></td>
                                        <td>Merges SST files, removes tombstones, reduces read amplification</td>
                                    </tr>
                                    <tr>
                                        <td><strong>SQLite</strong></td>
                                        <td><code>VACUUM</code></td>
                                        <td>Rebuilds database file, reclaims unused pages</td>
                                    </tr>
                                    <tr>
                                        <td><strong>LMDB</strong></td>
                                        <td>N/A (auto-balancing)</td>
                                        <td>B+ tree self-balances; no manual compaction needed</td>
                                    </tr>
                                    <tr>
                                        <td><strong>MongoDB</strong></td>
                                        <td><code>compact</code></td>
                                        <td>Managed by MongoDB server (WiredTiger auto-compacts)</td>
                                    </tr>
                                </tbody>
                            </table>

                            <h4 class="mt-4">4.4 Compaction Configuration</h4>
                            <pre class="bg-light p-3 rounded"><code># Enable/disable startup compaction
kuber.persistence.rocksdb.compaction-enabled=true

# Scheduled compaction cron (RocksDB only)
kuber.persistence.rocksdb.compaction-cron=0 0 2 * * ?</code></pre>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-bolt me-2"></i>
                                <strong>Sequential Processing (v1.5.0):</strong>
                                Region databases are compacted/vacuumed sequentially during startup for data consistency.
                                This ensures no concurrent operations that could cause corruption.
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 5. Thread Management -->
                <section id="thread-management" class="mb-5">
                    <div class="card shadow-sm">
                        <div class="card-header bg-secondary text-white">
                            <h2 class="mb-0"><i class="fas fa-tasks me-2"></i>5. Thread Management</h2>
                        </div>
                        <div class="card-body">
                            <h4>5.1 Thread Architecture</h4>
                            <pre class="bg-dark text-white p-3 rounded">
┌─────────────────────────────────────────────────────────────────────┐
│                       KUBER THREAD MODEL                             │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  MAIN THREADS                                                       │
│  ────────────────────────────────────────────────────               │
│  main                       Spring Boot startup                     │
│  kuber-startup-orchestrator Startup sequence coordination          │
│                                                                      │
│  SEQUENTIAL STARTUP (v1.5.0)                                        │
│  ────────────────────────────────────────────────────               │
│  All startup operations (compaction, loading) run sequentially      │
│  in the main startup thread for data consistency.                   │
│                                                                      │
│  REDIS PROTOCOL (Apache MINA)                                       │
│  ────────────────────────────────────────────────────               │
│  NioProcessor-[1-N]         I/O processing threads                  │
│  pool-[N]-thread-[M]        ExecutorFilter worker threads           │
│                              (CachedThreadPool for client handlers) │
│                                                                      │
│  SCHEDULED TASKS (Spring @Scheduled)                                │
│  ────────────────────────────────────────────────────               │
│  scheduling-1               TTL cleanup (every 60s)                 │
│                             Memory watcher (every 5s)               │
│                             Metrics collection (every 1m)           │
│                             Persistence expiration (every 60s)      │
│                             Replication heartbeat (every 5s)        │
│                             Scheduled compaction (cron)             │
│                                                                      │
│  AUTOLOAD                                                           │
│  ────────────────────────────────────────────────────               │
│  kuber-autoload             File scanning and processing           │
│                                                                      │
│  BACKUP/RESTORE (v1.5.0)                                            │
│  ────────────────────────────────────────────────────               │
│  kuber-backup               Periodic backup of all regions         │
│  kuber-restore-watcher      Monitors ./restore for backup files    │
│                                                                      │
│  ASYNC PERSISTENCE (v1.5.0)                                         │
│  ────────────────────────────────────────────────────               │
│  persistence-async-save-0   Region-partitioned async writes        │
│  persistence-async-save-1   (hash of region name mod 4)            │
│  persistence-async-save-2   All writes for same region are         │
│  persistence-async-save-3   sequential, different regions parallel │
│                                                                      │
│  EVENT PUBLISHING                                                   │
│  ────────────────────────────────────────────────────               │
│  kuber-event-publisher-[N]  Async event publishing to destinations │
│  (Kafka, Confluent Kafka, ActiveMQ, RabbitMQ, IBM MQ, File)                         │
│                                                                      │
│  HTTP SERVER (Spring/Tomcat)                                        │
│  ────────────────────────────────────────────────────               │
│  http-nio-8080-exec-[N]     REST API request handlers              │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘</pre>

                            <h4 class="mt-4">5.2 Scheduled Tasks</h4>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr><th>Task</th><th>Interval</th><th>Purpose</th><th>Protection</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>TTL Cleanup</td>
                                        <td>60 seconds</td>
                                        <td>Remove expired entries from cache</td>
                                        <td>Checks <code>initialized.get()</code></td>
                                    </tr>
                                    <tr>
                                        <td>Memory Watcher</td>
                                        <td>5 seconds</td>
                                        <td>Monitor heap and evict if needed</td>
                                        <td>Checks <code>cacheService.isInitialized()</code></td>
                                    </tr>
                                    <tr>
                                        <td>Metrics Collection</td>
                                        <td>1 minute</td>
                                        <td>Record cache hit rates, sizes</td>
                                        <td>N/A (safe to run early)</td>
                                    </tr>
                                    <tr>
                                        <td>Persistence Expiration</td>
                                        <td>60 seconds</td>
                                        <td>Clean expired entries from disk</td>
                                        <td>Checks <code>cacheService.isInitialized()</code></td>
                                    </tr>
                                    <tr>
                                        <td>Scheduled Compaction</td>
                                        <td>Cron (2 AM)</td>
                                        <td>Optimize RocksDB storage</td>
                                        <td>Checks <code>enabled.get()</code></td>
                                    </tr>
                                </tbody>
                            </table>

                            <h4 class="mt-4">5.3 Thread Safety Guarantees</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">On-Heap KeyIndex</div>
                                        <div class="card-body">
                                            <code>ConcurrentHashMap</code> - lock-free reads, segment-level locking for writes
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card">
                                        <div class="card-header bg-light">Off-Heap KeyIndex</div>
                                        <div class="card-body">
                                            <code>ReentrantReadWriteLock</code> - multiple concurrent readers, exclusive writer
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 6. Data Safety and Recovery -->
                <section id="data-safety" class="mb-5">
                    <div class="card shadow-sm">
                        <div class="card-header bg-dark text-white">
                            <h2 class="mb-0"><i class="fas fa-shield-alt me-2"></i>6. Data Safety &amp; Recovery</h2>
                        </div>
                        <div class="card-body">
                            <h4>6.1 Data Durability Guarantees</h4>
                            <pre class="bg-dark text-white p-3 rounded">
┌─────────────────────────────────────────────────────────────────────┐
│                    DATA DURABILITY LEVELS                            │
├─────────────────────────────────────────────────────────────────────┤
│                                                                      │
│  WRITE PATH DURABILITY                                              │
│  ─────────────────────────────────────────────                      │
│                                                                      │
│  SET command → KeyIndex ✓ → Value Cache ✓ → Persistence (async)    │
│                                                                      │
│  • KeyIndex update: Synchronous (immediate)                         │
│  • Value Cache update: Synchronous (immediate)                      │
│  • Persistence: Asynchronous (background)                           │
│                                                                      │
│  Data is SAFE when:                                                 │
│  ✓ Client receives OK response                                      │
│  ✓ Data is in memory (KeyIndex + Cache)                            │
│  ✓ Persistence write queued (will complete in background)          │
│                                                                      │
│                                                                      │
│  PERSISTENCE BACKEND GUARANTEES                                     │
│  ─────────────────────────────────────────────                      │
│                                                                      │
│  RocksDB:  • WAL (Write-Ahead Log) for crash recovery              │
│            • Configurable sync mode                                 │
│            • LSM-tree with compaction                               │
│                                                                      │
│  LMDB:     • Full ACID transactions                                 │
│            • Memory-mapped with OS sync                             │
│            • Copy-on-write (no corruption on crash)                 │
│                                                                      │
│  SQLite:   • Journal mode (WAL or rollback)                        │
│            • ACID transactions                                      │
│            • VACUUM for recovery                                    │
│                                                                      │
│  MongoDB:  • Write concern configurable                            │
│            • Replication for high availability                      │
│            • Journaling for durability                              │
│                                                                      │
└─────────────────────────────────────────────────────────────────────┘</pre>

                            <h4 class="mt-4">6.2 Startup Recovery Process</h4>
                            <p>When Kuber starts (or restarts), data is automatically recovered from persistence:</p>
                            
                            <pre class="bg-dark text-white p-3 rounded">
SYSTEM RESTART
      │
      ▼
┌───────────────────────────────────────────────────────────────────┐
│ Phase 1: Spring Context Initialization                            │
│ • Load all beans and configurations                               │
│ • Wait 10 seconds for stabilization                               │
└───────────────────────────────────────────────────────────────────┘
      │
      ▼
┌───────────────────────────────────────────────────────────────────┐
│ Phase 2: Persistence Maintenance                                   │
│ • RocksDB: Run compactRange() on all region databases             │
│ • SQLite: Run VACUUM on all database files                        │
│ • Ensures optimal read performance for recovery                   │
└───────────────────────────────────────────────────────────────────┘
      │
      ▼
┌───────────────────────────────────────────────────────────────────┐
│ Phase 3: Cache Service Initialization (DATA RECOVERY)             │
│                                                                    │
│ For each region:                                                   │
│   1. Load ALL keys from persistence → KeyIndex                    │
│      (keys marked as ValueLocation.DISK initially)                │
│                                                                    │
│   2. Load hot values (up to memory limit) → Value Cache           │
│      (update location to ValueLocation.BOTH)                      │
│                                                                    │
│   3. Remaining values stay on disk (cold)                         │
│      (accessed on-demand via GET)                                 │
│                                                                    │
│ Result: ALL keys searchable, hot values in memory                 │
└───────────────────────────────────────────────────────────────────┘
      │
      ▼
┌───────────────────────────────────────────────────────────────────┐
│ Phase 4: Redis Protocol Server                                     │
│ • Bind to port 6380                                               │
│ • Accept client connections                                        │
│ • NOW clients can connect with FULL DATA AVAILABLE               │
└───────────────────────────────────────────────────────────────────┘
      │
      ▼
┌───────────────────────────────────────────────────────────────────┐
│ Phase 5: Autoload Service                                          │
│ • Resume file monitoring                                           │
│ • Process any files added during downtime                         │
└───────────────────────────────────────────────────────────────────┘
      │
      ▼
┌───────────────────────────────────────────────────────────────────┐
│ Phase 6: Backup/Restore Service (v1.5.0)                           │
│ • Start backup scheduler (every 30 min default)                   │
│ • Start restore watcher (monitors ./restore directory)            │
│ • Wire to CacheService for region locking                         │
└───────────────────────────────────────────────────────────────────┘
      │
      ▼
     SYSTEM READY</pre>

                            <h4 class="mt-4">6.3 Failure Scenarios and Handling</h4>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr><th>Scenario</th><th>Impact</th><th>Recovery</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Graceful Shutdown</strong></td>
                                        <td>No data loss</td>
                                        <td>All pending writes complete before shutdown</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Process Kill (SIGKILL)</strong></td>
                                        <td>Minimal data loss (in-flight async writes)</td>
                                        <td>RocksDB WAL recovery, LMDB txn rollback</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Power Failure</strong></td>
                                        <td>Last few async writes may be lost</td>
                                        <td>Same as SIGKILL; persistence backends are crash-safe</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Disk Full</strong></td>
                                        <td>Write failures logged</td>
                                        <td>Clear disk space, restart; existing data preserved</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Corrupted Database</strong></td>
                                        <td>Startup fails</td>
                                        <td>Restore from backup; RocksDB has repair tools</td>
                                    </tr>
                                </tbody>
                            </table>

                            <h4 class="mt-4">6.4 Best Practices for Data Safety</h4>
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-success">
                                        <div class="card-header bg-success text-white"><i class="fas fa-check me-2"></i>Do</div>
                                        <div class="card-body">
                                            <ul class="mb-0">
                                                <li>Use RocksDB or LMDB for production</li>
                                                <li>Enable scheduled compaction</li>
                                                <li>Monitor disk space usage</li>
                                                <li>Set up regular backups</li>
                                                <li>Use graceful shutdown</li>
                                                <li>Size JVM heap appropriately</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-danger">
                                        <div class="card-header bg-danger text-white"><i class="fas fa-times me-2"></i>Don't</div>
                                        <div class="card-body">
                                            <ul class="mb-0">
                                                <li>Use <code>memory</code> backend for important data</li>
                                                <li>Ignore disk space warnings</li>
                                                <li>Kill process with SIGKILL regularly</li>
                                                <li>Disable memory watcher in production</li>
                                                <li>Skip startup compaction for large datasets</li>
                                            </ul>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 7. Concurrency Safety & Shutdown (v1.3.3) -->
                <section id="concurrency-safety" class="mb-5">
                    <div class="card shadow-sm">
                        <div class="card-header text-white" style="background: linear-gradient(135deg, #10b981 0%, #3b82f6 100%);">
                            <h2 class="mb-0"><i class="fas fa-shield-alt me-2"></i>7. Concurrency Safety & Shutdown (v1.3.3)</h2>
                        </div>
                        <div class="card-body">
                            <p>Kuber v1.3.3 introduces comprehensive concurrency controls to prevent database corruption and ensure data integrity.</p>
                            
                            <h4>7.1 Persistence Operation Locking</h4>
                            <p>A centralized <code>PersistenceOperationLock</code> coordinates all operations that affect the persistence store:</p>
                            
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr><th>Operation</th><th>Lock Type</th><th>Blocks</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td><strong>Compaction</strong></td><td><span class="badge bg-danger">Exclusive Global</span></td><td>All other operations</td></tr>
                                    <tr><td><strong>Shutdown</strong></td><td><span class="badge bg-danger">Exclusive Global</span></td><td>All other operations</td></tr>
                                    <tr><td><strong>Cleanup/Expiration</strong></td><td><span class="badge bg-warning text-dark">Shared Global</span></td><td>Only during exclusive ops</td></tr>
                                    <tr><td><strong>Autoload</strong></td><td><span class="badge bg-info">Per-Region</span></td><td>Same-region operations</td></tr>
                                    <tr><td><strong>Region Loading</strong></td><td><span class="badge bg-info">Per-Region</span></td><td>Queries to that region</td></tr>
                                </tbody>
                            </table>
                            
                            <h4 class="mt-4">7.2 Shutdown Orchestrator</h4>
                            <p>The <code>ShutdownOrchestrator</code> ensures orderly shutdown in the <strong>exact reverse order</strong> of startup:</p>
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="card border-primary">
                                        <div class="card-header bg-primary text-white">Startup Order</div>
                                        <div class="card-body">
                                            <ol class="mb-0">
                                                <li>Persistence Maintenance</li>
                                                <li>Cache Service (recovery)</li>
                                                <li>Event Publishing</li>
                                                <li>Redis Protocol Server</li>
                                                <li>Autoload Service</li>
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card border-success">
                                        <div class="card-header bg-success text-white">Shutdown Order (Reverse)</div>
                                        <div class="card-body">
                                            <ol class="mb-0">
                                                <li>Stop Autoload Service</li>
                                                <li>Stop Redis Protocol Server</li>
                                                <li>Stop Event Publishing</li>
                                                <li>Persist Cache Data</li>
                                                <li>Close Persistence Store</li>
                                            </ol>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-clock me-2"></i>
                                Each shutdown phase has a <strong>5-second delay</strong> to ensure in-flight operations complete and buffers flush.
                            </div>
                            
                            <h4 class="mt-4">8.3 Region Loading Guards</h4>
                            <p>During startup, queries to a region that's still loading will <strong>wait</strong> until loading completes:</p>
                            <pre class="bg-dark text-white p-3 rounded">
GET key (region 'orders' is loading)
    │
    └── waitForRegionReady('orders', 30s timeout)
            │
            ├── Still loading? → Wait 100ms, check again
            │
            └── Loaded! → Proceed with GET operation</pre>
                        </div>
                    </div>
                </section>

                <!-- 8. Startup & Shutdown (v1.3.6) -->
                <section id="shutdown-utility" class="mb-5">
                    <div class="card shadow-sm">
                        <div class="card-header text-white" style="background: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);">
                            <h2 class="mb-0"><i class="fas fa-power-off me-2"></i>8. Startup &amp; Shutdown (v1.3.6)</h2>
                        </div>
                        <div class="card-body">
                            <p>Kuber v1.3.6 provides comprehensive management scripts and orchestrated startup/shutdown sequences for reliable operation.</p>
                            
                            <h4>8.1 Management Scripts</h4>
                            <p>Scripts are located in the <code>scripts/</code> folder:</p>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr><th>Script</th><th>Platform</th><th>Description</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>kuber-start.sh</code></td>
                                        <td><span class="badge bg-success">Linux/Mac</span></td>
                                        <td>Start Kuber server with JVM options</td>
                                    </tr>
                                    <tr>
                                        <td><code>kuber-start.bat</code></td>
                                        <td><span class="badge bg-primary">Windows</span></td>
                                        <td>Start Kuber server on Windows</td>
                                    </tr>
                                    <tr>
                                        <td><code>kuber-shutdown.sh</code></td>
                                        <td><span class="badge bg-success">Linux/Mac</span></td>
                                        <td>Graceful shutdown via file or API</td>
                                    </tr>
                                    <tr>
                                        <td><code>kuber-shutdown.bat</code></td>
                                        <td><span class="badge bg-primary">Windows</span></td>
                                        <td>Graceful shutdown on Windows</td>
                                    </tr>
                                    <tr>
                                        <td><code>kuber-status.sh</code></td>
                                        <td><span class="badge bg-success">Linux/Mac</span></td>
                                        <td>Check server status</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <h4 class="mt-4">8.2 Startup Script Usage</h4>
                            <pre class="bg-dark text-white p-3 rounded">
# Basic startup
./scripts/kuber-start.sh

# With options
./scripts/kuber-start.sh -m 4g -p prod              # 4GB heap, prod profile
./scripts/kuber-start.sh -d -l /var/log/kuber       # Daemon mode with log dir
./scripts/kuber-start.sh --redis-port 6381          # Custom Redis port
./scripts/kuber-start.sh --debug                     # Enable remote debugging</pre>
                            
                            <h4 class="mt-4">8.3 Startup Sequence</h4>
                            <p>Kuber follows an orchestrated startup sequence managed by <code>StartupOrchestrator</code>:</p>
                            <pre class="bg-dark text-white p-3 rounded">
Application Start
       │
       ▼
┌─────────────────────────────────────────────────────────────┐
│  Phase 1: Infrastructure Setup                               │
│  • Initialize logging & configuration                        │
│  • Connect to ZooKeeper (if replication enabled)            │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  Phase 2: Persistence Maintenance (Sequential)               │
│  • Initialize RocksDB/SQLite stores per region              │
│  • Run compaction sequentially (one region at a time)       │
│  • Clean expired entries                                     │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  Phase 3: Cache Recovery (Sequential)                        │
│  • Load persisted entries into memory (one region at a time)│
│  • Build off-heap key indexes                                │
│  • Prime negative cache                                      │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  Phase 4: Service Activation                                 │
│  • Start Event Publishing (Kafka, RabbitMQ, etc.)           │
│  • Start Redis Protocol Server (port 6380)                  │
│  • Start HTTP/REST Server (port 8080)                       │
└────────────────────────┬────────────────────────────────────┘
                         │
                         ▼
┌─────────────────────────────────────────────────────────────┐
│  Phase 5: Background Services                                │
│  • Start Autoload Service (file monitoring)                 │
│  • Start Scheduled Tasks (compaction, cleanup)              │
│  • Start Shutdown File Watcher                              │
│  • System Ready!                                             │
└─────────────────────────────────────────────────────────────┘</pre>
                            
                            <h4 class="mt-4">8.4 Shutdown Methods</h4>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr><th>Method</th><th>Command</th><th>Use Case</th></tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><span class="badge bg-success">File-based</span></td>
                                        <td><code>touch ./kuberdata/kuber.shutdown</code></td>
                                        <td>Local shutdown, scripted automation</td>
                                    </tr>
                                    <tr>
                                        <td><span class="badge bg-primary">REST API</span></td>
                                        <td><code>POST /api/admin/shutdown</code></td>
                                        <td>Remote shutdown, CI/CD pipelines</td>
                                    </tr>
                                    <tr>
                                        <td><span class="badge bg-warning text-dark">Signal</span></td>
                                        <td><code>SIGTERM</code> / <code>Ctrl+C</code></td>
                                        <td>Container orchestration (K8s, Docker)</td>
                                    </tr>
                                    <tr>
                                        <td><span class="badge bg-info">Script</span></td>
                                        <td><code>./scripts/kuber-shutdown.sh</code></td>
                                        <td>Convenient wrapper with options</td>
                                    </tr>
                                </tbody>
                            </table>
                            
                            <h4 class="mt-4">8.5 Shutdown Script Usage</h4>
                            <pre class="bg-dark text-white p-3 rounded">
# File-based shutdown (default)
./scripts/kuber-shutdown.sh

# With reason for logging
./scripts/kuber-shutdown.sh -r "Maintenance window"

# API-based shutdown
./scripts/kuber-shutdown.sh -a -k your-api-key

# REST API directly
curl -X POST http://localhost:8080/api/admin/shutdown \
  -H "X-API-Key: your-api-key"</pre>
                            
                            <div class="alert alert-info">
                                <i class="fas fa-info-circle me-2"></i>
                                Kuber checks for the shutdown file every 5 seconds (configurable). When detected, it initiates graceful shutdown and deletes the file automatically.
                            </div>
                            
                            <h4 class="mt-4">8.6 Shutdown Sequence</h4>
                            <p>Shutdown proceeds in <strong>exact reverse order</strong> of startup with configurable delays:</p>
                            <pre class="bg-dark text-white p-3 rounded">
Shutdown Triggered (file/API/signal)
         │
         ▼
┌─────────────────────────────────────────┐
│  1. Signal Shutdown                      │
│     Block new persistence operations     │
├─────────────────────────────────────────┤
│  ── Wait 5 seconds ──                   │
├─────────────────────────────────────────┤
│  2. Stop Autoload Service               │
│     Stop file monitoring & processing    │
├─────────────────────────────────────────┤
│  ── Wait 5 seconds ──                   │
├─────────────────────────────────────────┤
│  3. Stop Redis Protocol Server          │
│     Reject new client connections        │
├─────────────────────────────────────────┤
│  ── Wait 5 seconds ──                   │
├─────────────────────────────────────────┤
│  4. Stop Event Publishing               │
│     Flush queues, close connections      │
├─────────────────────────────────────────┤
│  ── Wait 5 seconds ──                   │
├─────────────────────────────────────────┤
│  5. Persist Cache Data                  │
│     Save all entries to persistence      │
├─────────────────────────────────────────┤
│  ── Wait 5 seconds ──                   │
├─────────────────────────────────────────┤
│  6. Close Persistence Store             │
│     Close RocksDB/SQLite handles         │
└─────────────────────────────────────────┘
         │
         ▼
    Application Exit (~30 seconds total)</pre>
                            
                            <h4 class="mt-4">8.7 Configuration</h4>
                            <pre class="bg-light p-3 rounded">
kuber:
  base:
    datadir: ./kuberdata              # Base directory for all data
  shutdown:
    file-enabled: true                # Enable file-based shutdown
    file-path: ${kuber.base.datadir}/kuber.shutdown  # Path to shutdown signal file
    check-interval-ms: 5000           # Check interval (5 seconds)
    api-enabled: true                 # Enable REST API shutdown
    phase-delay-seconds: 5            # Delay between shutdown phases</pre>
                        </div>
                    </div>
                </section>

                <!-- 9. Event Publishing -->
                <section id="event-publishing" class="mb-5">
                    <div class="card shadow-sm">
                        <div class="card-header text-white" style="background: linear-gradient(135deg, #f59e0b 0%, #ef4444 100%);">
                            <h2 class="mb-0"><i class="fas fa-broadcast-tower me-2"></i>9. Event Publishing (v2.6.4)</h2>
                        </div>
                        <div class="card-body">
                            <p>Kuber can publish cache events (insert, update, delete) to external messaging systems asynchronously via a pluggable publisher architecture.</p>
                            
                            <h4>9.1 Supported Publishers</h4>
                            <div class="row">
                                <div class="col-md-4 mb-2"><span class="badge bg-success me-2">Kafka</span> High-throughput streaming</div>
                                <div class="col-md-4 mb-2"><span class="badge bg-warning text-dark me-2">ActiveMQ</span> Enterprise JMS</div>
                                <div class="col-md-4 mb-2"><span class="badge bg-info me-2">RabbitMQ</span> AMQP messaging</div>
                                <div class="col-md-4 mb-2"><span class="badge bg-primary me-2">IBM MQ</span> Enterprise MQ</div>
                                <div class="col-md-4 mb-2"><span class="badge bg-secondary me-2">File</span> JSON Lines output</div>
                            </div>
                            
                            <h4 class="mt-4">9.2 Publishing Architecture</h4>
                            <pre class="bg-dark text-white p-3 rounded">
CacheService.set() / delete()
         │
         │ Submit to async queue (non-blocking)
         ▼
┌─────────────────────────────┐
│  Publishing Thread Pool     │
│  (kuber-event-publisher-N)  │
└────────────┬────────────────┘
             │
             ▼
      PublisherRegistry
             │
    ┌────┬───┴───┬────┬────┐
    ▼    ▼       ▼    ▼    ▼
 Kafka  AMQ  RabbitMQ IBM  File
                      MQ</pre>

                            <h4 class="mt-4">8.3 EventPublisher Interface</h4>
                            <pre class="bg-light p-2 rounded small"><code>public interface EventPublisher {
    String getType();        // "kafka", "rabbitmq", "file"
    void initialize();       // Setup at startup
    boolean isEnabledForRegion(String region);
    void publish(String region, CachePublishingEvent event);
}</code></pre>

                            <h4 class="mt-4">7.4 Key Design Principles</h4>
                            <ul>
                                <li><strong>Interface-driven:</strong> Easy to add new publisher implementations</li>
                                <li><strong>Non-blocking:</strong> Cache operations never wait for publishing</li>
                                <li><strong>Multi-destination:</strong> One region can publish to multiple destinations</li>
                                <li><strong>Isolated failures:</strong> One publisher failing doesn't affect others</li>
                                <li><strong>Per-region config:</strong> Different destinations per region</li>
                            </ul>

                            <div class="alert alert-info mt-3">
                                <i class="fas fa-book me-2"></i>
                                <strong>Full Documentation:</strong> See <a href="/help/publishing" class="alert-link">Event Publishing Guide</a> 
                                for complete configuration reference and examples.
                            </div>
                        </div>
                    </div>
                </section>

                <!-- 10. Session & Connection Management (v2.2.0) -->
                <section id="session-management" class="mb-5">
                    <div class="card shadow-sm">
                        <div class="card-header text-white" style="background: linear-gradient(135deg, #0ea5e9 0%, #6366f1 100%);">
                            <h2 class="mb-0"><i class="fas fa-plug me-2"></i>10. Session &amp; Connection Management (v2.2.0)</h2>
                        </div>
                        <div class="card-body">
                            <p>Kuber v2.6.4 introduces comprehensive session management via the CLIENT command, allowing runtime control of connection timeouts and keepalive behavior.</p>
                            
                            <h4>10.1 Session Attributes</h4>
                            <p>Each Redis protocol session maintains the following attributes:</p>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr><th>Attribute</th><th>Description</th><th>Default</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td><code>currentRegion</code></td><td>Active region/database</td><td>default</td></tr>
                                    <tr><td><code>authenticated</code></td><td>Authentication status</td><td>false (if auth enabled)</td></tr>
                                    <tr><td><code>authUser</code></td><td>Authenticated user ID</td><td>null</td></tr>
                                    <tr><td><code>clientName</code></td><td>Client-provided name</td><td>null</td></tr>
                                    <tr><td><code>timeoutSeconds</code></td><td>Session idle timeout</td><td>300 (5 minutes)</td></tr>
                                </tbody>
                            </table>
                            
                            <h4 class="mt-4">10.2 CLIENT Command</h4>
                            <p>The CLIENT command provides runtime session management:</p>
                            <table class="table table-bordered">
                                <thead class="table-light">
                                    <tr><th>Subcommand</th><th>Syntax</th><th>Description</th></tr>
                                </thead>
                                <tbody>
                                    <tr><td><span class="badge bg-success">LIST</span></td><td><code>CLIENT LIST</code></td><td>List all connected clients</td></tr>
                                    <tr><td><span class="badge bg-success">ID</span></td><td><code>CLIENT ID</code></td><td>Get current session ID</td></tr>
                                    <tr><td><span class="badge bg-success">INFO</span></td><td><code>CLIENT INFO</code></td><td>Get current client details</td></tr>
                                    <tr><td><span class="badge bg-success">GETNAME</span></td><td><code>CLIENT GETNAME</code></td><td>Get client name</td></tr>
                                    <tr><td><span class="badge bg-success">SETNAME</span></td><td><code>CLIENT SETNAME &lt;name&gt;</code></td><td>Set client name for debugging</td></tr>
                                    <tr><td><span class="badge bg-primary">GETTIMEOUT</span></td><td><code>CLIENT GETTIMEOUT</code></td><td>Get session timeout (seconds)</td></tr>
                                    <tr><td><span class="badge bg-primary">SETTIMEOUT</span></td><td><code>CLIENT SETTIMEOUT &lt;sec&gt;</code></td><td>Set timeout (0=no timeout, 60-86400)</td></tr>
                                    <tr><td><span class="badge bg-primary">KEEPALIVE</span></td><td><code>CLIENT KEEPALIVE</code></td><td>Reset idle timer, returns PONG</td></tr>
                                </tbody>
                            </table>
                            <p class="text-muted"><span class="badge bg-success">Green</span> = Redis compatible, <span class="badge bg-primary">Blue</span> = Kuber extension</p>
                            
                            <h4 class="mt-4">10.3 Timeout Configuration</h4>
                            <pre class="bg-dark text-white p-3 rounded">
# application.properties
# Default session idle timeout (milliseconds)
kuber.network.connection-timeout-ms=300000  # 5 minutes

# Runtime adjustment via CLIENT command:
CLIENT SETTIMEOUT 3600   # 1 hour
CLIENT SETTIMEOUT 0      # No timeout (persistent connection)</pre>
                            
                            <h4 class="mt-4">10.4 Keepalive Pattern</h4>
                            <p>For long-running connections, use periodic keepalive:</p>
                            <pre class="bg-dark text-white p-3 rounded">
# Python example - send keepalive every 60 seconds
import redis
import threading

client = redis.Redis(host='localhost', port=6380, password='kub_xxx')
client.execute_command('CLIENT', 'SETTIMEOUT', '300')  # 5 min timeout

def keepalive():
    while True:
        time.sleep(60)
        client.execute_command('CLIENT', 'KEEPALIVE')

threading.Thread(target=keepalive, daemon=True).start()</pre>
                            
                            <div class="alert alert-info mt-4">
                                <i class="fas fa-info-circle me-2"></i>
                                <strong>Best Practice:</strong> Set timeout longer than your expected idle period, or use <code>CLIENT KEEPALIVE</code> 
                                periodically for connections that need to stay open indefinitely.
                            </div>
                        </div>
                    </div>
                </section>

                <!-- Navigation -->
                <div class="mt-5 text-center">
                    <a href="/help" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-2"></i>Back to Help Index
                    </a>
                    <a href="#system-internals" class="btn btn-outline-secondary ms-2">
                        <i class="fas fa-cogs me-2"></i>System Internals
                    </a>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="py-4 mt-5 border-top">
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-database me-2"></i><span th:text="${appName} ?: 'Kuber'">Kuber</span> Distributed Cache</h6>
                    <p class="text-muted small mb-0">Version 2.6.4</p>
                </div>
                <div class="col-md-6 text-end">
                    <p class="text-muted small mb-0">
                        Copyright &copy; <span th:text="${appCopyright} ?: '2025-2030'">2025-2030</span>, All Rights Reserved<br>
                        <span th:text="${appAuthor} ?: 'Ashutosh Sinha'">Ashutosh Sinha</span> | <a th:href="'mailto:' + ${appEmail}" href="mailto:ajsinha@gmail.com"><span th:text="${appEmail} ?: 'ajsinha@gmail.com'">ajsinha@gmail.com</span></a><br></p>
                </div>
            </div>
        </footer>
    </div>
</main>

<footer th:replace="~{layout :: footer}"></footer>
<th:block th:replace="~{layout :: scripts}"></th:block>

</body>
</html>
