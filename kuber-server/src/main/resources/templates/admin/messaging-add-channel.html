<!DOCTYPE html>
<!--
  ~ Copyright © 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  -->
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('Add Channel')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div th:replace="~{layout :: alerts}"></div>
    <div class="container-fluid py-4">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/admin"><i class="fas fa-cog me-1"></i>Admin</a></li>
                <li class="breadcrumb-item"><a href="/admin/messaging">Request/Response</a></li>
                <li class="breadcrumb-item active">Add Channel</li>
            </ol>
        </nav>

        <h1 class="display-6 mb-4"><i class="fas fa-plus-circle me-3 text-primary"></i>Add Request/Response Channel</h1>

        <div id="alertArea"></div>

        <!-- Architecture Banner -->
        <div class="alert alert-info border mb-4">
            <i class="fas fa-project-diagram text-primary me-2"></i>
            <strong>How it works:</strong> A channel links a broker from the
            <a href="/admin/brokers" class="alert-link">Broker Registry</a> to one or more request topics.
            Kuber listens for cache operation messages on these topics and publishes responses.
            Broker connections are defined <em>centrally</em> &mdash; channels inherit them by name.
            If you need a new broker, <a href="/admin/brokers/add" class="alert-link">add one to the registry</a> first.
        </div>

        <!-- Broker Selection -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white"><h5 class="mb-0"><i class="fas fa-server me-2"></i>Select Broker from Registry</h5></div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Choose an existing broker from the <a href="/admin/brokers">Broker Registry</a>.
                    The channel will inherit that broker's connection settings automatically.
                    Changes to the broker in the registry are applied on next restart.
                </p>
                <div class="row">
                    <div class="col-md-5">
                        <label class="form-label">Broker <span class="text-danger">*</span></label>
                        <select id="selectedBroker" class="form-select" onchange="onBrokerSelected()">
                            <option value="">Select a broker...</option>
                            <th:block th:each="b : ${availableBrokers}">
                                <option th:value="${b.name}" th:data-type="${b.type}" th:data-conn="${b.connection}"
                                        th:text="${b.name} + ' (' + ${b.type} + ')'"></option>
                            </th:block>
                        </select>
                    </div>
                    <div class="col-md-3">
                        <label class="form-label">Display Name</label>
                        <input type="text" id="displayName" class="form-control" placeholder="e.g., Production Kafka">
                    </div>
                    <div class="col-md-2">
                        <label class="form-label">Status</label>
                        <div class="form-check form-switch mt-2">
                            <input type="checkbox" id="channelEnabled" class="form-check-input" checked>
                            <label class="form-check-label" for="channelEnabled">Enabled</label>
                        </div>
                    </div>
                </div>
                <!-- Connection Info (read-only) -->
                <div id="connectionInfo" class="mt-3" style="display:none">
                    <div class="alert alert-info py-2 mb-0">
                        <i class="fas fa-info-circle me-1"></i>
                        <strong>Type:</strong> <span id="brokerTypeLabel"></span> &nbsp;|&nbsp;
                        <strong>Connection:</strong> <span id="brokerConnLabel"></span>
                    </div>
                </div>
            </div>
        </div>

        <!-- No Brokers Warning -->
        <th:block th:if="${#lists.isEmpty(availableBrokers)}">
            <div class="alert alert-warning">
                <i class="fas fa-exclamation-triangle me-2"></i>
                No brokers configured. <a href="/admin/brokers/add" class="alert-link">Add a broker</a> first, then return here to add a channel.
            </div>
        </th:block>

        <!-- Topic Configuration -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white"><h5 class="mb-0"><i class="fas fa-inbox me-2"></i>Request Topics</h5></div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Specify the topic(s) or queue(s) that Kuber will listen on for incoming cache requests.
                    Responses will be sent to the reply-to destination specified in each request message.
                </p>
                <div id="topicContainer"></div>
                <button class="btn btn-sm btn-outline-primary mt-2" onclick="addTopicRow()"><i class="fas fa-plus me-1"></i>Add Topic</button>
            </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-flex justify-content-between mb-4">
            <a href="/admin/messaging" class="btn btn-secondary"><i class="fas fa-arrow-left me-1"></i>Back to Messaging</a>
            <button class="btn btn-primary btn-lg" onclick="saveChannel()"><i class="fas fa-save me-1"></i>Save Channel</button>
        </div>

        <!-- Quick Reference -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-book me-2"></i>Quick Reference</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3">Terminology</h6>
                        <dl>
                            <dt><i class="fas fa-plug text-info me-1"></i>Channel</dt>
                            <dd class="text-muted small mb-2">A messaging endpoint that references a broker by name and listens on one or more request topics. Stored in <code>request_response.json</code>.</dd>
                            <dt><i class="fas fa-server text-primary me-1"></i>Broker (from Registry)</dt>
                            <dd class="text-muted small mb-2">Connection defined in <code>message_brokers.json</code> via the <a href="/admin/brokers">Brokers</a> page. Channels do not define their own broker connections.</dd>
                            <dt><i class="fas fa-inbox text-success me-1"></i>Request Topic</dt>
                            <dd class="text-muted small mb-2">Topic or queue where clients publish cache operations. Kuber subscribes to these. Example: <code>ccs_cache_request</code>.</dd>
                            <dt><i class="fas fa-reply text-success me-1"></i>Response Topic</dt>
                            <dd class="text-muted small mb-2">Auto-derived: <code>ccs_cache_request</code> → <code>ccs_cache_response</code>. Kuber publishes results here.</dd>
                        </dl>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3">Topic Naming Conventions</h6>
                        <table class="table table-sm small">
                            <thead class="table-light"><tr><th>Request Topic</th><th>Auto-generated Response</th></tr></thead>
                            <tbody>
                                <tr><td><code>ccs_cache_request</code></td><td><code>ccs_cache_response</code></td></tr>
                                <tr><td><code>kuber.orders.request</code></td><td><code>kuber.orders.response</code></td></tr>
                                <tr><td><code>prod.cache.ops</code></td><td><code>prod.cache.ops.response</code></td></tr>
                            </tbody>
                        </table>
                        <p class="text-muted small">If the topic name ends with <code>_request</code> or <code>.request</code>, the response topic replaces that suffix. Otherwise, <code>.response</code> is appended.</p>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3">Example Config</h6>
                        <pre class="bg-dark text-light p-2 rounded small" style="font-size: 11px">{
  "enabled": true,
  "brokers": {
    "prod-kafka": {
      "type": "kafka",
      "enabled": true,
      "displayName": "Production",
      "connection": { ... },
      "requestTopics": [
        "ccs_cache_request"
      ]
    }
  }
}</pre>
                        <p class="text-muted small mb-0">Connection details are copied from the <a href="/admin/brokers">Broker Registry</a> when the channel is created.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page Relationships -->
        <div class="alert alert-light border mb-4">
            <i class="fas fa-link text-primary me-2"></i>
            <strong>Related pages:</strong>
            <a href="/admin/brokers" class="ms-2"><i class="fas fa-server me-1"></i>Broker Registry</a> &mdash; define broker connections.
            <a href="/admin/messaging" class="ms-3"><i class="fas fa-exchange-alt me-1"></i>Messaging Dashboard</a> &mdash; monitor channels.
            <a href="/admin/messaging/queue" class="ms-3"><i class="fas fa-list-ol me-1"></i>Request Queue</a> &mdash; inspect pending requests.
            <a href="/admin/messaging/logs" class="ms-3"><i class="fas fa-file-alt me-1"></i>Logs</a> &mdash; request/response audit trail.
        </div>
    </div>
</main>

<footer th:replace="~{layout :: footer}"></footer>

<th:block th:replace="~{layout :: scripts}"></th:block>

<script>
let topicCount = 0;

function addTopicRow() {
    const id = topicCount++;
    const html =
        '<div class="input-group mb-2" id="topic-' + id + '">' +
        '  <input type="text" class="form-control topic-input" placeholder="e.g. ccs_cache_request">' +
        '  <button class="btn btn-outline-danger" onclick="document.getElementById(\'topic-' + id + '\').remove()">' +
        '    <i class="fas fa-times"></i></button>' +
        '</div>';
    document.getElementById('topicContainer').insertAdjacentHTML('beforeend', html);
}

function onBrokerSelected() {
    const sel = document.getElementById('selectedBroker');
    const opt = sel.options[sel.selectedIndex];
    const info = document.getElementById('connectionInfo');
    if (sel.value) {
        document.getElementById('brokerTypeLabel').textContent = opt.dataset.type;
        document.getElementById('brokerConnLabel').textContent = opt.dataset.conn;
        info.style.display = '';
        // Auto-fill display name
        if (!document.getElementById('displayName').value) {
            document.getElementById('displayName').value = sel.value.replace(/-/g, ' ').replace(/\b\w/g, c => c.toUpperCase());
        }
    } else {
        info.style.display = 'none';
    }
}

function saveChannel() {
    const brokerName = document.getElementById('selectedBroker').value;
    if (!brokerName) { showAlert('danger', 'Select a broker.'); return; }

    const topics = [];
    document.querySelectorAll('.topic-input').forEach(inp => {
        const v = inp.value.trim();
        if (v) topics.push(v);
    });
    if (topics.length === 0) { showAlert('danger', 'Add at least one request topic.'); return; }

    const displayName = document.getElementById('displayName').value.trim() || brokerName;
    const enabled = document.getElementById('channelEnabled').checked;

    // First, fetch broker connection details
    fetch('/admin/api/config/brokers/' + encodeURIComponent(brokerName) + '/details')
        .then(r => r.json())
        .then(broker => {
            // Submit to messaging API with connection from broker config
            return fetch('/api/v1/messaging/brokers', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    name: brokerName,
                    displayName: displayName,
                    type: broker.type,
                    enabled: enabled,
                    connection: broker.connection,
                    requestTopics: topics
                })
            });
        })
        .then(r => r.json())
        .then(d => {
            if (d.error) { showAlert('danger', d.error); return; }
            showAlert('success', 'Channel "' + brokerName + '" with ' + topics.length + ' topic(s) added successfully.');
            setTimeout(() => window.location.href = '/admin/messaging', 1500);
        })
        .catch(e => showAlert('danger', 'Error: ' + e));
}

function showAlert(type, msg) {
    document.getElementById('alertArea').innerHTML =
        '<div class="alert alert-' + type + ' alert-dismissible fade show">' +
        '<i class="fas fa-' + (type === 'success' ? 'check-circle' : 'exclamation-triangle') + ' me-2"></i>' +
        msg + '<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>';
    window.scrollTo(0, 0);
}

// Auto-add one topic row on load
document.addEventListener('DOMContentLoaded', function() { addTopicRow(); });
</script>

</body>
</html>
