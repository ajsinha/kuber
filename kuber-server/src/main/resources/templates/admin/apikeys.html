<!DOCTYPE html>
<!--
  ~ Copyright (c) 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  -->
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout :: head('API Keys')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div th:replace="~{layout :: alerts}"></div>
    
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h2 class="mb-0">
                    <i class="fas fa-key me-2"></i>
                    API Key Management
                </h2>
                <p class="text-muted mb-0">
                    Generate and manage API keys for programmatic access
                </p>
            </div>
            <div class="col-auto">
                <a href="/admin/apikeys/add" class="btn btn-primary">
                    <i class="fas fa-plus me-1"></i> Generate New Key
                </a>
                <form th:action="@{/admin/apikeys/reload}" method="post" class="d-inline ms-2">
                    <button type="submit" class="btn btn-outline-secondary">
                        <i class="fas fa-sync me-1"></i> Reload
                    </button>
                </form>
            </div>
        </div>
        
        <!-- New Key Alert (shows full key after generation) -->
        <div th:if="${newKeyValue}" class="alert alert-success alert-dismissible fade show" role="alert" data-dismiss-delay="30000" id="newKeyAlert">
            <h5 class="alert-heading"><i class="fas fa-check-circle me-2"></i>API Key Generated Successfully!</h5>
            <p>Your new API key <strong th:text="${newKeyName}">Key Name</strong> has been created. 
               <strong class="text-danger">Copy it now - it won't be shown again!</strong></p>
            <hr>
            <div class="input-group mb-2">
                <input type="text" class="form-control font-monospace" th:value="${newKeyValue}" id="newKeyInput" readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('newKeyInput')">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            <small class="text-muted"><i class="fas fa-clock me-1"></i>This message will disappear in <span id="keyCountdown">30</span> seconds</small>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            <script>
                (function() {
                    var seconds = 30;
                    var el = document.getElementById('keyCountdown');
                    var timer = setInterval(function() {
                        seconds--;
                        if (el) el.textContent = seconds;
                        if (seconds <= 0) clearInterval(timer);
                    }, 1000);
                    document.getElementById('newKeyAlert').addEventListener('closed.bs.alert', function() {
                        clearInterval(timer);
                    });
                })();
            </script>
        </div>
        
        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-key fa-2x text-primary mb-2"></i>
                        <h3 class="mb-0" th:text="${apiKeyStats.totalKeys}">0</h3>
                        <small class="text-muted">Total Keys</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h3 class="mb-0" th:text="${apiKeyStats.activeKeys}">0</h3>
                        <small class="text-muted">Active Keys</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                        <h3 class="mb-0" th:text="${apiKeyStats.expiredKeys}">0</h3>
                        <small class="text-muted">Expired Keys</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-file fa-2x text-info mb-2"></i>
                        <small class="text-muted d-block">Storage</small>
                        <small class="font-monospace" th:text="${apiKeyStats.filePath}">apikeys.json</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API Keys Table -->
        <div class="card border-0 shadow-sm">
            <div class="card-body p-0">
                <div class="table-responsive px-3 py-2" data-kuber-table="apiKeysTable" data-page-sizes="10,25,50,All" data-default-page-size="10">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4" data-sort="string">Name</th>
                                <th data-sort="string">Key ID</th>
                                <th>Key (Masked)</th>
                                <th data-sort="string">User</th>
                                <th>Roles</th>
                                <th data-sort="string">Status</th>
                                <th data-sort="date">Created</th>
                                <th data-sort="date">Last Used</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr th:each="key : ${apiKeys}" class="data-row"
                                th:data-name="${key.name}" th:data-keyid="${key.keyId}">
                                <td class="ps-4">
                                    <i class="fas fa-key me-2 text-muted"></i>
                                    <strong th:text="${key.name}">My API Key</strong>
                                </td>
                                <td>
                                    <code th:text="${key.keyId}">key_abc123</code>
                                </td>
                                <td>
                                    <code class="text-muted" th:text="${T(com.kuber.server.security.ApiKeyService).maskKeyValue(key.keyValue)}">kub_xxxx...xxxx</code>
                                </td>
                                <td th:text="${key.userId}">admin</td>
                                <td>
                                    <span th:each="role : ${key.roles}" 
                                          th:class="'badge me-1 ' + (${role == 'ADMIN'} ? 'bg-danger' : (${role == 'OPERATOR'} ? 'bg-warning text-dark' : 'bg-secondary'))"
                                          th:text="${role}">ROLE</span>
                                </td>
                                <td>
                                    <span th:if="${key.expired}" class="badge bg-danger">Expired</span>
                                    <span th:if="${!key.expired and key.active}" class="badge bg-success">Active</span>
                                    <span th:if="${!key.expired and !key.active}" class="badge bg-secondary">Revoked</span>
                                </td>
                                <td>
                                    <small th:text="${#temporals.format(key.createdAt, 'yyyy-MM-dd HH:mm')}">2025-01-01 12:00</small>
                                </td>
                                <td>
                                    <small th:if="${key.lastUsedAt}" th:text="${#temporals.format(key.lastUsedAt, 'yyyy-MM-dd HH:mm')}">2025-01-01 12:00</small>
                                    <small th:unless="${key.lastUsedAt}" class="text-muted">Never</small>
                                </td>
                                <td class="text-end pe-4">
                                    <div class="btn-group btn-group-sm">
                                        <form th:if="${key.active}" th:action="@{/admin/apikeys/{id}/revoke(id=${key.keyId})}" method="post" class="d-inline">
                                            <button type="submit" class="btn btn-outline-warning" title="Revoke">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        </form>
                                        <form th:unless="${key.active}" th:action="@{/admin/apikeys/{id}/activate(id=${key.keyId})}" method="post" class="d-inline">
                                            <button type="submit" class="btn btn-outline-success" title="Activate">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                        <button type="button" class="btn btn-outline-danger" title="Delete"
                                                onclick="confirmDelete(this)" th:data-keyid="${key.keyId}" th:data-keyname="${key.name}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(apiKeys)}" class="empty-row">
                                <td colspan="9" class="text-center py-5 text-muted">
                                    <i class="fas fa-key fa-3x mb-3 d-block"></i>
                                    No API keys found. Click "Generate New Key" to create one.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
        <!-- Related Pages -->
        <div class="alert alert-light border mb-4 mt-4">
            <i class="fas fa-link text-primary me-2"></i>
            <strong>Related:</strong>
            <a href="/admin/users" class="ms-2"><i class="fas fa-users me-1"></i>Users</a> &mdash; manage login accounts for Web UI access.
            <a href="/admin/roles" class="ms-3"><i class="fas fa-user-tag me-1"></i>Roles</a> &mdash; define permission sets assigned to keys and users.
            <a href="/help/security" class="ms-3"><i class="fas fa-shield-alt me-1"></i>Security Guide</a>
        </div>

        <!-- Glossary -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-book me-2"></i>Glossary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-3">
                        <dt class="small"><i class="fas fa-key text-warning me-1"></i>API Key</dt>
                        <dd class="text-muted small mb-2">A <code>kub_</code>-prefixed token for programmatic access. Required by all REST, Python, Java, and C# clients. Does <strong>not</strong> grant Web UI login.</dd>
                    </div>
                    <div class="col-md-3">
                        <dt class="small"><i class="fas fa-user-tag text-info me-1"></i>Roles</dt>
                        <dd class="text-muted small mb-2">Permission sets assigned to each key (e.g., <code>admin</code>, <code>reader</code>). A key inherits all permissions from its assigned roles.</dd>
                    </div>
                    <div class="col-md-3">
                        <dt class="small"><i class="fas fa-clock text-danger me-1"></i>Expiration</dt>
                        <dd class="text-muted small mb-2">Optional date after which the key is rejected. Expired keys return HTTP 401. Use for temporary access or rotation policies.</dd>
                    </div>
                    <div class="col-md-3">
                        <dt class="small"><i class="fas fa-eye-slash text-secondary me-1"></i>Show Once</dt>
                        <dd class="text-muted small mb-2">The full key is displayed only at creation time. Copy it immediately &mdash; it is stored hashed and cannot be recovered.</dd>
                    </div>
                </div>
            </div>
        </div>

        <!-- Usage Instructions -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>How to Use API Keys</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="fas fa-code me-2"></i>REST API</h6>
                        <pre class="bg-dark text-light p-2 rounded small"><code># Using X-API-Key header
curl -H "X-API-Key: kub_xxx..." \
     http://localhost:8080/api/cache/mykey

# Using Authorization header
curl -H "Authorization: ApiKey kub_xxx..." \
     http://localhost:8080/api/cache/mykey

# Using query parameter
curl "http://localhost:8080/api/cache/mykey?api_key=kub_xxx..."</code></pre>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fab fa-python me-2"></i>Python Client</h6>
                        <pre class="bg-dark text-light p-2 rounded small"><code>from kuber import KuberClient

# Connect with API key
client = KuberClient(
    host="localhost",
    port=8080,
    api_key="kub_xxx..."
)

# Use normally
client.set("key", "value")
value = client.get("key")</code></pre>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fab fa-java me-2"></i>Java Client</h6>
                        <pre class="bg-dark text-light p-2 rounded small"><code>// Connect with API key
KuberRestClient client = KuberRestClient.builder()
    .host("localhost")
    .port(8080)
    .apiKey("kub_xxx...")
    .build();

// Use normally
client.set("key", "value");
String value = client.get("key");</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Generate Key Modal -->
<form id="hiddenDeleteForm" method="post" style="display:none">
    <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
</form>

<footer th:replace="~{layout :: footer}"></footer>

<th:block th:replace="~{layout :: scripts}"></th:block>

<script th:inline="javascript">
    function copyToClipboard(inputId) {
        const input = document.getElementById(inputId);
        input.select();
        input.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(input.value);
        const btn = input.nextElementSibling;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        setTimeout(() => { btn.innerHTML = originalHtml; btn.classList.remove('btn-success'); btn.classList.add('btn-outline-secondary'); }, 2000);
    }
    
    function confirmDelete(btn) {
        const keyId = btn.dataset.keyid;
        const keyName = btn.dataset.keyname;
        if (!confirm('Delete API key "' + keyName + '"?\n\nThis cannot be undone. Any applications using this key will lose access.')) return;
        const form = document.getElementById('hiddenDeleteForm');
        form.action = '/admin/apikeys/' + keyId + '/delete';
        form.submit();
    }
</script>

</body>
</html>
