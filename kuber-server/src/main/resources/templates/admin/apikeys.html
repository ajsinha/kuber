<!DOCTYPE html>
<!--
  ~ Copyright (c) 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  -->
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout :: head('API Keys')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div th:replace="~{layout :: alerts}"></div>
    
    <div class="container-fluid py-4">
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h2 class="mb-0">
                    <i class="fas fa-key me-2"></i>
                    API Key Management
                </h2>
                <p class="text-muted mb-0">
                    Generate and manage API keys for programmatic access
                </p>
            </div>
            <div class="col-auto">
                <button type="button" class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#generateKeyModal">
                    <i class="fas fa-plus me-1"></i> Generate New Key
                </button>
                <form th:action="@{/admin/apikeys/reload}" method="post" class="d-inline ms-2">
                    <button type="submit" class="btn btn-outline-secondary">
                        <i class="fas fa-sync me-1"></i> Reload
                    </button>
                </form>
            </div>
        </div>
        
        <!-- New Key Alert (shows full key after generation) -->
        <div th:if="${newKeyValue}" class="alert alert-success alert-dismissible fade show" role="alert" data-dismiss-delay="30000" id="newKeyAlert">
            <h5 class="alert-heading"><i class="fas fa-check-circle me-2"></i>API Key Generated Successfully!</h5>
            <p>Your new API key <strong th:text="${newKeyName}">Key Name</strong> has been created. 
               <strong class="text-danger">Copy it now - it won't be shown again!</strong></p>
            <hr>
            <div class="input-group mb-2">
                <input type="text" class="form-control font-monospace" th:value="${newKeyValue}" id="newKeyInput" readonly>
                <button class="btn btn-outline-secondary" type="button" onclick="copyToClipboard('newKeyInput')">
                    <i class="fas fa-copy"></i> Copy
                </button>
            </div>
            <small class="text-muted"><i class="fas fa-clock me-1"></i>This message will disappear in <span id="keyCountdown">30</span> seconds</small>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            <script>
                (function() {
                    var seconds = 30;
                    var el = document.getElementById('keyCountdown');
                    var timer = setInterval(function() {
                        seconds--;
                        if (el) el.textContent = seconds;
                        if (seconds <= 0) clearInterval(timer);
                    }, 1000);
                    document.getElementById('newKeyAlert').addEventListener('closed.bs.alert', function() {
                        clearInterval(timer);
                    });
                })();
            </script>
        </div>
        
        <!-- Statistics -->
        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-key fa-2x text-primary mb-2"></i>
                        <h3 class="mb-0" th:text="${apiKeyStats.totalKeys}">0</h3>
                        <small class="text-muted">Total Keys</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                        <h3 class="mb-0" th:text="${apiKeyStats.activeKeys}">0</h3>
                        <small class="text-muted">Active Keys</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-clock fa-2x text-warning mb-2"></i>
                        <h3 class="mb-0" th:text="${apiKeyStats.expiredKeys}">0</h3>
                        <small class="text-muted">Expired Keys</small>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card border-0 shadow-sm">
                    <div class="card-body text-center">
                        <i class="fas fa-file fa-2x text-info mb-2"></i>
                        <small class="text-muted d-block">Storage</small>
                        <small class="font-monospace" th:text="${apiKeyStats.filePath}">apikeys.json</small>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- API Keys Table -->
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-white border-0 py-2">
                <div class="row align-items-center">
                    <div class="col-auto">
                        <div class="d-flex align-items-center">
                            <label class="me-2 text-muted small">Show:</label>
                            <select id="rowsPerPage" class="form-select form-select-sm" style="width: auto;" onchange="updateTable()">
                                <option value="10" selected>10</option>
                                <option value="25">25</option>
                                <option value="50">50</option>
                                <option value="all">All</option>
                            </select>
                            <span class="ms-2 text-muted small">entries</span>
                        </div>
                    </div>
                    <div class="col">
                        <div class="input-group input-group-sm" style="max-width: 250px;">
                            <span class="input-group-text"><i class="fas fa-search"></i></span>
                            <input type="text" id="tableSearch" class="form-control" 
                                   placeholder="Search keys..." oninput="updateTable()">
                        </div>
                    </div>
                    <div class="col-auto">
                        <span id="tableInfo" class="text-muted small"></span>
                    </div>
                </div>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0">
                        <thead class="table-light">
                            <tr>
                                <th class="ps-4" style="cursor: pointer;" onclick="sortTable(0)">
                                    Name <i class="fas fa-sort ms-1 text-muted sort-icon"></i>
                                </th>
                                <th>Key ID</th>
                                <th>Key (Masked)</th>
                                <th>User</th>
                                <th>Roles</th>
                                <th>Status</th>
                                <th>Created</th>
                                <th>Last Used</th>
                                <th class="text-end pe-4">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <tr th:each="key : ${apiKeys}" class="data-row"
                                th:data-name="${key.name}" th:data-keyid="${key.keyId}">
                                <td class="ps-4">
                                    <i class="fas fa-key me-2 text-muted"></i>
                                    <strong th:text="${key.name}">My API Key</strong>
                                </td>
                                <td>
                                    <code th:text="${key.keyId}">key_abc123</code>
                                </td>
                                <td>
                                    <code class="text-muted" th:text="${T(com.kuber.server.security.ApiKeyService).maskKeyValue(key.keyValue)}">kub_xxxx...xxxx</code>
                                </td>
                                <td th:text="${key.userId}">admin</td>
                                <td>
                                    <span th:each="role : ${key.roles}" 
                                          th:class="'badge me-1 ' + (${role == 'ADMIN'} ? 'bg-danger' : (${role == 'OPERATOR'} ? 'bg-warning text-dark' : 'bg-secondary'))"
                                          th:text="${role}">ROLE</span>
                                </td>
                                <td>
                                    <span th:if="${key.expired}" class="badge bg-danger">Expired</span>
                                    <span th:if="${!key.expired and key.active}" class="badge bg-success">Active</span>
                                    <span th:if="${!key.expired and !key.active}" class="badge bg-secondary">Revoked</span>
                                </td>
                                <td>
                                    <small th:text="${#temporals.format(key.createdAt, 'yyyy-MM-dd HH:mm')}">2025-01-01 12:00</small>
                                </td>
                                <td>
                                    <small th:if="${key.lastUsedAt}" th:text="${#temporals.format(key.lastUsedAt, 'yyyy-MM-dd HH:mm')}">2025-01-01 12:00</small>
                                    <small th:unless="${key.lastUsedAt}" class="text-muted">Never</small>
                                </td>
                                <td class="text-end pe-4">
                                    <div class="btn-group btn-group-sm">
                                        <form th:if="${key.active}" th:action="@{/admin/apikeys/{id}/revoke(id=${key.keyId})}" method="post" class="d-inline">
                                            <button type="submit" class="btn btn-outline-warning" title="Revoke">
                                                <i class="fas fa-ban"></i>
                                            </button>
                                        </form>
                                        <form th:unless="${key.active}" th:action="@{/admin/apikeys/{id}/activate(id=${key.keyId})}" method="post" class="d-inline">
                                            <button type="submit" class="btn btn-outline-success" title="Activate">
                                                <i class="fas fa-check"></i>
                                            </button>
                                        </form>
                                        <button type="button" class="btn btn-outline-danger" title="Delete"
                                                onclick="confirmDelete(this)" th:data-keyid="${key.keyId}" th:data-keyname="${key.name}">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(apiKeys)}" class="empty-row">
                                <td colspan="9" class="text-center py-5 text-muted">
                                    <i class="fas fa-key fa-3x mb-3 d-block"></i>
                                    No API keys found. Click "Generate New Key" to create one.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Pagination -->
            <div class="card-footer bg-white border-0">
                <nav id="tablePagination" aria-label="Table navigation">
                    <ul class="pagination pagination-sm justify-content-end mb-0"></ul>
                </nav>
            </div>
        </div>
        
        <!-- Usage Instructions -->
        <div class="card border-0 shadow-sm mt-4">
            <div class="card-header bg-info text-white">
                <h5 class="mb-0"><i class="fas fa-info-circle me-2"></i>How to Use API Keys</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6><i class="fas fa-code me-2"></i>REST API</h6>
                        <pre class="bg-dark text-light p-2 rounded small"><code># Using X-API-Key header
curl -H "X-API-Key: kub_xxx..." \
     http://localhost:8080/api/cache/mykey

# Using Authorization header
curl -H "Authorization: ApiKey kub_xxx..." \
     http://localhost:8080/api/cache/mykey

# Using query parameter
curl "http://localhost:8080/api/cache/mykey?api_key=kub_xxx..."</code></pre>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fab fa-python me-2"></i>Python Client</h6>
                        <pre class="bg-dark text-light p-2 rounded small"><code>from kuber import KuberClient

# Connect with API key
client = KuberClient(
    host="localhost",
    port=8080,
    api_key="kub_xxx..."
)

# Use normally
client.set("key", "value")
value = client.get("key")</code></pre>
                    </div>
                    <div class="col-md-4">
                        <h6><i class="fab fa-java me-2"></i>Java Client</h6>
                        <pre class="bg-dark text-light p-2 rounded small"><code>// Connect with API key
KuberRestClient client = KuberRestClient.builder()
    .host("localhost")
    .port(8080)
    .apiKey("kub_xxx...")
    .build();

// Use normally
client.set("key", "value");
String value = client.get("key");</code></pre>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<!-- Generate Key Modal -->
<div class="modal fade" id="generateKeyModal" tabindex="-1" aria-labelledby="generateKeyModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form th:action="@{/admin/apikeys/generate}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title" id="generateKeyModalLabel">
                        <i class="fas fa-key me-2"></i>Generate New API Key
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label for="keyName" class="form-label">Key Name <span class="text-danger">*</span></label>
                        <input type="text" class="form-control" id="keyName" name="name" required
                               placeholder="e.g., Production API, CI/CD Pipeline">
                        <div class="form-text">A descriptive name to identify this key</div>
                    </div>
                    <div class="mb-3">
                        <label for="keyUser" class="form-label">Associated User <span class="text-danger">*</span></label>
                        <select class="form-select" id="keyUser" name="userId" required>
                            <option value="">Select a user...</option>
                            <option th:each="user : ${users}" th:value="${user.userId}" th:text="${user.userId + ' (' + user.fullName + ')'}">user</option>
                        </select>
                        <div class="form-text">The user account this key will act as</div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Roles</label>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="roles" value="USER" id="roleUser" checked>
                            <label class="form-check-label" for="roleUser">
                                <span class="badge bg-secondary">USER</span> - Basic read/write access
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="roles" value="OPERATOR" id="roleOperator">
                            <label class="form-check-label" for="roleOperator">
                                <span class="badge bg-warning text-dark">OPERATOR</span> - Region management
                            </label>
                        </div>
                        <div class="form-check">
                            <input class="form-check-input" type="checkbox" name="roles" value="ADMIN" id="roleAdmin">
                            <label class="form-check-label" for="roleAdmin">
                                <span class="badge bg-danger">ADMIN</span> - Full administrative access
                            </label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label for="keyExpiration" class="form-label">Expiration (days)</label>
                        <input type="number" class="form-control" id="keyExpiration" name="expirationDays" 
                               min="1" max="3650" placeholder="Leave empty for no expiration">
                        <div class="form-text">Optional: Number of days until the key expires</div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-key me-1"></i> Generate Key
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteKeyModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <form id="deleteKeyForm" method="post">
                <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}"/>
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title"><i class="fas fa-exclamation-triangle me-2"></i>Delete API Key</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to permanently delete the API key <strong id="deleteKeyName"></strong>?</p>
                    <p class="text-danger mb-0"><i class="fas fa-warning me-1"></i> This action cannot be undone. Any applications using this key will lose access.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">
                        <i class="fas fa-trash me-1"></i> Delete Permanently
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

<footer th:replace="~{layout :: footer}"></footer>

<th:block th:replace="~{layout :: scripts}"></th:block>

<script th:inline="javascript">
    // Table state
    let currentPage = 1;
    let sortColumn = -1;
    let sortDirection = 'asc';
    
    function copyToClipboard(inputId) {
        const input = document.getElementById(inputId);
        input.select();
        input.setSelectionRange(0, 99999);
        navigator.clipboard.writeText(input.value);
        
        // Show feedback
        const btn = input.nextElementSibling;
        const originalHtml = btn.innerHTML;
        btn.innerHTML = '<i class="fas fa-check"></i> Copied!';
        btn.classList.remove('btn-outline-secondary');
        btn.classList.add('btn-success');
        setTimeout(() => {
            btn.innerHTML = originalHtml;
            btn.classList.remove('btn-success');
            btn.classList.add('btn-outline-secondary');
        }, 2000);
    }
    
    function confirmDelete(btn) {
        const keyId = btn.dataset.keyid;
        const keyName = btn.dataset.keyname;
        document.getElementById('deleteKeyName').textContent = keyName;
        document.getElementById('deleteKeyForm').action = '/admin/apikeys/' + keyId + '/delete';
        new bootstrap.Modal(document.getElementById('deleteKeyModal')).show();
    }
    
    function updateTable() {
        const searchTerm = document.getElementById('tableSearch').value.toLowerCase();
        const rowsPerPageSelect = document.getElementById('rowsPerPage');
        const rowsPerPage = rowsPerPageSelect.value === 'all' ? Infinity : parseInt(rowsPerPageSelect.value);
        
        const rows = Array.from(document.querySelectorAll('.data-row'));
        const emptyRow = document.querySelector('.empty-row');
        
        // Filter rows
        let visibleRows = rows.filter(row => {
            const name = (row.dataset.name || '').toLowerCase();
            const keyid = (row.dataset.keyid || '').toLowerCase();
            const text = row.textContent.toLowerCase();
            const matches = name.includes(searchTerm) || keyid.includes(searchTerm) || text.includes(searchTerm);
            return matches;
        });
        
        // Sort rows
        if (sortColumn >= 0) {
            visibleRows.sort((a, b) => {
                const aVal = a.children[sortColumn].textContent.trim().toLowerCase();
                const bVal = b.children[sortColumn].textContent.trim().toLowerCase();
                let result = aVal.localeCompare(bVal);
                return sortDirection === 'desc' ? -result : result;
            });
        }
        
        // Calculate pagination
        const totalPages = Math.ceil(visibleRows.length / rowsPerPage);
        if (currentPage > totalPages) currentPage = Math.max(1, totalPages);
        
        const startIndex = (currentPage - 1) * rowsPerPage;
        const endIndex = startIndex + rowsPerPage;
        
        // Hide all rows first
        rows.forEach(row => row.style.display = 'none');
        if (emptyRow) emptyRow.style.display = 'none';
        
        // Show filtered and paginated rows
        visibleRows.forEach((row, index) => {
            if (index >= startIndex && index < endIndex) {
                row.style.display = '';
            }
        });
        
        // Show empty message if no results
        if (visibleRows.length === 0 && emptyRow) {
            emptyRow.style.display = '';
        }
        
        // Update info text
        const infoText = visibleRows.length === 0 
            ? 'No matching keys' 
            : `Showing ${Math.min(startIndex + 1, visibleRows.length)}-${Math.min(endIndex, visibleRows.length)} of ${visibleRows.length}`;
        document.getElementById('tableInfo').textContent = infoText;
        
        // Update pagination
        updatePagination(totalPages);
    }
    
    function updatePagination(totalPages) {
        const pagination = document.querySelector('#tablePagination ul');
        pagination.innerHTML = '';
        
        if (totalPages <= 1) return;
        
        // Previous button
        const prevLi = document.createElement('li');
        prevLi.className = 'page-item' + (currentPage === 1 ? ' disabled' : '');
        prevLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage - 1}); return false;">Previous</a>`;
        pagination.appendChild(prevLi);
        
        // Page numbers
        for (let i = 1; i <= totalPages; i++) {
            if (i === 1 || i === totalPages || (i >= currentPage - 2 && i <= currentPage + 2)) {
                const li = document.createElement('li');
                li.className = 'page-item' + (i === currentPage ? ' active' : '');
                li.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${i}); return false;">${i}</a>`;
                pagination.appendChild(li);
            } else if (i === currentPage - 3 || i === currentPage + 3) {
                const li = document.createElement('li');
                li.className = 'page-item disabled';
                li.innerHTML = '<a class="page-link">...</a>';
                pagination.appendChild(li);
            }
        }
        
        // Next button
        const nextLi = document.createElement('li');
        nextLi.className = 'page-item' + (currentPage === totalPages ? ' disabled' : '');
        nextLi.innerHTML = `<a class="page-link" href="#" onclick="goToPage(${currentPage + 1}); return false;">Next</a>`;
        pagination.appendChild(nextLi);
    }
    
    function goToPage(page) {
        currentPage = page;
        updateTable();
    }
    
    function sortTable(column) {
        if (sortColumn === column) {
            sortDirection = sortDirection === 'asc' ? 'desc' : 'asc';
        } else {
            sortColumn = column;
            sortDirection = 'asc';
        }
        
        // Update sort icons
        document.querySelectorAll('.sort-icon').forEach((icon, index) => {
            if (index === column) {
                icon.className = 'fas fa-sort-' + (sortDirection === 'asc' ? 'up' : 'down') + ' ms-1';
            } else {
                icon.className = 'fas fa-sort ms-1 text-muted';
            }
        });
        
        updateTable();
    }
    
    // Initialize table
    document.addEventListener('DOMContentLoaded', function() {
        updateTable();
    });
</script>

</body>
</html>
