<!DOCTYPE html>
<!--
  ~ Copyright Â© 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  ~ Patent Pending
  -->
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('Messaging Queue')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div class="container-fluid py-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/admin"><i class="fas fa-cog me-1"></i>Admin</a></li>
                <li class="breadcrumb-item"><a href="/admin/messaging">Messaging</a></li>
                <li class="breadcrumb-item active" aria-current="page">Queue Status</li>
            </ol>
        </nav>

        <!-- Service Not Available -->
        <div th:if="${!serviceAvailable}" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Service Not Available</strong><br>
            The Request/Response Messaging service is not configured.
        </div>

        <!-- Service Available -->
        <div th:if="${serviceAvailable}">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6"><i class="fas fa-list-ol me-3 text-primary"></i>Request Queue Status</h1>
                <div>
                    <button class="btn btn-outline-warning me-2" onclick="drainQueue(10)" th:disabled="${stats.queueSize == 0}">
                        <i class="fas fa-minus-circle me-1"></i>Drain 10
                    </button>
                    <button class="btn btn-outline-danger me-2" onclick="drainQueue(0)" th:disabled="${stats.queueSize == 0}">
                        <i class="fas fa-trash me-1"></i>Drain All
                    </button>
                    <button class="btn btn-outline-secondary me-2" onclick="refreshQueue()">
                        <i class="fas fa-sync-alt me-1"></i>Refresh
                    </button>
                    <a href="/admin/messaging" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Messaging
                    </a>
                </div>
            </div>

            <!-- Queue Status Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-inbox fa-2x text-primary mb-2"></i>
                            <h3 th:text="${stats.queueSize}" id="queueSize">0</h3>
                            <p class="text-muted mb-0">In Queue</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-layer-group fa-2x text-info mb-2"></i>
                            <h3 th:text="${stats.maxQueueSize}">100</h3>
                            <p class="text-muted mb-0">Max Queue Size</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center">
                        <div class="card-body">
                            <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
                            <h3 th:text="${stats.requestsProcessed}" id="processed">0</h3>
                            <p class="text-muted mb-0">Processed</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card text-center" th:classappend="${stats.backpressureActive} ? 'border-danger' : ''">
                        <div class="card-body">
                            <i class="fas fa-pause-circle fa-2x mb-2" 
                               th:classappend="${stats.backpressureActive} ? 'text-danger' : 'text-secondary'"
                               id="backpressureIcon"></i>
                            <h3 id="backpressureStatus">
                                <span th:if="${stats.backpressureActive}" class="text-danger">ACTIVE</span>
                                <span th:unless="${stats.backpressureActive}" class="text-success">OFF</span>
                            </h3>
                            <p class="text-muted mb-0">Backpressure</p>
                            <small class="text-muted" th:if="${stats.backpressureActive}" id="backpressureDuration">
                                (<span th:text="${stats.backpressureDurationMs}">0</span> ms)
                            </small>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Secondary Stats Row -->
            <div class="row mb-4">
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-download me-2 text-info"></i>Received</span>
                                <strong th:text="${stats.requestsReceived}" id="received">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-exclamation-triangle me-2 text-warning"></i>Backpressure Events</span>
                                <strong th:text="${stats.backpressureActivations}" id="backpressureCount">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-4">
                    <div class="card text-center">
                        <div class="card-body py-2">
                            <div class="d-flex justify-content-between align-items-center">
                                <span><i class="fas fa-trash me-2 text-secondary"></i>Drained</span>
                                <strong th:text="${stats.requestsDrained}" id="drained">0</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Queue Progress -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Queue Utilization</h5>
                </div>
                <div class="card-body">
                    <div class="progress" style="height: 40px;">
                        <div class="progress-bar progress-bar-striped progress-bar-animated" 
                             role="progressbar"
                             id="queueProgress"
                             th:style="'width: ' + (${stats.queueSize} * 100 / ${stats.maxQueueSize}) + '%'"
                             th:classappend="${stats.queueSize > stats.maxQueueSize * 0.8} ? 'bg-danger' : (${stats.queueSize > stats.maxQueueSize * 0.5} ? 'bg-warning' : 'bg-success')">
                            <span th:text="${stats.queueSize} + ' / ' + ${stats.maxQueueSize} + ' requests'">0 / 100 requests</span>
                        </div>
                    </div>
                    <div class="row mt-3 text-center">
                        <div class="col-4">
                            <div class="p-2 bg-success-subtle rounded">
                                <small class="text-muted">0-50%</small><br>
                                <strong class="text-success">Normal</strong>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 bg-warning-subtle rounded">
                                <small class="text-muted">50-80%</small><br>
                                <strong class="text-warning">Elevated</strong>
                            </div>
                        </div>
                        <div class="col-4">
                            <div class="p-2 bg-danger-subtle rounded">
                                <small class="text-muted">80-100%</small><br>
                                <strong class="text-danger">Backpressure Active</strong>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Pending Requests Table -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-clock me-2"></i>Pending Requests</h5>
                    <small class="text-muted">Auto-refreshes every 5 seconds</small>
                </div>
                <div class="card-body">
                    <div th:if="${pendingRequests.isEmpty()}" class="text-center text-muted py-4">
                        <i class="fas fa-check-circle fa-3x text-success mb-3"></i>
                        <p class="mb-0">No pending requests. Queue is empty.</p>
                    </div>
                    
                    <div th:if="${!pendingRequests.isEmpty()}" class="table-responsive">
                        <table class="table table-hover" id="pendingTable">
                            <thead class="table-light">
                                <tr>
                                    <th>#</th>
                                    <th>Request Topic</th>
                                    <th>Receive Time</th>
                                    <th>Waiting</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="req : ${pendingRequests}">
                                    <td th:text="${req.position + 1}">1</td>
                                    <td>
                                        <span class="badge bg-primary" th:text="${req.topic}">topic</span>
                                    </td>
                                    <td th:text="${req.receiveTime}">2025-01-01T00:00:00Z</td>
                                    <td>
                                        <span class="badge" 
                                              th:classappend="${req.waitingMs > 5000} ? 'bg-danger' : (${req.waitingMs > 1000} ? 'bg-warning' : 'bg-success')"
                                              th:text="${req.waitingMs} + ' ms'">0 ms</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Backpressure Info -->
            <div class="alert mt-4" th:classappend="${stats.backpressureActive} ? 'alert-danger' : 'alert-info'">
                <h5><i class="fas me-2" th:classappend="${stats.backpressureActive} ? 'fa-exclamation-circle' : 'fa-info-circle'"></i>
                    <span th:if="${stats.backpressureActive}">Backpressure Currently Active!</span>
                    <span th:unless="${stats.backpressureActive}">About Backpressure</span>
                </h5>
                <p th:if="${stats.backpressureActive}" class="mb-2">
                    <strong>Message consumption from all brokers is currently paused.</strong> 
                    Messages are held at the broker until the queue drains below 50% capacity. 
                    No messages are rejected - they are simply waiting at the source broker.
                </p>
                <p class="mb-0">
                    When the queue reaches <strong>80%</strong> capacity (high water mark), message consumption 
                    from brokers is <strong>paused</strong> to prevent memory exhaustion. Messages remain safely 
                    queued at the broker until Kuber resumes consumption. Consumption resumes automatically when 
                    the queue drops to <strong>50%</strong> capacity (low water mark). 
                    <strong>No messages are ever rejected</strong> - backpressure ensures controlled flow without data loss.
                </p>
            </div>
            
            <!-- Glossary -->
            <div class="card mt-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-book me-2"></i>Glossary</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <dl>
                                <dt><i class="fas fa-inbox text-primary me-2"></i>In Queue</dt>
                                <dd class="text-muted mb-3">Number of requests currently waiting in the internal processing queue to be handled by worker threads.</dd>
                                
                                <dt><i class="fas fa-layer-group text-info me-2"></i>Max Queue Size</dt>
                                <dd class="text-muted mb-3">Maximum capacity of the internal queue, configured via <code>max_queue_depth</code> in request_response.json.</dd>
                                
                                <dt><i class="fas fa-check-circle text-success me-2"></i>Processed</dt>
                                <dd class="text-muted mb-3">Total number of requests that have been successfully dequeued and processed (includes both successful and failed operations).</dd>
                                
                                <dt><i class="fas fa-download text-info me-2"></i>Received</dt>
                                <dd class="text-muted mb-3">Total number of requests received from all message brokers since service startup.</dd>
                            </dl>
                        </div>
                        <div class="col-md-6">
                            <dl>
                                <dt><i class="fas fa-pause-circle text-danger me-2"></i>Backpressure</dt>
                                <dd class="text-muted mb-3">Flow control mechanism that pauses message consumption when queue utilization exceeds 80%. Prevents memory exhaustion while ensuring zero message loss.</dd>
                                
                                <dt><i class="fas fa-exclamation-triangle text-warning me-2"></i>Backpressure Events</dt>
                                <dd class="text-muted mb-3">Number of times backpressure has been activated since service startup. Frequent activations may indicate need for more worker threads or slower upstream systems.</dd>
                                
                                <dt><i class="fas fa-tachometer-alt text-primary me-2"></i>High Water Mark (80%)</dt>
                                <dd class="text-muted mb-3">Queue utilization threshold that triggers backpressure activation. When reached, consumption from all brokers is paused.</dd>
                                
                                <dt><i class="fas fa-tachometer-alt text-success me-2"></i>Low Water Mark (50%)</dt>
                                <dd class="text-muted mb-3">Queue utilization threshold that triggers backpressure release. When queue drops below this level, consumption from brokers resumes.</dd>
                                
                                <dt><i class="fas fa-trash text-secondary me-2"></i>Drained</dt>
                                <dd class="text-muted mb-3">Number of requests manually removed from the queue by administrators. Drained requests receive error responses.</dd>
                            </dl>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="py-4 mt-5 border-top">
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-database me-2"></i><span th:text="${appName} ?: 'Kuber'">Kuber</span> Distributed Cache</h6>
                    <p class="text-muted small mb-0">Version 1.7.8</p>
                </div>
                <div class="col-md-6 text-end">
                    <p class="text-muted small mb-0">
                        Copyright &copy; 2025-2030, All Rights Reserved<br>
                        Ashutosh Sinha | <a href="mailto:ajsinha@gmail.com">ajsinha@gmail.com</a><br>
                        <span class="badge bg-warning text-dark">Patent Pending</span>
                    </p>
                </div>
            </div>
        </footer>
    </div>
</main>

<th:block th:replace="~{layout :: scripts}"></th:block>

<script>
function drainQueue(count) {
    const msg = count === 0 ? 'Drain ALL requests from queue?' : 'Drain ' + count + ' requests from queue?';
    if (!confirm(msg + '\n\nDrained requests will receive error responses.')) return;
    
    fetch('/api/v1/messaging/queue/drain', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({count: count})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Drained ' + data.drained + ' request(s)');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function refreshQueue() {
    fetch('/api/v1/messaging/queue')
    .then(r => r.json())
    .then(data => {
        if (data.stats) {
            document.getElementById('queueSize').textContent = data.stats.queueSize;
            document.getElementById('processed').textContent = data.stats.requestsProcessed;
            document.getElementById('received').textContent = data.stats.requestsReceived;
            document.getElementById('backpressureCount').textContent = data.stats.backpressureActivations;
            document.getElementById('drained').textContent = data.stats.requestsDrained;
            
            // Update backpressure status
            const statusEl = document.getElementById('backpressureStatus');
            const iconEl = document.getElementById('backpressureIcon');
            const durationEl = document.getElementById('backpressureDuration');
            
            if (data.stats.backpressureActive) {
                statusEl.innerHTML = '<span class="text-danger">ACTIVE</span>';
                iconEl.className = 'fas fa-pause-circle fa-2x mb-2 text-danger';
                if (durationEl) {
                    durationEl.innerHTML = '(' + data.stats.backpressureDurationMs + ' ms)';
                    durationEl.style.display = 'inline';
                }
            } else {
                statusEl.innerHTML = '<span class="text-success">OFF</span>';
                iconEl.className = 'fas fa-pause-circle fa-2x mb-2 text-secondary';
                if (durationEl) {
                    durationEl.style.display = 'none';
                }
            }
            
            const pct = (data.stats.queueSize * 100 / data.stats.maxQueueSize);
            const progress = document.getElementById('queueProgress');
            progress.style.width = pct + '%';
            progress.textContent = data.stats.queueSize + ' / ' + data.stats.maxQueueSize + ' requests';
            progress.className = 'progress-bar progress-bar-striped progress-bar-animated ';
            if (pct > 80) progress.className += 'bg-danger';
            else if (pct > 50) progress.className += 'bg-warning';
            else progress.className += 'bg-success';
            
            // Update table
            const tbody = document.querySelector('#pendingTable tbody');
            if (tbody && data.pending) {
                tbody.innerHTML = '';
                if (data.pending.length === 0) {
                    tbody.innerHTML = '<tr><td colspan="4" class="text-center text-muted">No pending requests</td></tr>';
                } else {
                    data.pending.forEach((req, idx) => {
                        const waitClass = req.waitingMs > 5000 ? 'bg-danger' : (req.waitingMs > 1000 ? 'bg-warning' : 'bg-success');
                        tbody.innerHTML += `
                            <tr>
                                <td>${idx + 1}</td>
                                <td><span class="badge bg-primary">${req.topic}</span></td>
                                <td>${req.receiveTime}</td>
                                <td><span class="badge ${waitClass}">${req.waitingMs} ms</span></td>
                            </tr>
                        `;
                    });
                }
            }
        }
    })
    .catch(err => console.error('Failed to refresh queue:', err));
}

// Auto-refresh every 5 seconds
setInterval(refreshQueue, 5000);
</script>

</body>
</html>
