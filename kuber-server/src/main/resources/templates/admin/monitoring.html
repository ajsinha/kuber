<!DOCTYPE html>
<!--
  ~ Copyright Â© 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  -->
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('Monitoring')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div th:replace="~{layout :: alerts}"></div>
    
    <div class="container-fluid py-4">
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/admin}">Admin</a></li>
                <li class="breadcrumb-item active">Monitoring</li>
            </ol>
        </nav>
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h2 class="mb-0">
                <i class="fas fa-heartbeat me-2 text-danger"></i>
                Real-Time Monitoring
            </h2>
            <div class="d-flex align-items-center gap-3">
                <div class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" id="autoRefresh" checked>
                    <label class="form-check-label" for="autoRefresh">Auto-refresh</label>
                </div>
                <select class="form-select form-select-sm" id="refreshInterval" style="width:120px">
                    <option value="2000">2 sec</option>
                    <option value="5000" selected>5 sec</option>
                    <option value="10000">10 sec</option>
                    <option value="30000">30 sec</option>
                </select>
                <span class="badge bg-success" id="statusBadge">
                    <i class="fas fa-circle me-1" style="font-size:0.5em;vertical-align:middle"></i>Live
                </span>
                <span class="text-muted small" id="lastUpdated"></span>
            </div>
        </div>

        <!-- Row 1: Key Stats Cards -->
        <div class="row g-3 mb-4">
            <div class="col-xl-2 col-md-4 col-sm-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center py-3">
                        <i class="fas fa-clock fa-lg text-primary mb-2"></i>
                        <div class="fw-bold fs-5" id="uptime">-</div>
                        <small class="text-muted">Uptime</small>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center py-3">
                        <i class="fas fa-microchip fa-lg text-info mb-2"></i>
                        <div class="fw-bold fs-5" id="cpuLoad">-</div>
                        <small class="text-muted">CPU Usage</small>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center py-3">
                        <i class="fas fa-memory fa-lg text-success mb-2"></i>
                        <div class="fw-bold fs-5" id="heapUsage">-</div>
                        <small class="text-muted">Heap Used</small>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center py-3">
                        <i class="fas fa-database fa-lg text-warning mb-2"></i>
                        <div class="fw-bold fs-5" id="totalEntries">-</div>
                        <small class="text-muted">Cache Entries</small>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center py-3">
                        <i class="fas fa-exchange-alt fa-lg text-danger mb-2"></i>
                        <div class="fw-bold fs-5" id="totalOps">-</div>
                        <small class="text-muted">Total Ops</small>
                    </div>
                </div>
            </div>
            <div class="col-xl-2 col-md-4 col-sm-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-body text-center py-3">
                        <i class="fas fa-bullseye fa-lg text-success mb-2"></i>
                        <div class="fw-bold fs-5" id="hitRate">-</div>
                        <small class="text-muted">Hit Rate</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 2: Heap Memory + CPU/Threads Gauges -->
        <div class="row g-4 mb-4">
            <!-- Heap Memory -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3 d-flex justify-content-between align-items-center">
                        <h5 class="mb-0"><i class="fas fa-memory me-2 text-success"></i>Heap Memory</h5>
                        <button class="btn btn-sm btn-warning" onclick="triggerGC()" id="gcBtn">
                            <i class="fas fa-broom me-1"></i>Force GC
                        </button>
                    </div>
                    <div class="card-body">
                        <div class="row align-items-center">
                            <div class="col-md-5">
                                <div class="position-relative" style="width:180px;height:180px;margin:0 auto">
                                    <canvas id="heapGauge" width="180" height="180"></canvas>
                                    <div class="position-absolute top-50 start-50 translate-middle text-center">
                                        <div class="fw-bold fs-4" id="heapPercent">0%</div>
                                        <small class="text-muted" id="heapDetail">- / - MB</small>
                                    </div>
                                </div>
                            </div>
                            <div class="col-md-7">
                                <table class="table table-sm table-borderless mb-0">
                                    <tr><td class="text-muted">Used</td><td class="fw-bold text-end" id="heapUsedMb">-</td></tr>
                                    <tr><td class="text-muted">Committed</td><td class="fw-bold text-end" id="heapCommittedMb">-</td></tr>
                                    <tr><td class="text-muted">Max</td><td class="fw-bold text-end" id="heapMaxMb">-</td></tr>
                                    <tr><td class="text-muted">Non-Heap</td><td class="fw-bold text-end" id="nonHeapMb">-</td></tr>
                                    <tr><td class="text-muted">GC Count</td><td class="fw-bold text-end" id="gcCount">-</td></tr>
                                    <tr><td class="text-muted">GC Time</td><td class="fw-bold text-end" id="gcTime">-</td></tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Threads & System -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0"><i class="fas fa-cogs me-2 text-info"></i>System &amp; Threads</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3">Operating System</h6>
                                <table class="table table-sm table-borderless mb-0">
                                    <tr><td class="text-muted">OS</td><td class="fw-bold text-end" id="osName">-</td></tr>
                                    <tr><td class="text-muted">Arch</td><td class="fw-bold text-end" id="osArch">-</td></tr>
                                    <tr><td class="text-muted">CPUs</td><td class="fw-bold text-end" id="cpuCount">-</td></tr>
                                    <tr><td class="text-muted">System CPU</td><td class="fw-bold text-end" id="sysCpu">-</td></tr>
                                    <tr><td class="text-muted">Process CPU</td><td class="fw-bold text-end" id="procCpu">-</td></tr>
                                    <tr><td class="text-muted">Load Avg</td><td class="fw-bold text-end" id="loadAvg">-</td></tr>
                                </table>
                            </div>
                            <div class="col-md-6">
                                <h6 class="text-muted mb-3">Threads</h6>
                                <table class="table table-sm table-borderless mb-0">
                                    <tr><td class="text-muted">Active</td><td class="fw-bold text-end" id="threadCount">-</td></tr>
                                    <tr><td class="text-muted">Daemon</td><td class="fw-bold text-end" id="daemonCount">-</td></tr>
                                    <tr><td class="text-muted">Peak</td><td class="fw-bold text-end" id="peakThreads">-</td></tr>
                                    <tr><td class="text-muted">Total Started</td><td class="fw-bold text-end" id="totalStarted">-</td></tr>
                                </table>
                                <h6 class="text-muted mb-3 mt-3">JVM</h6>
                                <table class="table table-sm table-borderless mb-0">
                                    <tr><td class="text-muted">Java</td><td class="fw-bold text-end" id="javaVer">-</td></tr>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 3: Cache Operations + Hit/Miss -->
        <div class="row g-4 mb-4">
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0"><i class="fas fa-chart-area me-2 text-primary"></i>Cache Operations (Last 30 min)</h5>
                    </div>
                    <div class="card-body">
                        <canvas id="opsChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0"><i class="fas fa-bullseye me-2 text-success"></i>Hit / Miss Ratio</h5>
                    </div>
                    <div class="card-body d-flex align-items-center justify-content-center">
                        <div style="width:220px;height:220px;position:relative">
                            <canvas id="hitMissChart" width="220" height="220"></canvas>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 4: Operation Counters + Region Breakdown -->
        <div class="row g-4 mb-4">
            <div class="col-lg-4">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2 text-warning"></i>Operation Counters</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr><th>Operation</th><th class="text-end">Count</th></tr>
                            </thead>
                            <tbody>
                                <tr><td><i class="fas fa-arrow-down text-primary me-2"></i>GETs</td><td class="text-end fw-bold" id="opGets">0</td></tr>
                                <tr><td><i class="fas fa-arrow-up text-success me-2"></i>SETs</td><td class="text-end fw-bold" id="opSets">0</td></tr>
                                <tr><td><i class="fas fa-trash text-danger me-2"></i>DELETEs</td><td class="text-end fw-bold" id="opDeletes">0</td></tr>
                                <tr><td><i class="fas fa-check text-success me-2"></i>Hits</td><td class="text-end fw-bold" id="opHits">0</td></tr>
                                <tr><td><i class="fas fa-times text-warning me-2"></i>Misses</td><td class="text-end fw-bold" id="opMisses">0</td></tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="col-lg-8">
                <div class="card border-0 shadow-sm h-100">
                    <div class="card-header bg-white border-0 py-3">
                        <h5 class="mb-0"><i class="fas fa-layer-group me-2 text-info"></i>Region Breakdown</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover mb-0">
                                <thead class="table-light">
                                    <tr>
                                        <th>Region</th>
                                        <th class="text-end">Entries</th>
                                        <th class="text-end">GETs</th>
                                        <th class="text-end">SETs</th>
                                        <th class="text-end">DELs</th>
                                        <th class="text-end">Hits</th>
                                        <th class="text-end">Misses</th>
                                        <th>Capacity</th>
                                    </tr>
                                </thead>
                                <tbody id="regionTable">
                                    <tr><td colspan="8" class="text-center text-muted py-4"><i class="fas fa-spinner fa-spin me-2"></i>Loading...</td></tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Row 5: Quick Links -->
        <div class="row g-4 mb-4">
            <div class="col-12">
                <div class="card border-0 shadow-sm">
                    <div class="card-body py-3">
                        <div class="d-flex flex-wrap gap-2">
                            <a th:href="@{/admin/logs}" class="btn btn-outline-dark">
                                <i class="fas fa-scroll me-1"></i>Live Logs
                            </a>
                            <a th:href="@{/admin/stats}" class="btn btn-outline-primary">
                                <i class="fas fa-chart-line me-1"></i>Detailed Stats
                            </a>
                            <a th:href="@{/admin/config}" class="btn btn-outline-secondary">
                                <i class="fas fa-sliders-h me-1"></i>Configuration
                            </a>
                            <a th:href="@{/admin}" class="btn btn-outline-dark">
                                <i class="fas fa-cog me-1"></i>Admin Dashboard
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{layout :: footer}"></footer>
<th:block th:replace="~{layout :: scripts}"></th:block>

<script>
// ==================== Chart.js via CDN ====================
(function(){
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js';
    s.onload = initApp;
    document.head.appendChild(s);
})();

let opsChart = null, hitMissChart = null;
let refreshTimer = null;
let opsHistory = []; // {timestamp, gets, sets, deletes}

function initApp() {
    initOpsChart();
    initHitMissChart();
    fetchAll();
    startAutoRefresh();
    
    document.getElementById('autoRefresh').addEventListener('change', function() {
        if (this.checked) startAutoRefresh(); else stopAutoRefresh();
    });
    document.getElementById('refreshInterval').addEventListener('change', function() {
        if (document.getElementById('autoRefresh').checked) { stopAutoRefresh(); startAutoRefresh(); }
    });
}

function startAutoRefresh() {
    stopAutoRefresh();
    const interval = parseInt(document.getElementById('refreshInterval').value);
    refreshTimer = setInterval(fetchAll, interval);
    document.getElementById('statusBadge').className = 'badge bg-success';
    document.getElementById('statusBadge').innerHTML = '<i class="fas fa-circle me-1" style="font-size:0.5em;vertical-align:middle"></i>Live';
}

function stopAutoRefresh() {
    if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
    document.getElementById('statusBadge').className = 'badge bg-secondary';
    document.getElementById('statusBadge').innerHTML = '<i class="fas fa-pause me-1" style="font-size:0.5em;vertical-align:middle"></i>Paused';
}

function fetchAll() {
    fetch('/api/monitoring/overview')
        .then(r => r.json())
        .then(updateOverview)
        .catch(e => console.error('Overview fetch error:', e));
    
    fetch('/api/monitoring/metrics/activity?minutes=30')
        .then(r => r.json())
        .then(updateOpsChart)
        .catch(e => console.error('Activity fetch error:', e));
}

function updateOverview(d) {
    document.getElementById('lastUpdated').textContent = new Date().toLocaleTimeString();
    
    // Key stats
    document.getElementById('uptime').textContent = d.uptime || '-';
    document.getElementById('cpuLoad').textContent = d.os && d.os.processCpuLoad != null ? d.os.processCpuLoad + '%' : (d.os && d.os.loadAverage >= 0 ? d.os.loadAverage.toFixed(2) : 'N/A');
    document.getElementById('heapUsage').textContent = d.jvm ? d.jvm.heapUsedMb + ' MB' : '-';
    document.getElementById('totalEntries').textContent = d.cache ? numberFmt(d.cache.totalEntries) : '-';
    
    const ops = d.operations || {};
    const totalOps = (ops.totalGets || 0) + (ops.totalSets || 0) + (ops.totalDeletes || 0);
    document.getElementById('totalOps').textContent = numberFmt(totalOps);
    document.getElementById('hitRate').textContent = (ops.hitRatePercent || 0) + '%';
    
    // Heap
    if (d.jvm) {
        document.getElementById('heapPercent').textContent = d.jvm.heapUsedPercent + '%';
        document.getElementById('heapDetail').textContent = d.jvm.heapUsedMb + ' / ' + d.jvm.heapMaxMb + ' MB';
        document.getElementById('heapUsedMb').textContent = d.jvm.heapUsedMb + ' MB';
        document.getElementById('heapCommittedMb').textContent = d.jvm.heapCommittedMb + ' MB';
        document.getElementById('heapMaxMb').textContent = d.jvm.heapMaxMb + ' MB';
        document.getElementById('nonHeapMb').textContent = d.jvm.nonHeapUsedMb + ' MB';
        document.getElementById('gcCount').textContent = numberFmt(d.jvm.gcCount);
        document.getElementById('gcTime').textContent = d.jvm.gcTimeMs + ' ms';
        drawGauge('heapGauge', d.jvm.heapUsedPercent);
        document.getElementById('javaVer').textContent = d.jvm.javaVersion || '-';
    }
    
    // OS
    if (d.os) {
        document.getElementById('osName').textContent = d.os.name || '-';
        document.getElementById('osArch').textContent = d.os.arch || '-';
        document.getElementById('cpuCount').textContent = d.os.processors || '-';
        document.getElementById('sysCpu').textContent = d.os.cpuLoad != null ? d.os.cpuLoad + '%' : 'N/A';
        document.getElementById('procCpu').textContent = d.os.processCpuLoad != null ? d.os.processCpuLoad + '%' : 'N/A';
        document.getElementById('loadAvg').textContent = d.os.loadAverage >= 0 ? d.os.loadAverage.toFixed(2) : 'N/A';
    }
    
    // Threads
    if (d.threads) {
        document.getElementById('threadCount').textContent = d.threads.total;
        document.getElementById('daemonCount').textContent = d.threads.daemon;
        document.getElementById('peakThreads').textContent = d.threads.peak;
        document.getElementById('totalStarted').textContent = numberFmt(d.threads.totalStarted);
    }
    
    // Operations
    document.getElementById('opGets').textContent = numberFmt(ops.totalGets || 0);
    document.getElementById('opSets').textContent = numberFmt(ops.totalSets || 0);
    document.getElementById('opDeletes').textContent = numberFmt(ops.totalDeletes || 0);
    document.getElementById('opHits').textContent = numberFmt(ops.totalHits || 0);
    document.getElementById('opMisses').textContent = numberFmt(ops.totalMisses || 0);
    
    // Hit/Miss chart
    updateHitMissChart(ops.totalHits || 0, ops.totalMisses || 0);
    
    // Region table
    updateRegionTable(d.regionSizes || {}, d.cache || {});
}

function updateRegionTable(sizes, cache) {
    const tbody = document.getElementById('regionTable');
    const regions = Object.keys(sizes);
    if (regions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="8" class="text-center text-muted py-3">No regions found</td></tr>';
        return;
    }
    
    // Fetch per-region current minute metrics
    Promise.all(regions.map(name =>
        fetch('/api/monitoring/metrics/current/' + encodeURIComponent(name))
            .then(r => r.json())
            .catch(() => ({}))
    )).then(metricsArr => {
        let html = '';
        const maxEntries = cache.maxMemoryEntries || 100000;
        regions.forEach((name, i) => {
            const count = sizes[name] || 0;
            const pct = maxEntries > 0 ? Math.min(100, Math.round((count / maxEntries) * 100)) : 0;
            const barColor = pct > 80 ? 'bg-danger' : pct > 60 ? 'bg-warning' : 'bg-success';
            const cm = metricsArr[i] || {};
            
            html += '<tr>' +
                '<td><i class="fas fa-layer-group me-1 text-muted"></i><strong>' + name + '</strong></td>' +
                '<td class="text-end">' + numberFmt(count) + '</td>' +
                '<td class="text-end">' + numberFmt(cm.gets || 0) + '</td>' +
                '<td class="text-end">' + numberFmt(cm.sets || 0) + '</td>' +
                '<td class="text-end">' + numberFmt(cm.deletes || 0) + '</td>' +
                '<td class="text-end">' + numberFmt(cm.hits || 0) + '</td>' +
                '<td class="text-end">' + numberFmt(cm.misses || 0) + '</td>' +
                '<td style="min-width:120px"><div class="progress" style="height:18px">' +
                '<div class="progress-bar ' + barColor + '" style="width:' + pct + '%">' + pct + '%</div></div></td>' +
                '</tr>';
        });
        tbody.innerHTML = html;
    });
}

// ==================== Charts ====================

function initOpsChart() {
    const ctx = document.getElementById('opsChart').getContext('2d');
    opsChart = new Chart(ctx, {
        type: 'line',
        data: {
            labels: [],
            datasets: [
                { label: 'GETs', data: [], borderColor: '#0d6efd', backgroundColor: 'rgba(13,110,253,0.1)', fill: true, tension: 0.3, pointRadius: 0 },
                { label: 'SETs', data: [], borderColor: '#198754', backgroundColor: 'rgba(25,135,84,0.1)', fill: true, tension: 0.3, pointRadius: 0 },
                { label: 'DELETEs', data: [], borderColor: '#dc3545', backgroundColor: 'rgba(220,53,69,0.1)', fill: true, tension: 0.3, pointRadius: 0 }
            ]
        },
        options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { position: 'top', labels: { color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#8b949e' : '#666' } } },
            scales: {
                x: { display: true, title: { display: false }, ticks: { color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#8b949e' : '#666' }, grid: { color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.1)' } },
                y: { beginAtZero: true, title: { display: true, text: 'Ops/min', color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#8b949e' : '#666' }, ticks: { color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#8b949e' : '#666' }, grid: { color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? 'rgba(255,255,255,0.08)' : 'rgba(0,0,0,0.1)' } }
            },
            animation: { duration: 300 }
        }
    });
}

function initHitMissChart() {
    const ctx = document.getElementById('hitMissChart').getContext('2d');
    hitMissChart = new Chart(ctx, {
        type: 'doughnut',
        data: {
            labels: ['Hits', 'Misses'],
            datasets: [{
                data: [1, 0],
                backgroundColor: ['#198754', '#ffc107'],
                borderWidth: 2,
                borderColor: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#1e2228' : '#fff'
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
                legend: { position: 'bottom', labels: { color: document.documentElement.getAttribute('data-bs-theme') === 'dark' ? '#8b949e' : '#666' } },
                tooltip: { callbacks: { label: function(ctx) { return ctx.label + ': ' + numberFmt(ctx.raw); } } }
            },
            cutout: '65%',
            animation: { duration: 300 }
        }
    });
}

function updateOpsChart(data) {
    if (!opsChart || !data.regions) return;
    
    // Aggregate all region historical metrics
    let aggregated = {};
    Object.values(data.regions).forEach(regionHistory => {
        if (!Array.isArray(regionHistory)) return;
        regionHistory.forEach(point => {
            const ts = point.timestamp;
            if (!aggregated[ts]) aggregated[ts] = { gets: 0, sets: 0, deletes: 0 };
            aggregated[ts].gets += point.gets || 0;
            aggregated[ts].sets += point.sets || 0;
            aggregated[ts].deletes += point.deletes || 0;
        });
    });
    
    const sorted = Object.keys(aggregated).sort((a, b) => a - b);
    const labels = sorted.map(ts => {
        const d = new Date(parseInt(ts));
        return d.getHours().toString().padStart(2,'0') + ':' + d.getMinutes().toString().padStart(2,'0');
    });
    
    opsChart.data.labels = labels;
    opsChart.data.datasets[0].data = sorted.map(ts => aggregated[ts].gets);
    opsChart.data.datasets[1].data = sorted.map(ts => aggregated[ts].sets);
    opsChart.data.datasets[2].data = sorted.map(ts => aggregated[ts].deletes);
    opsChart.update();
}

function updateHitMissChart(hits, misses) {
    if (!hitMissChart) return;
    hitMissChart.data.datasets[0].data = [hits || 0, misses || 0];
    hitMissChart.update();
}

// ==================== Gauge Drawing ====================

function drawGauge(canvasId, percent) {
    const canvas = document.getElementById(canvasId);
    if (!canvas) return;
    const ctx = canvas.getContext('2d');
    const w = canvas.width, h = canvas.height;
    const cx = w / 2, cy = h / 2, r = Math.min(cx, cy) - 10;
    
    ctx.clearRect(0, 0, w, h);
    
    // Background arc
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0.75 * Math.PI, 0.25 * Math.PI);
    ctx.strokeStyle = '#e9ecef';
    ctx.lineWidth = 14;
    ctx.lineCap = 'round';
    ctx.stroke();
    
    // Value arc
    const range = 1.5 * Math.PI;
    const angle = 0.75 * Math.PI + (percent / 100) * range;
    const color = percent > 85 ? '#dc3545' : percent > 65 ? '#ffc107' : '#198754';
    ctx.beginPath();
    ctx.arc(cx, cy, r, 0.75 * Math.PI, angle);
    ctx.strokeStyle = color;
    ctx.lineWidth = 14;
    ctx.lineCap = 'round';
    ctx.stroke();
}

// ==================== Actions ====================

function triggerGC() {
    const btn = document.getElementById('gcBtn');
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i>Running...';
    fetch('/api/monitoring/gc', { method: 'POST' })
        .then(r => r.json())
        .then(d => {
            btn.innerHTML = '<i class="fas fa-check me-1"></i>Freed ' + d.freedMB + ' MB';
            btn.className = 'btn btn-sm btn-success';
            setTimeout(() => { btn.innerHTML = '<i class="fas fa-broom me-1"></i>Force GC'; btn.className = 'btn btn-sm btn-warning'; btn.disabled = false; }, 3000);
            fetchAll();
        })
        .catch(() => { btn.innerHTML = '<i class="fas fa-broom me-1"></i>Force GC'; btn.className = 'btn btn-sm btn-warning'; btn.disabled = false; });
}

function numberFmt(n) {
    if (n == null) return '0';
    return n.toLocaleString();
}
</script>

</body>
</html>
