<!DOCTYPE html>
<!--
  ~ Copyright Â© 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  ~ Patent Pending
  -->
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('Request/Response Logs')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div class="container-fluid py-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/admin"><i class="fas fa-cog me-1"></i>Admin</a></li>
                <li class="breadcrumb-item"><a href="/admin/messaging">Messaging</a></li>
                <li class="breadcrumb-item active" aria-current="page">Request/Response Logs</li>
            </ol>
        </nav>

        <!-- Service Not Available -->
        <div th:if="${!serviceAvailable || !loggerAvailable}" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Logger Not Available</strong><br>
            The Request/Response Logger is not available. Make sure messaging is configured and enabled.
        </div>

        <!-- Logger Available -->
        <div th:if="${serviceAvailable && loggerAvailable}">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6"><i class="fas fa-file-alt me-3 text-secondary"></i>Request/Response Logs</h1>
                <div>
                    <a href="/admin/messaging" class="btn btn-outline-primary">
                        <i class="fas fa-arrow-left me-1"></i>Back to Messaging
                    </a>
                </div>
            </div>

            <!-- Filters -->
            <div class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filters</h5>
                </div>
                <div class="card-body">
                    <form method="get" action="/admin/messaging/logs" class="row g-3 align-items-end">
                        <!-- Broker Selection -->
                        <div class="col-md-4">
                            <label class="form-label">Broker</label>
                            <select class="form-select" name="broker" id="brokerSelect" onchange="updateTopics()">
                                <option value="">-- Select Broker --</option>
                                <option th:each="broker : ${availableBrokers}" 
                                        th:value="${broker}" 
                                        th:text="${broker}"
                                        th:selected="${broker == selectedBroker}">
                                    broker
                                </option>
                            </select>
                        </div>
                        
                        <!-- Topic Selection -->
                        <div class="col-md-4">
                            <label class="form-label">Topic</label>
                            <select class="form-select" name="topic" id="topicSelect">
                                <option value="">-- Select Topic --</option>
                                <option th:if="${availableTopics != null}" 
                                        th:each="topic : ${availableTopics}" 
                                        th:value="${topic}" 
                                        th:text="${topic}"
                                        th:selected="${topic == selectedTopic}">
                                    topic
                                </option>
                            </select>
                        </div>
                        
                        <!-- Limit -->
                        <div class="col-md-2">
                            <label class="form-label">Results Per Page</label>
                            <select class="form-select" name="limit">
                                <option value="25" th:selected="${limit == 25}">25</option>
                                <option value="50" th:selected="${limit == 50}">50</option>
                                <option value="100" th:selected="${limit == 100}">100</option>
                                <option value="200" th:selected="${limit == 200}">200</option>
                            </select>
                        </div>
                        
                        <!-- Submit -->
                        <div class="col-md-2">
                            <button type="submit" class="btn btn-primary w-100">
                                <i class="fas fa-search me-1"></i>Load Logs
                            </button>
                        </div>
                    </form>
                </div>
            </div>
            
            <!-- No Logs Available -->
            <div th:if="${availableBrokers.isEmpty()}" class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                <strong>No Logs Available</strong><br>
                No request/response logs have been recorded yet. Process some messages through the brokers to generate logs.
            </div>

            <!-- Log Stats -->
            <div th:if="${logStats != null && !availableBrokers.isEmpty()}" class="row mb-4">
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-server fa-2x mb-2"></i>
                            <h4 th:text="${logStats.activeWriters}">0</h4>
                            <p class="mb-0">Active Writers</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <h4 th:text="${logStats.queueSize}">0</h4>
                            <p class="mb-0">Write Queue</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-file fa-2x mb-2"></i>
                            <h4 th:text="${logStats.maxMessagesPerFile}">1000</h4>
                            <p class="mb-0">Max Messages/File</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card" th:classappend="${logStats.enabled} ? 'bg-success text-white' : 'bg-secondary text-white'">
                        <div class="card-body text-center">
                            <i class="fas fa-toggle-on fa-2x mb-2"></i>
                            <h4 th:text="${logStats.enabled} ? 'Enabled' : 'Disabled'">Status</h4>
                            <p class="mb-0">Logging Status</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Messages Display -->
            <div th:if="${messages != null && !messages.isEmpty()}" class="card mb-4">
                <div class="card-header bg-light d-flex justify-content-between align-items-center">
                    <h5 class="mb-0">
                        <i class="fas fa-history me-2"></i>Messages
                        <span class="badge bg-secondary ms-2" th:text="${totalCount + ' total'}">0 total</span>
                    </h5>
                    <div>
                        <span class="text-muted">
                            Showing <span th:text="${offset + 1}">1</span> - 
                            <span th:text="${(offset + limit) < totalCount ? (offset + limit) : totalCount}">50</span> of 
                            <span th:text="${totalCount}">0</span>
                        </span>
                    </div>
                </div>
                <div class="card-body p-0">
                    <div class="table-responsive px-3 py-2" data-kuber-table="messagingLogsTable" data-page-sizes="25,50,100,All" data-default-page-size="50">
                        <table class="table table-striped table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th data-sort="date" style="width: 160px;">Timestamp</th>
                                    <th data-sort="string" style="width: 150px;">Message ID</th>
                                    <th data-sort="string" style="width: 100px;">Operation</th>
                                    <th data-sort="string" style="width: 80px;">Status</th>
                                    <th data-sort="number" style="width: 80px;">Time (ms)</th>
                                    <th>Details</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="msg, msgStat : ${messages}" class="data-row">
                                    <td>
                                        <small th:text="${#temporals.format(msg.timestamp, 'yyyy-MM-dd HH:mm:ss')}">2025-01-01 12:00:00</small>
                                    </td>
                                    <td>
                                        <code class="small" th:text="${msg.messageId}">req-123</code>
                                    </td>
                                    <td>
                                        <span class="badge" 
                                              th:classappend="${msg.operation == 'GET'} ? 'bg-info' : 
                                                              (${msg.operation == 'SET'} ? 'bg-success' : 
                                                              (${msg.operation == 'DELETE'} ? 'bg-danger' : 'bg-secondary'))"
                                              th:text="${msg.operation}">OP</span>
                                    </td>
                                    <td>
                                        <span th:if="${msg.success}" class="badge bg-success">
                                            <i class="fas fa-check"></i> OK
                                        </span>
                                        <span th:unless="${msg.success}" class="badge bg-danger">
                                            <i class="fas fa-times"></i> Fail
                                        </span>
                                    </td>
                                    <td>
                                        <span th:text="${msg.processingTimeMs}">0</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-outline-secondary" 
                                                type="button"
                                                th:data-index="${msgStat.index}"
                                                onclick="showMessageDetails(this)">
                                            <i class="fas fa-eye me-1"></i>View
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
                
                <!-- Pagination -->
                <div class="card-footer" th:if="${totalCount > limit}">
                    <nav aria-label="Log pagination">
                        <ul class="pagination mb-0 justify-content-center">
                            <!-- Previous -->
                            <li class="page-item" th:classappend="${offset == 0} ? 'disabled'">
                                <a class="page-link" 
                                   th:href="@{/admin/messaging/logs(broker=${selectedBroker}, topic=${selectedTopic}, limit=${limit}, offset=${(offset - limit) >= 0 ? (offset - limit) : 0})}">
                                    <i class="fas fa-chevron-left"></i> Previous
                                </a>
                            </li>
                            
                            <!-- Page info -->
                            <li class="page-item disabled">
                                <span class="page-link">
                                    Page <span th:text="${(offset / limit) + 1}">1</span> of 
                                    <span th:text="${(totalCount + limit - 1) / limit}">10</span>
                                </span>
                            </li>
                            
                            <!-- Next -->
                            <li class="page-item" th:classappend="${offset + limit >= totalCount} ? 'disabled'">
                                <a class="page-link" 
                                   th:href="@{/admin/messaging/logs(broker=${selectedBroker}, topic=${selectedTopic}, limit=${limit}, offset=${offset + limit})}">
                                    Next <i class="fas fa-chevron-right"></i>
                                </a>
                            </li>
                        </ul>
                    </nav>
                </div>
            </div>
            
            <!-- No Messages for Selection -->
            <div th:if="${selectedBroker != null && selectedTopic != null && (messages == null || messages.isEmpty())}" 
                 class="alert alert-info">
                <i class="fas fa-info-circle me-2"></i>
                No messages found for <strong th:text="${selectedBroker}">broker</strong> / 
                <strong th:text="${selectedTopic}">topic</strong>.
            </div>

            <!-- Log Files -->
            <div th:if="${logFiles != null && !logFiles.isEmpty()}" class="card mb-4">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-folder-open me-2"></i>Log Files</h5>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                        <table class="table table-sm">
                            <thead>
                                <tr>
                                    <th>File Name</th>
                                    <th>Messages</th>
                                    <th>Size</th>
                                    <th>Last Modified</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="file : ${logFiles}">
                                    <td><code class="small" th:text="${file.fileName}">file.json</code></td>
                                    <td th:text="${file.messageCount}">0</td>
                                    <td th:text="${#numbers.formatDecimal(file.size / 1024.0, 1, 2) + ' KB'}">0 KB</td>
                                    <td th:text="${#temporals.format(file.lastModified, 'yyyy-MM-dd HH:mm:ss')}">2025-01-01</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Available Brokers Summary -->
            <div th:if="${!availableBrokers.isEmpty() && selectedBroker == null}" class="card">
                <div class="card-header bg-light">
                    <h5 class="mb-0"><i class="fas fa-database me-2"></i>Available Log Data</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div th:each="broker : ${logStats.brokers}" class="col-md-4 mb-3">
                            <div class="card h-100">
                                <div class="card-header">
                                    <strong th:text="${broker.broker}">broker</strong>
                                    <span class="badge bg-info float-end" th:text="${broker.topicCount + ' topics'}">0 topics</span>
                                </div>
                                <div class="card-body">
                                    <div th:each="topic : ${broker.topics}" class="mb-1">
                                        <a th:href="@{/admin/messaging/logs(broker=${broker.broker}, topic=${topic})}" 
                                           class="text-decoration-none">
                                            <span class="badge bg-primary" th:text="${topic}">topic</span>
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{layout :: footer}"></footer>
<th:block th:replace="~{layout :: scripts}"></th:block>

<!-- Message Details Modal -->
<!-- Inline Message Details Panel -->
<div id="messageDetailsPanel" class="card mb-4" style="display:none">
    <div class="card-header bg-dark text-white d-flex justify-content-between">
        <h5 class="mb-0"><i class="fas fa-exchange-alt me-2"></i>Request/Response Details</h5>
        <button class="btn btn-sm btn-light" onclick="document.getElementById('messageDetailsPanel').style.display='none'"><i class="fas fa-times"></i></button>
    </div>
    <div class="card-body">
        <div class="row">
            <div class="col-md-6">
                <h6><i class="fas fa-arrow-right me-2 text-primary"></i>Request</h6>
                <pre id="requestJson" class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow: auto;"></pre>
            </div>
            <div class="col-md-6">
                <h6><i class="fas fa-arrow-left me-2 text-success"></i>Response</h6>
                <pre id="responseJson" class="bg-dark text-light p-3 rounded" style="max-height: 400px; overflow: auto;"></pre>
            </div>
        </div>
    </div>
</div>

<script th:inline="javascript">
// Messages data from server (pre-serialized JSON string)
var messagesJson = /*[[${messagesJson != null ? messagesJson : '[]'}]]*/ '[]';
var messagesData = [];
try {
    messagesData = JSON.parse(messagesJson);
} catch (e) {
    console.error('Failed to parse messages JSON:', e);
}

// Update topics when broker changes
function updateTopics() {
    const brokerSelect = document.getElementById('brokerSelect');
    const topicSelect = document.getElementById('topicSelect');
    const broker = brokerSelect.value;
    
    if (!broker) {
        topicSelect.innerHTML = '<option value="">-- Select Topic --</option>';
        return;
    }
    
    fetch('/api/v1/messaging/logs/brokers/' + encodeURIComponent(broker) + '/topics')
        .then(response => response.json())
        .then(data => {
            topicSelect.innerHTML = '<option value="">-- Select Topic --</option>';
            if (data.topics) {
                data.topics.forEach(topic => {
                    const option = document.createElement('option');
                    option.value = topic;
                    option.textContent = topic;
                    topicSelect.appendChild(option);
                });
            }
        })
        .catch(error => {
            console.error('Error loading topics:', error);
        });
}

// Show message details in inline panel
function showMessageDetails(button) {
    try {
        const index = parseInt(button.getAttribute('data-index'));
        const msg = messagesData[index];
        
        if (!msg) {
            alert('Message not found at index ' + index);
            return;
        }
        
        const requestJson = msg.request ? JSON.stringify(msg.request, null, 2) : '{}';
        const responseJson = msg.response ? JSON.stringify(msg.response, null, 2) : '{}';
        
        document.getElementById('requestJson').textContent = requestJson;
        document.getElementById('responseJson').textContent = responseJson;
        
        var panel = document.getElementById('messageDetailsPanel');
        panel.style.display = '';
        panel.scrollIntoView({ behavior: 'smooth' });
    } catch (error) {
        console.error('Error showing message details:', error);
        alert('Error displaying message details: ' + error.message);
    }
}
</script>

</body>
</html>
