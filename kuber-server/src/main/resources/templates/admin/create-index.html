<!DOCTYPE html>
<!--
  ~ Copyright (c) 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  ~ Patent Pending: Hybrid Secondary Index Architecture
  -->
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout :: head('Create Index')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div th:replace="~{layout :: alerts}"></div>
    
    <div class="container-fluid py-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/admin}">Admin</a></li>
                <li class="breadcrumb-item"><a th:href="@{/admin/indexes}">Secondary Indexes</a></li>
                <li class="breadcrumb-item active">Create Index</li>
            </ol>
        </nav>
        
        <!-- Header -->
        <div class="row mb-4">
            <div class="col">
                <h2 class="mb-0">
                    <i class="fas fa-plus-circle me-2"></i>
                    Create Secondary Index
                </h2>
                <p class="text-muted mt-2 mb-0">Define a new index to optimize JSON document searches</p>
            </div>
            <div class="col-auto">
                <a th:href="@{/help/secondary-indexing}" class="btn btn-outline-info">
                    <i class="fas fa-book me-1"></i> Full Documentation
                </a>
            </div>
        </div>
        
        <div class="row">
            <!-- Left Column: Form -->
            <div class="col-lg-6">
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Index Definition</h5>
                    </div>
                    <div class="card-body">
                        <form id="createIndexForm" th:action="@{/admin/indexes/create}" method="post">
                            
                            <!-- Region -->
                            <div class="mb-4">
                                <label for="region" class="form-label fw-bold">
                                    Region <span class="text-danger">*</span>
                                </label>
                                <select class="form-select form-select-lg" id="region" name="region" required>
                                    <option value="" disabled selected>-- Select a Region --</option>
                                    <option th:each="r : ${regions}" th:value="${r}" th:text="${r}"></option>
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Select the cache region containing the JSON documents you want to index.
                                    <span th:if="${#lists.isEmpty(regions)}" class="text-warning">
                                        <br><i class="fas fa-exclamation-triangle me-1"></i>No regions available. Create a region first.
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Field -->
                            <div class="mb-4">
                                <label for="field" class="form-label fw-bold">
                                    Field Path <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control form-control-lg" id="field" name="field" 
                                       required placeholder="e.g., status, address.city, metadata.category">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    The JSON field to index. Use dot notation for nested fields (e.g., <code>address.city</code>).
                                    For composite indexes, separate fields with commas (e.g., <code>status,city</code>).
                                </div>
                            </div>
                            
                            <!-- Index Type -->
                            <div class="mb-4">
                                <label for="type" class="form-label fw-bold">Index Type</label>
                                <select class="form-select form-select-lg" id="type" name="type">
                                    <option value="hash" selected>HASH - For equality queries (O(1) lookup)</option>
                                    <option value="btree">BTREE - For range queries (O(log n) lookup)</option>
                                    <option value="trigram">TRIGRAM - For regex/contains searches (pattern matching)</option>
                                    <option value="prefix">PREFIX - For starts-with queries (O(prefix length))</option>
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    Choose based on how you'll query this field. See the guide on the right for details.
                                </div>
                            </div>
                            
                            <!-- Description -->
                            <div class="mb-4">
                                <label for="description" class="form-label fw-bold">Description (Optional)</label>
                                <input type="text" class="form-control" id="description" name="description"
                                       placeholder="Brief description of this index's purpose">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1"></i>
                                    A helpful note for future reference. E.g., "Customer status for filtering active users"
                                </div>
                            </div>
                            
                            <!-- Options -->
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="rebuildNow" name="rebuildNow" checked>
                                    <label class="form-check-label" for="rebuildNow">
                                        <strong>Build index immediately</strong>
                                    </label>
                                </div>
                                <div class="form-text ms-4">
                                    If checked, the index will be populated with existing data right after creation.
                                    For large regions, this may take a few seconds.
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <!-- Buttons -->
                            <div class="d-flex justify-content-between">
                                <a th:href="@{/admin/indexes}" class="btn btn-outline-secondary">
                                    <i class="fas fa-arrow-left me-1"></i> Cancel
                                </a>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-plus me-1"></i> Create Index
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Guide & Tips -->
            <div class="col-lg-6">
                
                <!-- Index Type Guide -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-info text-white py-3">
                        <h5 class="mb-0"><i class="fas fa-lightbulb me-2"></i>Choosing the Right Index Type</h5>
                    </div>
                    <div class="card-body">
                        <div class="row mb-3">
                            <div class="col-md-6">
                                <div class="border rounded p-3 h-100 bg-light">
                                    <h6 class="text-primary"><i class="fas fa-hashtag me-2"></i>HASH Index</h6>
                                    <p class="small mb-2"><strong>Complexity:</strong> O(1) - Constant time</p>
                                    <p class="small mb-2"><strong>Best for:</strong></p>
                                    <ul class="small mb-2">
                                        <li>Equality comparisons: <code>=</code></li>
                                        <li>IN clauses: <code>IN [a, b, c]</code></li>
                                        <li>Low-to-medium cardinality fields</li>
                                    </ul>
                                    <p class="small mb-0"><strong>Examples:</strong></p>
                                    <ul class="small mb-0">
                                        <li><code>status = "active"</code></li>
                                        <li><code>city = "NYC"</code></li>
                                        <li><code>category IN ["A", "B"]</code></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="border rounded p-3 h-100 bg-light">
                                    <h6 class="text-success"><i class="fas fa-sort-amount-down me-2"></i>BTREE Index</h6>
                                    <p class="small mb-2"><strong>Complexity:</strong> O(log n) - Logarithmic</p>
                                    <p class="small mb-2"><strong>Best for:</strong></p>
                                    <ul class="small mb-2">
                                        <li>Range queries: <code>&gt;</code>, <code>&lt;</code>, <code>BETWEEN</code></li>
                                        <li>Ordering and sorting</li>
                                        <li>Numeric and date fields</li>
                                    </ul>
                                    <p class="small mb-0"><strong>Examples:</strong></p>
                                    <ul class="small mb-0">
                                        <li><code>age &gt; 30</code></li>
                                        <li><code>price BETWEEN 100 AND 500</code></li>
                                        <li><code>created_at &gt; "2025-01-01"</code></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="border rounded p-3 h-100" style="background-color: #fff3cd;">
                                    <h6 class="text-warning"><i class="fas fa-search me-2"></i>TRIGRAM Index <span class="badge bg-dark">v2.1.0</span></h6>
                                    <p class="small mb-2"><strong>Complexity:</strong> O(trigram matches) - Very fast for patterns</p>
                                    <p class="small mb-2"><strong>Best for:</strong></p>
                                    <ul class="small mb-2">
                                        <li>Regex patterns: <code>MATCHES ".*@gmail\.com$"</code></li>
                                        <li>Substring search: <code>CONTAINS "smith"</code></li>
                                        <li>Pattern matching on text fields</li>
                                    </ul>
                                    <p class="small mb-0"><strong>Examples:</strong></p>
                                    <ul class="small mb-0">
                                        <li><code>email MATCHES ".*@gmail\.com"</code></li>
                                        <li><code>name CONTAINS "john"</code></li>
                                        <li><code>sku MATCHES "^SKU-[0-9]{4}"</code></li>
                                    </ul>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="border rounded p-3 h-100" style="background-color: #cff4fc;">
                                    <h6 class="text-info"><i class="fas fa-tree me-2"></i>PREFIX Index <span class="badge bg-dark">v2.1.0</span></h6>
                                    <p class="small mb-2"><strong>Complexity:</strong> O(prefix length) - Ultra fast</p>
                                    <p class="small mb-2"><strong>Best for:</strong></p>
                                    <ul class="small mb-2">
                                        <li>Starts-with queries: <code>STARTS WITH "NYC-"</code></li>
                                        <li>Hierarchical codes (SKUs, regions)</li>
                                        <li>Phone numbers, zip codes</li>
                                    </ul>
                                    <p class="small mb-0"><strong>Examples:</strong></p>
                                    <ul class="small mb-0">
                                        <li><code>sku STARTS WITH "NYC-"</code></li>
                                        <li><code>phone STARTS WITH "+1-212"</code></li>
                                        <li><code>zipcode STARTS WITH "100"</code></li>
                                    </ul>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Field Path Examples -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-secondary text-white py-3">
                        <h5 class="mb-0"><i class="fas fa-code me-2"></i>Field Path Examples</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>JSON Document</th>
                                    <th>Field Path</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>{"status": "active"}</code></td>
                                    <td><code>status</code></td>
                                </tr>
                                <tr>
                                    <td><code>{"address": {"city": "NYC"}}</code></td>
                                    <td><code>address.city</code></td>
                                </tr>
                                <tr>
                                    <td><code>{"meta": {"tags": {"priority": "high"}}}</code></td>
                                    <td><code>meta.tags.priority</code></td>
                                </tr>
                                <tr>
                                    <td colspan="2" class="bg-warning-subtle">
                                        <strong>Composite Index:</strong> <code>status,city</code> - indexes both fields together
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="alert alert-warning mt-3 mb-0 small">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            <strong>Note:</strong> Array fields are NOT supported for indexing. 
                            Only scalar values (string, number, boolean) can be indexed.
                        </div>
                    </div>
                </div>
                
                <!-- Performance Tips -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-success text-white py-3">
                        <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Performance Tips</h5>
                    </div>
                    <div class="card-body">
                        <ul class="mb-0">
                            <li class="mb-2">
                                <strong>Index frequently queried fields</strong> - Only create indexes for fields 
                                that appear in WHERE clauses of your searches.
                            </li>
                            <li class="mb-2">
                                <strong>Consider cardinality</strong> - HASH indexes work best when there are 
                                relatively few unique values (e.g., status, category). High-cardinality fields 
                                (e.g., email, UUID) may not benefit as much from HASH.
                            </li>
                            <li class="mb-2">
                                <strong>Use TRIGRAM for regex patterns</strong> - If you need to search with 
                                patterns like <code>.*@gmail\.com</code>, use TRIGRAM indexes. Design patterns 
                                with 3+ character literals for best performance.
                            </li>
                            <li class="mb-2">
                                <strong>Use PREFIX for hierarchical data</strong> - SKUs, phone numbers, and 
                                zip codes that are searched with starts-with queries benefit from PREFIX indexes.
                            </li>
                            <li class="mb-2">
                                <strong>Use composite indexes wisely</strong> - If you frequently query 
                                <code>status = X AND city = Y</code>, a composite index on <code>status,city</code> 
                                is more efficient than two separate indexes.
                            </li>
                            <li class="mb-2">
                                <strong>Limit index count</strong> - Each index adds overhead to write operations. 
                                Aim for 5-10 indexes per region maximum for write-heavy workloads.
                            </li>
                            <li class="mb-0">
                                <strong>Monitor memory usage</strong> - Indexes are stored in memory. TRIGRAM 
                                indexes use more memory than HASH. Check index statistics to monitor consumption.
                            </li>
                        </ul>
                    </div>
                </div>
                
                <!-- Expected Performance -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-warning py-3">
                        <h5 class="mb-0"><i class="fas fa-chart-line me-2"></i>Expected Performance Gains</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Query Type</th>
                                    <th>Without Index</th>
                                    <th>With Index</th>
                                    <th>Speedup</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Equality (HASH)</td>
                                    <td>O(n)</td>
                                    <td>O(1)</td>
                                    <td class="text-success fw-bold">100-1000x</td>
                                </tr>
                                <tr>
                                    <td>Range (BTREE)</td>
                                    <td>O(n)</td>
                                    <td>O(log n)</td>
                                    <td class="text-success fw-bold">50-200x</td>
                                </tr>
                                <tr>
                                    <td>Multi-condition</td>
                                    <td>O(n)</td>
                                    <td>O(min)</td>
                                    <td class="text-success fw-bold">100-700x</td>
                                </tr>
                                <tr class="table-warning">
                                    <td>Regex/Contains (TRIGRAM)</td>
                                    <td>O(n)</td>
                                    <td>O(trigrams)</td>
                                    <td class="text-success fw-bold">500-1000x</td>
                                </tr>
                                <tr class="table-info">
                                    <td>Starts-with (PREFIX)</td>
                                    <td>O(n)</td>
                                    <td>O(prefix len)</td>
                                    <td class="text-success fw-bold">1000-3000x</td>
                                </tr>
                            </tbody>
                        </table>
                        <p class="small text-muted mt-2 mb-0">
                            * Performance depends on data size, selectivity, and hardware. 
                            Benchmarks based on 100,000 JSON documents.
                        </p>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{layout :: footer}"></footer>

<script th:src="@{/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js}"></script>
<script>
    // Form validation and submission
    document.getElementById('createIndexForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        
        const region = document.getElementById('region').value;
        const field = document.getElementById('field').value.trim();
        const type = document.getElementById('type').value;
        const description = document.getElementById('description').value.trim();
        const rebuildNow = document.getElementById('rebuildNow').checked;
        
        if (!region) {
            showAlert('Please select a region', 'danger');
            document.getElementById('region').focus();
            return;
        }
        
        if (!field) {
            showAlert('Field path is required', 'danger');
            document.getElementById('field').focus();
            return;
        }
        
        // Validate field path format
        if (!/^[a-zA-Z_][a-zA-Z0-9_]*(\.[a-zA-Z_][a-zA-Z0-9_]*)*(,[a-zA-Z_][a-zA-Z0-9_]*(\.[a-zA-Z_][a-zA-Z0-9_]*)*)*$/.test(field)) {
            showAlert('Invalid field path format. Use letters, numbers, underscores, and dots for nesting.', 'danger');
            document.getElementById('field').focus();
            return;
        }
        
        // Show loading state
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.disabled = true;
        submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-1"></span> Creating...';
        
        try {
            const response = await fetch(`/api/admin/indexes/${encodeURIComponent(region)}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ field, type, description, rebuildNow })
            });
            
            const data = await response.json();
            
            if (data.success) {
                showAlert('Index created successfully! Redirecting...', 'success');
                setTimeout(() => {
                    window.location.href = '/admin/indexes';
                }, 1500);
            } else {
                showAlert(data.error || 'Failed to create index', 'danger');
                submitBtn.disabled = false;
                submitBtn.innerHTML = originalText;
            }
        } catch (error) {
            showAlert('Error: ' + error.message, 'danger');
            submitBtn.disabled = false;
            submitBtn.innerHTML = originalText;
        }
    });
    
    function showAlert(message, type) {
        // Remove existing alerts
        document.querySelectorAll('.dynamic-alert').forEach(a => a.remove());
        
        const alertDiv = document.createElement('div');
        alertDiv.className = `alert alert-${type} alert-dismissible fade show dynamic-alert`;
        alertDiv.innerHTML = `
            <i class="fas fa-${type === 'success' ? 'check-circle' : 'exclamation-circle'} me-2"></i>
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        `;
        
        // Insert at the top of the form
        const form = document.getElementById('createIndexForm');
        form.insertBefore(alertDiv, form.firstChild);
        
        // Auto-dismiss after 5 seconds (except success which redirects)
        if (type !== 'success') {
            setTimeout(() => alertDiv.remove(), 5000);
        }
    }
    
    // Update hints based on index type selection
    document.getElementById('type').addEventListener('change', function() {
        const typeHints = {
            'hash': 'HASH is best for equality queries like <code>status = "active"</code> or <code>city IN ["NYC", "LA"]</code>',
            'btree': 'BTREE is best for range queries like <code>age > 30</code> or <code>date BETWEEN x AND y</code>',
            'trigram': 'TRIGRAM is best for regex and substring searches like <code>email MATCHES ".*@gmail\\.com"</code> or <code>name CONTAINS "smith"</code>',
            'prefix': 'PREFIX is best for starts-with queries like <code>sku STARTS WITH "NYC-"</code> or <code>phone STARTS WITH "+1-212"</code>'
        };
        // Could add dynamic hints here
    });
</script>

</body>
</html>
