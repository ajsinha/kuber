<!DOCTYPE html>
<!--
  ~ Copyright © 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  -->
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('Event Publishing')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div th:replace="~{layout :: alerts}"></div>
    <div class="container-fluid py-4">
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/admin"><i class="fas fa-cog me-1"></i>Admin</a></li>
                <li class="breadcrumb-item active">Event Publishing</li>
            </ol>
        </nav>

        <div class="d-flex justify-content-between align-items-center mb-4">
            <h1 class="display-6"><i class="fas fa-broadcast-tower me-3 text-primary"></i>Event Publishing</h1>
            <div>
                <a href="/admin/event-publishing/add" class="btn btn-primary"><i class="fas fa-plus me-1"></i>Add Region</a>
                <button class="btn btn-outline-secondary ms-2" onclick="toggleEditor()"><i class="fas fa-code me-1"></i>Edit JSON</button>
                <a href="/admin/brokers" class="btn btn-outline-info ms-2"><i class="fas fa-server me-1"></i>Brokers</a>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="row mb-4">
            <div class="col-md-4"><div class="card bg-primary text-white"><div class="card-body text-center"><i class="fas fa-database fa-2x mb-2"></i><h4 th:text="${regionCount}">0</h4><p class="mb-0">Regions</p></div></div></div>
            <div class="col-md-4"><div class="card bg-success text-white"><div class="card-body text-center"><i class="fas fa-check-circle fa-2x mb-2"></i><h4 th:text="${enabledCount}">0</h4><p class="mb-0">Publishing Enabled</p></div></div></div>
            <div class="col-md-4"><div class="card bg-secondary text-white"><div class="card-body text-center"><i class="fas fa-file-code fa-2x mb-2"></i><p class="mb-0 small text-truncate" th:title="${configFile}" th:text="${configFile}">path</p></div></div></div>
        </div>

        <!-- Region Table -->
        <div class="card mb-4">
            <div class="card-header bg-dark text-white d-flex justify-content-between">
                <h5 class="mb-0"><i class="fas fa-list me-2"></i>Region Publishing Configuration</h5>
                <span class="badge bg-light text-dark" th:text="${regionCount}+' region(s)'"></span>
            </div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover mb-0">
                        <thead class="table-light">
                            <tr><th>Region</th><th>Status</th><th>Destinations</th><th>Broker &rarr; Topic</th><th class="text-end">Actions</th></tr>
                        </thead>
                        <tbody>
                            <tr th:each="r : ${regions}">
                                <td><strong th:text="${r.name}"></strong></td>
                                <td>
                                    <span th:if="${r.enabled}" class="badge bg-success">Enabled</span>
                                    <span th:unless="${r.enabled}" class="badge bg-secondary">Disabled</span>
                                </td>
                                <td><span class="badge bg-primary" th:text="${r.destinationCount}">0</span></td>
                                <td>
                                    <div th:each="d : ${r.destinations}" class="mb-1">
                                        <span class="badge"
                                              th:classappend="${d.brokerType=='kafka'} ? 'bg-warning text-dark' : (${d.brokerType=='activemq'} ? 'bg-info' : (${d.brokerType=='rabbitmq'} ? 'bg-success' : (${d.brokerType=='ibmmq'} ? 'bg-danger' : 'bg-secondary')))"
                                              th:text="${d.broker}"></span>
                                        <i class="fas fa-arrow-right mx-1 text-muted small"></i>
                                        <code class="small" th:text="${d.topic}"></code>
                                    </div>
                                </td>
                                <td class="text-end text-nowrap">
                                    <button th:if="${r.enabled}" class="btn btn-sm btn-outline-warning" th:data-name="${r.name}" onclick="toggleRegion(this.dataset.name, false)" title="Disable"><i class="fas fa-pause"></i></button>
                                    <button th:unless="${r.enabled}" class="btn btn-sm btn-outline-success" th:data-name="${r.name}" onclick="toggleRegion(this.dataset.name, true)" title="Enable"><i class="fas fa-play"></i></button>
                                    <button class="btn btn-sm btn-outline-danger ms-1" th:data-name="${r.name}" onclick="deleteRegion(this.dataset.name)" title="Delete"><i class="fas fa-trash"></i></button>
                                </td>
                            </tr>
                            <tr th:if="${#lists.isEmpty(regions)}">
                                <td colspan="5" class="text-center text-muted py-4">
                                    <i class="fas fa-inbox fa-2x mb-2 d-block"></i>
                                    No regions configured. <a href="/admin/event-publishing/add">Add a region</a> to start publishing events.
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Related Pages -->
        <div class="alert alert-light border mb-4">
            <i class="fas fa-link text-primary me-2"></i>
            <strong>Related:</strong>
            <a href="/admin/brokers" class="ms-2"><i class="fas fa-server me-1"></i>Manage Brokers</a> &mdash; define broker connections used by publishing regions.
            <a href="/admin/messaging" class="ms-3"><i class="fas fa-exchange-alt me-1"></i>Request/Response</a> &mdash; bidirectional messaging over the same brokers.
        </div>

        <!-- Glossary -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-book me-2"></i>Glossary &amp; Examples</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3">Publishing Concepts</h6>
                        <dl>
                            <dt><i class="fas fa-map text-primary me-1"></i>Publishing Region</dt>
                            <dd class="text-muted small mb-2">A cache region that publishes change events (PUT, DELETE) to one or more broker destinations. The region name must match an existing cache region.</dd>
                            <dt><i class="fas fa-broadcast-tower text-success me-1"></i>Destination</dt>
                            <dd class="text-muted small mb-2">A broker + topic pair. When a key in the region changes, Kuber publishes a JSON event to every enabled destination. Example: <code>prod-kafka → inventory-changes</code>.</dd>
                            <dt><i class="fas fa-toggle-on text-success me-1"></i>Enabled</dt>
                            <dd class="text-muted small mb-2">Controls whether events are published for this region. Disabled regions still cache data normally but do not emit events.</dd>
                        </dl>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3">Event Format</h6>
                        <p class="text-muted small">Events are published as JSON with the following structure:</p>
                        <pre class="bg-dark text-light p-2 rounded small" style="font-size: 11px">{
  "event": "PUT",
  "region": "orders",
  "key": "ORD-2024-001",
  "timestamp": 1707667200000,
  "value": { ... }
}</pre>
                        <p class="text-muted small mt-2">Event types: <code>PUT</code> (create/update), <code>DELETE</code> (removal), <code>EXPIRE</code> (TTL expiration).</p>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3">Example Config</h6>
                        <pre class="bg-dark text-light p-2 rounded small mb-2" style="font-size: 11px">{
  "orders": {
    "enabled": true,
    "destinations": [
      {
        "broker": "prod-kafka",
        "topic": "order-events"
      },
      {
        "broker": "audit-file",
        "topic": "orders-audit"
      }
    ]
  }
}</pre>
                        <p class="text-muted small mb-0"><i class="fas fa-info-circle me-1"></i>Broker names must match entries on the <a href="/admin/brokers">Brokers</a> page.</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- JSON Editor -->
        <div id="jsonEditor" class="card mb-4" style="display:none">
            <div class="card-header bg-dark text-white d-flex justify-content-between">
                <h5 class="mb-0"><i class="fas fa-code me-2"></i>Edit event_publishing.json</h5>
                <div>
                    <button class="btn btn-sm btn-success" onclick="saveRawJson()"><i class="fas fa-save me-1"></i>Save</button>
                    <button class="btn btn-sm btn-secondary ms-1" onclick="toggleEditor()"><i class="fas fa-times"></i></button>
                </div>
            </div>
            <div class="card-body">
                <textarea id="configContent" class="form-control font-monospace" rows="30" spellcheck="false" style="font-size:13px;tab-size:2"></textarea>
                <div id="saveStatus" class="mt-2"></div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{layout :: footer}"></footer>

<script>
function deleteRegion(name) {
    if (!confirm('Delete region "' + name + '"? This cannot be undone.')) return;
    fetch('/admin/api/config/event-publishing/' + encodeURIComponent(name), { method: 'DELETE' })
        .then(r => r.json()).then(d => { if (d.error) alert(d.error); else location.reload(); })
        .catch(e => alert('Error: ' + e));
}

function toggleRegion(name, enable) {
    fetch('/admin/api/config/event-publishing/' + encodeURIComponent(name) + '/' + (enable ? 'enable' : 'disable'), { method: 'POST' })
        .then(r => r.json()).then(d => { if (d.error) alert(d.error); else location.reload(); })
        .catch(e => alert('Error: ' + e));
}

function toggleEditor() {
    const el = document.getElementById('jsonEditor');
    if (el.style.display === 'none') {
        el.style.display = '';
        fetch('/admin/api/config/event-publishing').then(r => r.text()).then(t => {
            try { t = JSON.stringify(JSON.parse(t), null, 2); } catch(e) {}
            document.getElementById('configContent').value = t;
        });
    } else { el.style.display = 'none'; }
}

function saveRawJson() {
    const content = document.getElementById('configContent').value;
    try { JSON.parse(content); } catch(e) {
        document.getElementById('saveStatus').innerHTML = '<div class="alert alert-danger py-1">Invalid JSON: ' + e.message + '</div>';
        return;
    }
    fetch('/admin/api/config/event-publishing-raw', { method: 'PUT', headers: {'Content-Type':'application/json'}, body: content })
        .then(r => r.json()).then(d => {
            document.getElementById('saveStatus').innerHTML = '<div class="alert alert-success py-1"><i class="fas fa-check me-1"></i>' + d.message + '</div>';
        }).catch(e => { document.getElementById('saveStatus').innerHTML = '<div class="alert alert-danger py-1">' + e + '</div>'; });
}
</script>

</body>
</html>
