<!DOCTYPE html>
<!--
  ~ Copyright (c) 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  ~ Patent Pending: Hybrid Secondary Index Architecture
  -->
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head th:replace="~{layout :: head('Create Index')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div th:replace="~{layout :: alerts}"></div>
    
    <div class="container-fluid py-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-3">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a th:href="@{/admin}">Admin</a></li>
                <li class="breadcrumb-item"><a th:href="@{/admin/indexes}">Secondary Indexes</a></li>
                <li class="breadcrumb-item active">Create Index</li>
            </ol>
        </nav>
        
        <div class="row">
            <!-- Left Column: Create Form -->
            <div class="col-lg-6">
                <!-- Header -->
                <div class="d-flex align-items-center mb-4">
                    <h2 class="mb-0">
                        <i class="fas fa-plus-circle me-2 text-primary"></i>
                        Create Secondary Index
                    </h2>
                </div>
                
                <!-- Create Form Card -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-primary text-white py-3">
                        <h5 class="mb-0"><i class="fas fa-edit me-2"></i>Index Definition</h5>
                    </div>
                    <div class="card-body">
                        <form id="createIndexForm" th:action="@{/admin/indexes/create}" method="post">
                            <!-- Region -->
                            <div class="mb-4">
                                <label for="region" class="form-label fw-bold">
                                    Region <span class="text-danger">*</span>
                                </label>
                                <select class="form-select form-select-lg" id="region" name="region" required>
                                    <option value="" disabled selected>-- Select a Region --</option>
                                    <option th:each="r : ${regions}" th:value="${r}" th:text="${r}"></option>
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1 text-info"></i>
                                    Select the cache region containing the JSON documents you want to index.
                                    <span th:if="${regions == null or #lists.isEmpty(regions)}" class="text-warning">
                                        <br><i class="fas fa-exclamation-triangle me-1"></i>No regions available. Create a region first.
                                    </span>
                                </div>
                            </div>
                            
                            <!-- Field -->
                            <div class="mb-4">
                                <label for="field" class="form-label fw-bold">
                                    Field Path <span class="text-danger">*</span>
                                </label>
                                <input type="text" class="form-control form-control-lg" id="field" name="field" 
                                       required placeholder="e.g., status, address.city, metadata.created_by">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1 text-info"></i>
                                    The JSON field to index. Use dot notation for nested fields (e.g., <code>address.city</code>).
                                    For composite indexes, separate fields with comma (e.g., <code>status,city</code>).
                                </div>
                            </div>
                            
                            <!-- Index Type -->
                            <div class="mb-4">
                                <label for="type" class="form-label fw-bold">Index Type</label>
                                <select class="form-select form-select-lg" id="type" name="type">
                                    <option value="hash" selected>HASH - Best for equality queries (O(1) lookup)</option>
                                    <option value="btree">BTREE - Best for range queries (O(log n) lookup)</option>
                                    <option value="trigram">TRIGRAM - Best for regex/contains searches (pattern matching)</option>
                                    <option value="prefix">PREFIX - Best for starts-with queries (O(prefix length))</option>
                                </select>
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1 text-info"></i>
                                    Choose based on your query patterns. See the guide on the right for details.
                                </div>
                            </div>
                            
                            <!-- Description -->
                            <div class="mb-4">
                                <label for="description" class="form-label fw-bold">Description (Optional)</label>
                                <input type="text" class="form-control" id="description" name="description" 
                                       placeholder="Brief description of this index purpose">
                                <div class="form-text">
                                    <i class="fas fa-info-circle me-1 text-info"></i>
                                    A helpful note to remember why this index was created.
                                </div>
                            </div>
                            
                            <!-- Build Options -->
                            <div class="mb-4">
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="rebuildNow" name="rebuildNow" checked>
                                    <label class="form-check-label fw-bold" for="rebuildNow">
                                        Build index immediately after creation
                                    </label>
                                </div>
                                <div class="form-text ms-4">
                                    <i class="fas fa-info-circle me-1 text-info"></i>
                                    If checked, the index will scan all existing documents and build the index right away.
                                    For large regions, this may take some time.
                                </div>
                            </div>
                            
                            <hr class="my-4">
                            
                            <!-- Buttons -->
                            <div class="d-flex justify-content-between">
                                <a th:href="@{/admin/indexes}" class="btn btn-outline-secondary btn-lg">
                                    <i class="fas fa-arrow-left me-2"></i>Cancel
                                </a>
                                <button type="submit" class="btn btn-primary btn-lg">
                                    <i class="fas fa-plus me-2"></i>Create Index
                                </button>
                            </div>
                        </form>
                    </div>
                </div>
                
                <!-- Example Indexes Card -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-secondary text-white py-3">
                        <h5 class="mb-0"><i class="fas fa-code me-2"></i>Example Index Definitions</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Region</th>
                                    <th>Field</th>
                                    <th>Type</th>
                                    <th>Use Case</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>customers</code></td>
                                    <td><code>status</code></td>
                                    <td><span class="badge bg-primary">HASH</span></td>
                                    <td><small>Filter by active/inactive</small></td>
                                </tr>
                                <tr>
                                    <td><code>customers</code></td>
                                    <td><code>age</code></td>
                                    <td><span class="badge bg-success">BTREE</span></td>
                                    <td><small>Age range queries</small></td>
                                </tr>
                                <tr>
                                    <td><code>orders</code></td>
                                    <td><code>order_date</code></td>
                                    <td><span class="badge bg-success">BTREE</span></td>
                                    <td><small>Date range filtering</small></td>
                                </tr>
                                <tr>
                                    <td><code>products</code></td>
                                    <td><code>category</code></td>
                                    <td><span class="badge bg-primary">HASH</span></td>
                                    <td><small>Category lookups</small></td>
                                </tr>
                                <tr>
                                    <td><code>customers</code></td>
                                    <td><code>email</code></td>
                                    <td><span class="badge bg-warning text-dark">TRIGRAM</span></td>
                                    <td><small>Email regex/domain search</small></td>
                                </tr>
                                <tr>
                                    <td><code>customers</code></td>
                                    <td><code>name</code></td>
                                    <td><span class="badge bg-warning text-dark">TRIGRAM</span></td>
                                    <td><small>Name contains search</small></td>
                                </tr>
                                <tr>
                                    <td><code>products</code></td>
                                    <td><code>sku</code></td>
                                    <td><span class="badge bg-info">PREFIX</span></td>
                                    <td><small>SKU prefix queries</small></td>
                                </tr>
                                <tr>
                                    <td><code>users</code></td>
                                    <td><code>address.city</code></td>
                                    <td><span class="badge bg-primary">HASH</span></td>
                                    <td><small>Nested field lookup</small></td>
                                </tr>
                                <tr>
                                    <td><code>trades</code></td>
                                    <td><code>status,symbol</code></td>
                                    <td><span class="badge bg-primary">HASH</span></td>
                                    <td><small>Composite index</small></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Right Column: Help & Guide -->
            <div class="col-lg-6">
                <!-- Quick Tips Alert -->
                <div class="alert alert-success mb-4">
                    <h5 class="alert-heading"><i class="fas fa-lightbulb me-2"></i>Quick Tips</h5>
                    <ul class="mb-0">
                        <li>Use <strong>HASH</strong> for fields with few unique values (status, type, category)</li>
                        <li>Use <strong>BTREE</strong> for numeric/date fields that need range queries</li>
                        <li>Use <strong>TRIGRAM</strong> for regex patterns or substring/contains searches</li>
                        <li>Use <strong>PREFIX</strong> for starts-with queries (SKUs, phone numbers)</li>
                        <li>Limit to <strong>5-10 indexes per region</strong> for optimal write performance</li>
                        <li>Index fields that appear frequently in your <code>WHERE</code> clauses</li>
                    </ul>
                </div>
                
                <!-- Index Type Guide -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-info text-white py-3">
                        <h5 class="mb-0"><i class="fas fa-book me-2"></i>Index Type Guide</h5>
                    </div>
                    <div class="card-body">
                        <!-- HASH Index -->
                        <div class="border rounded p-3 mb-3 bg-light">
                            <h5 class="text-primary">
                                <i class="fas fa-hashtag me-2"></i>HASH Index
                            </h5>
                            <p class="mb-2"><strong>Performance:</strong> O(1) constant time lookup</p>
                            <p class="mb-2"><strong>Best for:</strong></p>
                            <ul class="mb-2">
                                <li>Equality queries: <code>status = "active"</code></li>
                                <li>IN queries: <code>city IN ["NYC", "LA", "Chicago"]</code></li>
                                <li>Low-to-medium cardinality fields (< 1000 unique values)</li>
                            </ul>
                            <p class="mb-2"><strong>Examples:</strong></p>
                            <ul class="mb-0 small">
                                <li>status, type, category, country, is_active</li>
                                <li>customer_type, order_status, payment_method</li>
                            </ul>
                        </div>
                        
                        <!-- BTREE Index -->
                        <div class="border rounded p-3 bg-light">
                            <h5 class="text-success">
                                <i class="fas fa-sort-amount-down me-2"></i>BTREE Index
                            </h5>
                            <p class="mb-2"><strong>Performance:</strong> O(log n) logarithmic lookup</p>
                            <p class="mb-2"><strong>Best for:</strong></p>
                            <ul class="mb-2">
                                <li>Range queries: <code>age > 30</code>, <code>price BETWEEN 100 AND 500</code></li>
                                <li>Date ranges: <code>created_at > "2025-01-01"</code></li>
                                <li>Numeric comparisons with gt, gte, lt, lte operators</li>
                            </ul>
                            <p class="mb-2"><strong>Examples:</strong></p>
                            <ul class="mb-0 small">
                                <li>age, price, quantity, amount, score, rating</li>
                                <li>created_at, updated_at, order_date, birth_date</li>
                            </ul>
                        </div>
                    </div>
                </div>
                
                <!-- Field Path Syntax -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-warning text-dark py-3">
                        <h5 class="mb-0"><i class="fas fa-code me-2"></i>Field Path Syntax</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Syntax</th>
                                    <th>Description</th>
                                    <th>Example JSON</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><code>field</code></td>
                                    <td>Simple top-level field</td>
                                    <td><code>{"status": "active"}</code></td>
                                </tr>
                                <tr>
                                    <td><code>parent.child</code></td>
                                    <td>Nested field (dot notation)</td>
                                    <td><code>{"address": {"city": "NYC"}}</code></td>
                                </tr>
                                <tr>
                                    <td><code>a.b.c</code></td>
                                    <td>Deeply nested field</td>
                                    <td><code>{"a": {"b": {"c": "value"}}}</code></td>
                                </tr>
                                <tr>
                                    <td><code>field1,field2</code></td>
                                    <td>Composite index (multiple fields)</td>
                                    <td>Indexes both fields together</td>
                                </tr>
                            </tbody>
                        </table>
                        <div class="alert alert-warning mt-3 mb-0 small">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>Note:</strong> Array fields are NOT supported for indexing.
                        </div>
                    </div>
                </div>
                
                <!-- Performance Impact -->
                <div class="card border-0 shadow-sm mb-4">
                    <div class="card-header bg-danger text-white py-3">
                        <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Performance Impact</h5>
                    </div>
                    <div class="card-body">
                        <h6 class="text-success"><i class="fas fa-arrow-up me-2"></i>Query Performance (Improved)</h6>
                        <table class="table table-sm table-bordered mb-3">
                            <tr>
                                <td>Without Index</td>
                                <td>O(n) - Full table scan</td>
                                <td class="text-danger">8,450ms</td>
                            </tr>
                            <tr>
                                <td>With HASH Index</td>
                                <td>O(1) - Direct lookup</td>
                                <td class="text-success">5ms</td>
                            </tr>
                            <tr>
                                <td>With BTREE Index</td>
                                <td>O(log n) - Tree traversal</td>
                                <td class="text-success">45ms</td>
                            </tr>
                        </table>
                        <p class="small text-muted mb-3">* Benchmarks on 100,000 JSON documents</p>
                        
                        <h6 class="text-warning"><i class="fas fa-arrow-down me-2"></i>Write Performance (Overhead)</h6>
                        <ul class="small mb-0">
                            <li>Each index adds ~10-50 microseconds to INSERT/UPDATE/DELETE</li>
                            <li>More indexes = slower writes</li>
                            <li>Recommendation: Keep indexes under 10 per region</li>
                        </ul>
                    </div>
                </div>
                
                <!-- Memory Usage -->
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-dark text-white py-3">
                        <h5 class="mb-0"><i class="fas fa-memory me-2"></i>Memory Usage</h5>
                    </div>
                    <div class="card-body">
                        <table class="table table-sm table-bordered mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Index Type</th>
                                    <th>Per Document</th>
                                    <th>100K Docs</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>HASH (low cardinality)</td>
                                    <td>~50 bytes</td>
                                    <td>~5 MB</td>
                                </tr>
                                <tr>
                                    <td>HASH (high cardinality)</td>
                                    <td>~80 bytes</td>
                                    <td>~8 MB</td>
                                </tr>
                                <tr>
                                    <td>BTREE</td>
                                    <td>~100 bytes</td>
                                    <td>~10 MB</td>
                                </tr>
                                <tr>
                                    <td>COMPOSITE (2 fields)</td>
                                    <td>~120 bytes</td>
                                    <td>~12 MB</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>
</main>

<footer th:replace="~{layout :: footer}"></footer>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-none" 
     style="background: rgba(0,0,0,0.5); z-index: 9999;">
    <div class="position-absolute top-50 start-50 translate-middle text-center text-white">
        <div class="spinner-border mb-2" role="status"></div>
        <div>Creating index...</div>
    </div>
</div>

<script th:src="@{/webjars/bootstrap/5.3.3/js/bootstrap.bundle.min.js}"></script>
<script>
    document.getElementById('createIndexForm').addEventListener('submit', function(e) {
        e.preventDefault();
        
        const region = document.getElementById('region').value;
        const field = document.getElementById('field').value.trim();
        const type = document.getElementById('type').value;
        const description = document.getElementById('description').value.trim();
        const rebuildNow = document.getElementById('rebuildNow').checked;
        
        if (!region) {
            alert('Please select a region');
            document.getElementById('region').focus();
            return;
        }
        
        if (!field) {
            alert('Field path is required');
            document.getElementById('field').focus();
            return;
        }
        
        // Show loading
        document.getElementById('loadingOverlay').classList.remove('d-none');
        
        fetch(`/api/admin/indexes/${encodeURIComponent(region)}`, {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ field, type, description, rebuildNow })
        })
        .then(response => response.json())
        .then(data => {
            document.getElementById('loadingOverlay').classList.add('d-none');
            
            if (data.success) {
                // Redirect to indexes page with success message
                window.location.href = '/admin/indexes?success=Index+created+successfully';
            } else {
                alert('Error: ' + (data.error || 'Failed to create index'));
            }
        })
        .catch(error => {
            document.getElementById('loadingOverlay').classList.add('d-none');
            alert('Error: ' + error.message);
        });
    });
    
    // Auto-suggest index type based on field name
    document.getElementById('field').addEventListener('input', function() {
        const field = this.value.toLowerCase();
        const typeSelect = document.getElementById('type');
        
        // Suggest BTREE for common numeric/date fields
        const btreeFields = ['age', 'price', 'amount', 'quantity', 'date', 'time', 'score', 'rating', 'count', 'total'];
        const isBtreeField = btreeFields.some(f => field.includes(f));
        
        if (isBtreeField) {
            typeSelect.value = 'btree';
        } else {
            typeSelect.value = 'hash';
        }
    });
</script>

</body>
</html>
