<!DOCTYPE html>
<!--
  ~ Copyright © 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  ~ Patent Pending
  -->
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('Messaging Admin')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div class="container-fluid py-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/admin"><i class="fas fa-cog me-1"></i>Admin</a></li>
                <li class="breadcrumb-item active" aria-current="page">Request/Response Messaging</li>
            </ol>
        </nav>

        <!-- Service Not Available -->
        <div th:if="${!serviceAvailable}" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Service Not Available</strong><br>
            The Request/Response Messaging service is not configured. 
            Create <code>request_response.json</code> in the secure directory and restart the server.
        </div>

        <!-- Service Available -->
        <div th:if="${serviceAvailable}">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6"><i class="fas fa-exchange-alt me-3 text-primary"></i>Request/Response Messaging</h1>
                <div>
                    <!-- Global Service Toggle -->
                    <div class="btn-group me-2" role="group">
                        <button th:if="${stats.enabled}" class="btn btn-danger" onclick="disableService()">
                            <i class="fas fa-power-off me-1"></i>Disable Service
                        </button>
                        <button th:unless="${stats.enabled}" class="btn btn-success" onclick="enableService()">
                            <i class="fas fa-power-off me-1"></i>Enable Service
                        </button>
                    </div>
                    <a href="/admin/messaging/queue" class="btn btn-outline-info me-2">
                        <i class="fas fa-list-ol me-1"></i>View Queue
                    </a>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addBrokerModal">
                        <i class="fas fa-plus me-1"></i>Add Broker
                    </button>
                </div>
            </div>
            
            <!-- Global Service Status Alert -->
            <div th:unless="${stats.enabled}" class="alert alert-warning mb-4">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Service Disabled:</strong> Request/Response Messaging is globally disabled. 
                Click "Enable Service" to activate message processing for all brokers.
            </div>

            <!-- Status Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white" th:classappend="${stats.running} ? 'bg-success' : 'bg-secondary'">
                        <div class="card-body text-center">
                            <i class="fas fa-power-off fa-2x mb-2"></i>
                            <h4 th:text="${stats.running} ? 'Running' : 'Stopped'">Status</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-server fa-2x mb-2"></i>
                            <h4 th:text="${stats.activeBrokers}">0</h4>
                            <p class="mb-0">Active Brokers</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <h4 th:text="${stats.requestsReceived}">0</h4>
                            <p class="mb-0">Requests Received</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <h4 th:text="${stats.requestsProcessed}">0</h4>
                            <p class="mb-0">Requests Processed</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Queue Status -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Queue Status</h5>
                            <div>
                                <span th:if="${stats.backpressureActive}" class="badge bg-danger me-2">
                                    <i class="fas fa-pause-circle me-1"></i>Backpressure Active
                                </span>
                                <a href="/admin/messaging/queue" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-external-link-alt me-1"></i>Details
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="progress mb-3" style="height: 30px;">
                                <div class="progress-bar" role="progressbar"
                                     th:style="'width: ' + (${stats.queueSize} * 100 / ${stats.maxQueueSize}) + '%'"
                                     th:classappend="${stats.queueSize > stats.maxQueueSize * 0.8} ? 'bg-danger' : (${stats.queueSize > stats.maxQueueSize * 0.5} ? 'bg-warning' : 'bg-success')"
                                     th:text="${stats.queueSize} + ' / ' + ${stats.maxQueueSize}">
                                    0 / 100
                                </div>
                            </div>
                            <div class="row text-center">
                                <div class="col-3">
                                    <h6 class="text-warning" th:text="${stats.backpressureActivations}">0</h6>
                                    <small class="text-muted">Backpressure Events</small>
                                </div>
                                <div class="col-3">
                                    <h6 class="text-info" th:text="${stats.requestsDrained}">0</h6>
                                    <small class="text-muted">Drained</small>
                                </div>
                                <div class="col-3">
                                    <h6 class="text-danger" th:text="${stats.authFailures}">0</h6>
                                    <small class="text-muted">Auth Failures</small>
                                </div>
                                <div class="col-3">
                                    <h6 class="text-danger" th:text="${stats.processingErrors}">0</h6>
                                    <small class="text-muted">Errors</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Configuration</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span>Messaging Enabled</span>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enabledToggle"
                                           th:checked="${config != null && config.enabled}"
                                           onchange="toggleMessaging(this.checked)">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Max Queue Depth</span>
                                <span th:text="${config != null} ? ${config.maxQueueDepth} : 100">100</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Thread Pool Size</span>
                                <span th:text="${config != null} ? ${config.threadPoolSize} : 10">10</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Broker List -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-network-wired me-2"></i>Message Brokers</h5>
                </div>
                <div class="card-body">
                    <div th:if="${config == null || config.brokers.isEmpty()}" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>No brokers configured. Click "Add Broker" to get started.</p>
                    </div>
                    
                    <div th:if="${config != null && !config.brokers.isEmpty()}" class="row">
                        <div th:each="entry : ${config.brokers}" class="col-md-6 mb-3">
                            <div class="card h-100">
                                <div class="card-header d-flex justify-content-between align-items-center"
                                     th:classappend="${entry.value.enabled} ? 'bg-success-subtle' : 'bg-secondary-subtle'">
                                    <div>
                                        <i th:class="'fas me-2 ' + 
                                            (${entry.value.type == 'kafka'} ? 'fa-stream' : 
                                            (${entry.value.type == 'rabbitmq'} ? 'fa-rabbit' : 
                                            (${entry.value.type == 'activemq'} ? 'fa-bolt' : 'fa-server')))"></i>
                                        <strong th:text="${entry.value.displayName} ?: ${entry.key}">Broker</strong>
                                        <!-- Status badges -->
                                        <span th:if="${brokerStats != null && brokerStats.containsKey(entry.key) && brokerStats.get(entry.key).connected}" 
                                              class="badge bg-success ms-2">
                                            <i class="fas fa-link me-1"></i>Connected
                                        </span>
                                        <span th:if="${brokerStats != null && brokerStats.containsKey(entry.key) && brokerStats.get(entry.key).paused}" 
                                              class="badge bg-warning ms-2">
                                            <i class="fas fa-pause me-1"></i>Paused
                                        </span>
                                        <span th:if="${entry.value.enabled && (brokerStats == null || !brokerStats.containsKey(entry.key) || !brokerStats.get(entry.key).connected)}" 
                                              class="badge bg-danger ms-2">
                                            <i class="fas fa-unlink me-1"></i>Disconnected
                                        </span>
                                        <span th:if="${!entry.value.enabled}" 
                                              class="badge bg-secondary ms-2">
                                            <i class="fas fa-power-off me-1"></i>Disabled
                                        </span>
                                    </div>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-danger" 
                                                th:data-broker="${entry.key}"
                                                onclick="removeBroker(this.getAttribute('data-broker'))"
                                                title="Remove Broker">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <p class="mb-2">
                                        <small class="text-muted">Type:</small>
                                        <span class="badge bg-info" th:text="${entry.value.type}">kafka</span>
                                    </p>
                                    <p class="mb-2">
                                        <small class="text-muted">Connection:</small>
                                        <code class="small" th:text="${entry.value.connectionSummary}">localhost:9092</code>
                                    </p>
                                    
                                    <!-- Broker Control Buttons -->
                                    <div class="d-flex gap-2 mb-3 mt-3 border-top border-bottom py-3">
                                        <!-- Enable/Disable buttons -->
                                        <button th:if="${!entry.value.enabled}" 
                                                class="btn btn-success btn-sm"
                                                th:data-broker="${entry.key}"
                                                onclick="enableBroker(this.getAttribute('data-broker'))"
                                                title="Enable broker and connect">
                                            <i class="fas fa-play me-1"></i>Enable
                                        </button>
                                        <button th:if="${entry.value.enabled}" 
                                                class="btn btn-danger btn-sm"
                                                th:data-broker="${entry.key}"
                                                onclick="disableBroker(this.getAttribute('data-broker'))"
                                                title="Disable broker and disconnect">
                                            <i class="fas fa-stop me-1"></i>Disable
                                        </button>
                                        
                                        <!-- Pause/Resume buttons (only when connected) -->
                                        <button th:if="${entry.value.enabled && brokerStats != null && brokerStats.containsKey(entry.key) && brokerStats.get(entry.key).connected && !brokerStats.get(entry.key).paused}" 
                                                class="btn btn-warning btn-sm"
                                                th:data-broker="${entry.key}"
                                                onclick="pauseBroker(this.getAttribute('data-broker'))"
                                                title="Pause message consumption">
                                            <i class="fas fa-pause me-1"></i>Pause
                                        </button>
                                        <button th:if="${entry.value.enabled && brokerStats != null && brokerStats.containsKey(entry.key) && brokerStats.get(entry.key).paused}" 
                                                class="btn btn-info btn-sm"
                                                th:data-broker="${entry.key}"
                                                onclick="resumeBroker(this.getAttribute('data-broker'))"
                                                title="Resume message consumption">
                                            <i class="fas fa-play me-1"></i>Resume
                                        </button>
                                        
                                        <!-- Reconnect button (when enabled but not connected) -->
                                        <button th:if="${entry.value.enabled && (brokerStats == null || !brokerStats.containsKey(entry.key) || !brokerStats.get(entry.key).connected)}" 
                                                class="btn btn-primary btn-sm"
                                                th:data-broker="${entry.key}"
                                                onclick="enableBroker(this.getAttribute('data-broker'))"
                                                title="Reconnect to broker">
                                            <i class="fas fa-sync me-1"></i>Reconnect
                                        </button>
                                    </div>
                                    
                                    <h6>Request Topics:</h6>
                                    <div th:if="${entry.value.requestTopics.isEmpty()}" class="text-muted small">
                                        No topics configured
                                    </div>
                                    <div th:each="topic : ${entry.value.requestTopics}" class="mb-1">
                                        <span class="badge bg-primary me-1" th:text="${topic}">topic</span>
                                        <span class="badge bg-secondary" th:text="'→ ' + ${T(com.kuber.server.messaging.MessagingConfig).getResponseTopic(topic)}">response</span>
                                        <button class="btn btn-link btn-sm text-danger p-0 ms-2"
                                                th:data-broker="${entry.key}"
                                                th:data-topic="${topic}"
                                                onclick="removeTopic(this.getAttribute('data-broker'), this.getAttribute('data-topic'))">
                                            <i class="fas fa-times"></i>
                                        </button>
                                    </div>
                                    <button class="btn btn-outline-primary btn-sm mt-2"
                                            th:data-broker="${entry.key}"
                                            onclick="showAddTopicModal(this.getAttribute('data-broker'))">
                                        <i class="fas fa-plus me-1"></i>Add Topic
                                    </button>
                                    
                                    <!-- Statistics (if connected) -->
                                    <div th:if="${brokerStats != null && brokerStats.containsKey(entry.key) && brokerStats.get(entry.key).connected}" 
                                         class="mt-3 pt-3 border-top">
                                        <small class="text-muted">Statistics:</small>
                                        <div class="row mt-2">
                                            <div class="col-4 text-center">
                                                <div class="small text-muted">Received</div>
                                                <strong th:text="${brokerStats.get(entry.key).messagesReceived}">0</strong>
                                            </div>
                                            <div class="col-4 text-center">
                                                <div class="small text-muted">Published</div>
                                                <strong th:text="${brokerStats.get(entry.key).messagesPublished}">0</strong>
                                            </div>
                                            <div class="col-4 text-center">
                                                <div class="small text-muted">Errors</div>
                                                <strong class="text-danger" th:text="${brokerStats.get(entry.key).errors}">0</strong>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Failed Subscriptions -->
            <div th:if="${failedSubscriptions != null && !failedSubscriptions.isEmpty()}" class="card mb-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Failed Subscriptions</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger mb-3">
                        <strong>Warning:</strong> The following broker subscriptions failed. These brokers are not receiving messages.
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Broker</th>
                                    <th>Type</th>
                                    <th>Error</th>
                                    <th>Topics</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="failed : ${failedSubscriptions}">
                                    <td th:text="${failed.brokerName}">broker</td>
                                    <td><span class="badge bg-info" th:text="${failed.brokerType}">kafka</span></td>
                                    <td class="text-danger" th:text="${failed.errorMessage}">Error message</td>
                                    <td>
                                        <span th:each="topic : ${failed.topics}" class="badge bg-secondary me-1" th:text="${topic}">topic</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" 
                                                th:data-broker="${failed.brokerName}"
                                                onclick="retrySubscription(this.getAttribute('data-broker'))">
                                            <i class="fas fa-redo me-1"></i>Retry
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Glossary -->
        <div class="card mt-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-book me-2"></i>Glossary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3">Broker Concepts</h6>
                        <dl>
                            <dt><i class="fas fa-server text-primary me-2"></i>Message Broker</dt>
                            <dd class="text-muted mb-3">External messaging system (Kafka, ActiveMQ, RabbitMQ, IBM MQ) that delivers cache operation requests to Kuber and receives responses.</dd>
                            
                            <dt><i class="fas fa-plug text-success me-2"></i>Active Brokers</dt>
                            <dd class="text-muted mb-3">Number of message brokers currently connected and actively consuming messages. Each broker may subscribe to multiple topics.</dd>
                            
                            <dt><i class="fas fa-envelope text-info me-2"></i>Request Topic</dt>
                            <dd class="text-muted mb-3">Topic/queue where clients send cache operation requests. Each broker can subscribe to multiple request topics.</dd>
                            
                            <dt><i class="fas fa-reply text-success me-2"></i>Response Topic</dt>
                            <dd class="text-muted mb-3">Topic/queue where Kuber sends operation results. Derived from request topic by replacing "_request" suffix with "_response".</dd>
                            
                            <dt><i class="fas fa-exclamation-triangle text-danger me-2"></i>Failed Subscription</dt>
                            <dd class="text-muted mb-3">Broker that could not be connected due to network issues, authentication failures, or invalid configuration. Can be retried after fixing the underlying issue.</dd>
                            
                            <dt><i class="fas fa-play text-success me-2"></i>Enable Broker</dt>
                            <dd class="text-muted mb-3">Connect to a disabled broker and start consuming messages. Updates configuration to enabled state.</dd>
                            
                            <dt><i class="fas fa-stop text-danger me-2"></i>Disable Broker</dt>
                            <dd class="text-muted mb-3">Disconnect from a broker and stop consuming messages. Updates configuration to disabled state. Messages queue at the broker.</dd>
                            
                            <dt><i class="fas fa-pause text-warning me-2"></i>Pause Broker</dt>
                            <dd class="text-muted mb-3">Temporarily stop consuming messages while keeping the connection open. Messages queue at the broker until resumed.</dd>
                        </dl>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3">Request Statistics</h6>
                        <dl>
                            <dt><i class="fas fa-inbox text-primary me-2"></i>Requests Received</dt>
                            <dd class="text-muted mb-3">Total number of cache operation requests received from all message brokers since service startup.</dd>
                            
                            <dt><i class="fas fa-check-circle text-success me-2"></i>Requests Processed</dt>
                            <dd class="text-muted mb-3">Total number of requests dequeued and processed by worker threads. Includes both successful operations and failures.</dd>
                            
                            <dt><i class="fas fa-key text-danger me-2"></i>Auth Failures</dt>
                            <dd class="text-muted mb-3">Requests rejected due to missing, invalid, or expired API keys. Ensure clients use valid API keys generated from the Admin panel.</dd>
                            
                            <dt><i class="fas fa-times-circle text-danger me-2"></i>Processing Errors</dt>
                            <dd class="text-muted mb-3">Requests that failed during execution due to invalid operations, missing keys, or internal errors. Check server logs for details.</dd>
                            
                            <dt><i class="fas fa-trash text-secondary me-2"></i>Drained</dt>
                            <dd class="text-muted mb-3">Requests manually removed from the queue by administrators. Drained requests receive error responses indicating they were discarded.</dd>
                        </dl>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3">Flow Control</h6>
                        <dl>
                            <dt><i class="fas fa-list-ol text-primary me-2"></i>Request Queue</dt>
                            <dd class="text-muted mb-3">Internal buffer holding requests waiting to be processed. Size controlled by <code>max_queue_depth</code>. Triggers backpressure at 80% capacity.</dd>
                            
                            <dt><i class="fas fa-pause-circle text-danger me-2"></i>Backpressure</dt>
                            <dd class="text-muted mb-3">Flow control that pauses message consumption when queue exceeds 80% capacity. No messages are rejected - they wait at the broker until consumption resumes at 50%.</dd>
                            
                            <dt><i class="fas fa-exclamation-triangle text-warning me-2"></i>Backpressure Events</dt>
                            <dd class="text-muted mb-3">Number of times backpressure has been activated. Frequent activations may indicate need for more worker threads or slower upstream systems.</dd>
                            
                            <dt><i class="fas fa-cogs text-secondary me-2"></i>Thread Pool</dt>
                            <dd class="text-muted mb-3">Worker threads that process requests from the queue. Size controlled by <code>thread_pool_size</code>. More threads = higher throughput.</dd>
                            
                            <dt><i class="fas fa-sync-alt text-info me-2"></i>Hot Reload</dt>
                            <dd class="text-muted mb-3">Configuration changes in <code>request_response.json</code> are detected automatically without server restart. New brokers connect and removed brokers disconnect.</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="py-4 mt-5 border-top">
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-database me-2"></i><span th:text="${appName} ?: 'Kuber'">Kuber</span> Distributed Cache</h6>
                    <p class="text-muted small mb-0">Version 1.7.4</p>
                </div>
                <div class="col-md-6 text-end">
                    <p class="text-muted small mb-0">
                        Copyright &copy; 2025-2030, All Rights Reserved<br>
                        Ashutosh Sinha | <a href="mailto:ajsinha@gmail.com">ajsinha@gmail.com</a><br>
                        <span class="badge bg-warning text-dark">Patent Pending</span>
                    </p>
                </div>
            </div>
        </footer>
    </div>
</main>

<!-- Add Broker Modal -->
<div class="modal fade" id="addBrokerModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Add Message Broker</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="addBrokerForm">
                    <div class="mb-3">
                        <label class="form-label">Broker Name</label>
                        <input type="text" class="form-control" id="brokerName" required placeholder="e.g., production_kafka">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Display Name</label>
                        <input type="text" class="form-control" id="brokerDisplayName" placeholder="e.g., Production Kafka">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Broker Type</label>
                        <select class="form-select" id="brokerType" onchange="showConnectionFields()">
                            <option value="kafka">Apache Kafka</option>
                            <option value="activemq">Apache ActiveMQ</option>
                            <option value="rabbitmq">RabbitMQ</option>
                            <option value="ibmmq">IBM MQ</option>
                        </select>
                    </div>
                    
                    <!-- Kafka Connection -->
                    <div id="kafkaFields" class="connection-fields">
                        <div class="mb-3">
                            <label class="form-label">Bootstrap Servers</label>
                            <input type="text" class="form-control" id="kafka_bootstrap_servers" placeholder="localhost:9092">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Group ID</label>
                            <input type="text" class="form-control" id="kafka_group_id" value="kuber-request-processor">
                        </div>
                    </div>
                    
                    <!-- ActiveMQ Connection -->
                    <div id="activemqFields" class="connection-fields" style="display:none;">
                        <div class="mb-3">
                            <label class="form-label">Broker URL</label>
                            <input type="text" class="form-control" id="activemq_broker_url" placeholder="tcp://localhost:61616">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="activemq_username">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="activemq_password">
                        </div>
                    </div>
                    
                    <!-- RabbitMQ Connection -->
                    <div id="rabbitmqFields" class="connection-fields" style="display:none;">
                        <div class="mb-3">
                            <label class="form-label">Host</label>
                            <input type="text" class="form-control" id="rabbitmq_host" placeholder="localhost">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Port</label>
                            <input type="number" class="form-control" id="rabbitmq_port" value="5672">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Virtual Host</label>
                            <input type="text" class="form-control" id="rabbitmq_virtual_host" value="/">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="rabbitmq_username">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="rabbitmq_password">
                        </div>
                    </div>
                    
                    <!-- IBM MQ Connection -->
                    <div id="ibmmqFields" class="connection-fields" style="display:none;">
                        <div class="mb-3">
                            <label class="form-label">Queue Manager</label>
                            <input type="text" class="form-control" id="ibmmq_queue_manager">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Channel</label>
                            <input type="text" class="form-control" id="ibmmq_channel">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Connection Name</label>
                            <input type="text" class="form-control" id="ibmmq_conn_name" placeholder="hostname(port)">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Username</label>
                            <input type="text" class="form-control" id="ibmmq_username">
                        </div>
                        <div class="mb-3">
                            <label class="form-label">Password</label>
                            <input type="password" class="form-control" id="ibmmq_password">
                        </div>
                    </div>
                    
                    <div class="form-check mb-3">
                        <input type="checkbox" class="form-check-input" id="brokerEnabled" checked>
                        <label class="form-check-label">Enabled</label>
                    </div>
                </form>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addBroker()">Add Broker</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Topic Modal -->
<div class="modal fade" id="addTopicModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title"><i class="fas fa-plus me-2"></i>Add Request Topic</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <input type="hidden" id="topicBrokerName">
                <div class="mb-3">
                    <label class="form-label">Topic Name</label>
                    <input type="text" class="form-control" id="topicName" placeholder="e.g., ccs_cache_request">
                    <small class="text-muted">Response topic will be automatically derived (e.g., ccs_cache_response)</small>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" onclick="addTopic()">Add Topic</button>
            </div>
        </div>
    </div>
</div>

<th:block th:replace="~{layout :: scripts}"></th:block>

<script>
function showConnectionFields() {
    document.querySelectorAll('.connection-fields').forEach(el => el.style.display = 'none');
    const type = document.getElementById('brokerType').value;
    document.getElementById(type + 'Fields').style.display = 'block';
}

function toggleMessaging(enabled) {
    fetch('/api/v1/messaging/toggle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enabled: enabled})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function addBroker() {
    const type = document.getElementById('brokerType').value;
    const connection = {};
    
    if (type === 'kafka') {
        connection.bootstrap_servers = document.getElementById('kafka_bootstrap_servers').value;
        connection.group_id = document.getElementById('kafka_group_id').value;
    } else if (type === 'activemq') {
        connection.broker_url = document.getElementById('activemq_broker_url').value;
        connection.username = document.getElementById('activemq_username').value;
        connection.password = document.getElementById('activemq_password').value;
    } else if (type === 'rabbitmq') {
        connection.host = document.getElementById('rabbitmq_host').value;
        connection.port = document.getElementById('rabbitmq_port').value;
        connection.virtual_host = document.getElementById('rabbitmq_virtual_host').value;
        connection.username = document.getElementById('rabbitmq_username').value;
        connection.password = document.getElementById('rabbitmq_password').value;
    } else if (type === 'ibmmq') {
        connection.queue_manager = document.getElementById('ibmmq_queue_manager').value;
        connection.channel = document.getElementById('ibmmq_channel').value;
        connection.conn_name = document.getElementById('ibmmq_conn_name').value;
        connection.username = document.getElementById('ibmmq_username').value;
        connection.password = document.getElementById('ibmmq_password').value;
    }
    
    fetch('/api/v1/messaging/brokers', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            name: document.getElementById('brokerName').value,
            displayName: document.getElementById('brokerDisplayName').value,
            type: type,
            enabled: document.getElementById('brokerEnabled').checked,
            connection: connection,
            requestTopics: []
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function removeBroker(name) {
    if (!confirm('Remove broker "' + name + '"?')) return;
    
    fetch('/api/v1/messaging/brokers/' + encodeURIComponent(name), {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function showAddTopicModal(brokerName) {
    document.getElementById('topicBrokerName').value = brokerName;
    document.getElementById('topicName').value = '';
    new bootstrap.Modal(document.getElementById('addTopicModal')).show();
}

function addTopic() {
    const brokerName = document.getElementById('topicBrokerName').value;
    const topic = document.getElementById('topicName').value;
    
    fetch('/api/v1/messaging/brokers/' + encodeURIComponent(brokerName) + '/topics', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({topic: topic})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function removeTopic(brokerName, topic) {
    if (!confirm('Remove topic "' + topic + '" from broker "' + brokerName + '"?')) return;
    
    fetch('/api/v1/messaging/brokers/' + encodeURIComponent(brokerName) + '/topics/' + encodeURIComponent(topic), {
        method: 'DELETE'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function drainQueue(count) {
    const msg = count === 0 ? 'Drain ALL requests from queue?' : 'Drain ' + count + ' requests from queue?';
    if (!confirm(msg + '\n\nDrained requests will receive error responses.')) return;
    
    fetch('/api/v1/messaging/queue/drain', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({count: count})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert('Drained ' + data.drained + ' request(s)');
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

function retrySubscription(brokerName) {
    fetch('/api/v1/messaging/retry/' + encodeURIComponent(brokerName), {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            alert(data.message);
            location.reload();
        } else {
            alert('Error: ' + data.error);
        }
    });
}

// ==================== Broker Control Functions ====================

function enableBroker(brokerName) {
    fetch('/api/v1/messaging/brokers/' + encodeURIComponent(brokerName) + '/enable', {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message);
            location.reload();
        } else {
            showToast('error', 'Error: ' + data.error);
        }
    })
    .catch(err => {
        showToast('error', 'Request failed: ' + err.message);
    });
}

function disableBroker(brokerName) {
    if (!confirm('Disable broker "' + brokerName + '"?\n\nThis will disconnect from the broker and stop processing messages.')) return;
    
    fetch('/api/v1/messaging/brokers/' + encodeURIComponent(brokerName) + '/disable', {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message);
            location.reload();
        } else {
            showToast('error', 'Error: ' + data.error);
        }
    })
    .catch(err => {
        showToast('error', 'Request failed: ' + err.message);
    });
}

function pauseBroker(brokerName) {
    if (!confirm('Pause broker "' + brokerName + '"?\n\nMessages will queue up at the broker until resumed.')) return;
    
    fetch('/api/v1/messaging/brokers/' + encodeURIComponent(brokerName) + '/pause', {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message);
            location.reload();
        } else {
            showToast('error', 'Error: ' + data.error);
        }
    })
    .catch(err => {
        showToast('error', 'Request failed: ' + err.message);
    });
}

function resumeBroker(brokerName) {
    fetch('/api/v1/messaging/brokers/' + encodeURIComponent(brokerName) + '/resume', {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message);
            location.reload();
        } else {
            showToast('error', 'Error: ' + data.error);
        }
    })
    .catch(err => {
        showToast('error', 'Request failed: ' + err.message);
    });
}

// Global Service Enable/Disable
function enableService() {
    if (!confirm('Enable Request/Response Messaging globally?\n\nThis will activate message processing and connect all enabled brokers.')) return;
    
    fetch('/api/v1/messaging/enable', {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message);
            location.reload();
        } else {
            showToast('error', 'Error: ' + data.error);
        }
    })
    .catch(err => {
        showToast('error', 'Request failed: ' + err.message);
    });
}

function disableService() {
    if (!confirm('Disable Request/Response Messaging globally?\n\nThis will disconnect all brokers and stop message processing.\nMessages will queue at the brokers until re-enabled.')) return;
    
    fetch('/api/v1/messaging/disable', {
        method: 'POST'
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message);
            location.reload();
        } else {
            showToast('error', 'Error: ' + data.error);
        }
    })
    .catch(err => {
        showToast('error', 'Request failed: ' + err.message);
    });
}

// Toast notification helper
function showToast(type, message) {
    // Create toast container if not exists
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'position-fixed bottom-0 end-0 p-3';
        container.style.zIndex = '11';
        document.body.appendChild(container);
    }
    
    const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    
    const toastHtml = `
        <div class="toast align-items-center text-white ${bgClass} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body">
                    <i class="fas ${icon} me-2"></i>${message}
                </div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>
    `;
    
    const wrapper = document.createElement('div');
    wrapper.innerHTML = toastHtml;
    const toastEl = wrapper.firstElementChild;
    container.appendChild(toastEl);
    
    const toast = new bootstrap.Toast(toastEl, {delay: 3000});
    toast.show();
    
    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}

// Auto-refresh every 10 seconds
setInterval(() => {
    fetch('/api/v1/messaging/status')
    .then(r => r.json())
    .then(data => {
        if (data.stats) {
            // Update stats display without full page reload
        }
    });
}, 10000);
</script>

</body>
</html>
