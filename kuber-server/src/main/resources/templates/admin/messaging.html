<!DOCTYPE html>
<!--
  ~ Copyright © 2025-2030, All Rights Reserved
  ~ Ashutosh Sinha | Email: ajsinha@gmail.com
  -->
<html xmlns:th="http://www.thymeleaf.org">
<head th:replace="~{layout :: head('Messaging Admin')}"></head>
<body class="d-flex flex-column min-vh-100">

<nav th:replace="~{layout :: navbar}"></nav>

<main class="flex-fill">
    <div class="container-fluid py-4">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="/admin"><i class="fas fa-cog me-1"></i>Admin</a></li>
                <li class="breadcrumb-item active" aria-current="page">Request/Response Messaging</li>
            </ol>
        </nav>

        <!-- Service Not Available -->
        <div th:if="${!serviceAvailable}" class="alert alert-warning">
            <i class="fas fa-exclamation-triangle me-2"></i>
            <strong>Service Not Available</strong><br>
            The Request/Response Messaging service is not configured. 
            Create <code>config/request_response.json</code> (or set <code>kuber.messaging.request-response-config-file</code>) and restart the server.
        </div>

        <!-- Service Available -->
        <div th:if="${serviceAvailable}">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1 class="display-6"><i class="fas fa-exchange-alt me-3 text-primary"></i>Request/Response Messaging</h1>
                <div>
                    <!-- Global Service Toggle -->
                    <div class="btn-group me-2" role="group">
                        <button th:if="${stats.enabled}" class="btn btn-danger" onclick="disableService()">
                            <i class="fas fa-power-off me-1"></i>Disable Service
                        </button>
                        <button th:unless="${stats.enabled}" class="btn btn-success" onclick="enableService()">
                            <i class="fas fa-power-off me-1"></i>Enable Service
                        </button>
                    </div>
                    <a href="/admin/messaging/queue" class="btn btn-outline-info me-2">
                        <i class="fas fa-list-ol me-1"></i>View Queue
                    </a>
                    <a href="/admin/messaging/logs" class="btn btn-outline-secondary me-2">
                        <i class="fas fa-file-alt me-1"></i>View Logs
                    </a>
                    <a href="/admin/brokers" class="btn btn-outline-info me-2">
                        <i class="fas fa-server me-1"></i>Manage Brokers
                    </a>
                    <a href="/admin/messaging/add-channel" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>Add Channel
                    </a>
                </div>
            </div>
            
            <!-- Global Service Status Alert -->
            <div th:unless="${stats.enabled}" class="alert alert-warning mb-4">
                <i class="fas fa-exclamation-triangle me-2"></i>
                <strong>Service Disabled:</strong> Request/Response Messaging is globally disabled. 
                Click "Enable Service" to activate message processing for all channels.
            </div>

            <!-- Architecture Info -->
            <div class="alert alert-light border mb-4">
                <i class="fas fa-info-circle text-primary me-2"></i>
                <strong>How it works:</strong> Channels connect to brokers defined on the 
                <a href="/admin/brokers">Message Brokers</a> page. Each channel listens on request topics 
                and sends back responses. To add a new channel, click 
                <a href="/admin/messaging/add-channel">Add Channel</a> and select a broker.
                To define a new broker connection, visit <a href="/admin/brokers/add">Add Broker</a> first.
            </div>

            <!-- Status Cards -->
            <div class="row mb-4">
                <div class="col-md-3">
                    <div class="card text-white" th:classappend="${stats.running} ? 'bg-success' : 'bg-secondary'">
                        <div class="card-body text-center">
                            <i class="fas fa-power-off fa-2x mb-2"></i>
                            <h4 th:text="${stats.running} ? 'Running' : 'Stopped'">Status</h4>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-info text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-plug fa-2x mb-2"></i>
                            <h4 th:text="${stats.activeBrokers}">0</h4>
                            <p class="mb-0">Active Channels</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-primary text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-inbox fa-2x mb-2"></i>
                            <h4 th:text="${stats.requestsReceived}">0</h4>
                            <p class="mb-0">Requests Received</p>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="card bg-success text-white">
                        <div class="card-body text-center">
                            <i class="fas fa-check-circle fa-2x mb-2"></i>
                            <h4 th:text="${stats.requestsProcessed}">0</h4>
                            <p class="mb-0">Requests Processed</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Queue Status -->
            <div class="row mb-4">
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header d-flex justify-content-between align-items-center">
                            <h5 class="mb-0"><i class="fas fa-tachometer-alt me-2"></i>Queue Status</h5>
                            <div>
                                <span th:if="${stats.backpressureActive}" class="badge bg-danger me-2">
                                    <i class="fas fa-pause-circle me-1"></i>Backpressure Active
                                </span>
                                <a href="/admin/messaging/queue" class="btn btn-sm btn-outline-primary">
                                    <i class="fas fa-external-link-alt me-1"></i>Details
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="progress mb-3" style="height: 30px;">
                                <div class="progress-bar" role="progressbar"
                                     th:style="'width: ' + (${stats.queueSize} * 100 / ${stats.maxQueueSize}) + '%'"
                                     th:classappend="${stats.queueSize > stats.maxQueueSize * 0.8} ? 'bg-danger' : (${stats.queueSize > stats.maxQueueSize * 0.5} ? 'bg-warning' : 'bg-success')"
                                     th:text="${stats.queueSize} + ' / ' + ${stats.maxQueueSize}">
                                    0 / 100
                                </div>
                            </div>
                            <div class="row text-center">
                                <div class="col-3">
                                    <h6 class="text-warning" th:text="${stats.backpressureActivations}">0</h6>
                                    <small class="text-muted">Backpressure Events</small>
                                </div>
                                <div class="col-3">
                                    <h6 class="text-info" th:text="${stats.requestsDrained}">0</h6>
                                    <small class="text-muted">Drained</small>
                                </div>
                                <div class="col-3">
                                    <h6 class="text-danger" th:text="${stats.authFailures}">0</h6>
                                    <small class="text-muted">Auth Failures</small>
                                </div>
                                <div class="col-3">
                                    <h6 class="text-danger" th:text="${stats.processingErrors}">0</h6>
                                    <small class="text-muted">Errors</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="card">
                        <div class="card-header">
                            <h5 class="mb-0"><i class="fas fa-cogs me-2"></i>Configuration</h5>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <span>Messaging Enabled</span>
                                <div class="form-check form-switch">
                                    <input class="form-check-input" type="checkbox" id="enabledToggle"
                                           th:checked="${config != null && config.enabled}"
                                           onchange="toggleMessaging(this.checked)">
                                </div>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Max Queue Depth</span>
                                <span th:text="${config != null} ? ${config.maxQueueDepth} : 100">100</span>
                            </div>
                            <div class="d-flex justify-content-between mb-2">
                                <span>Thread Pool Size</span>
                                <span th:text="${config != null} ? ${config.threadPoolSize} : 10">10</span>
                            </div>
                            <div class="d-flex justify-content-between">
                                <span>Config File</span>
                                <code class="small">config/request_response.json</code>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Channel List -->
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="fas fa-plug me-2"></i>Messaging Channels</h5>
                    <a href="/admin/brokers" class="btn btn-sm btn-outline-info">
                        <i class="fas fa-server me-1"></i>Broker Registry
                    </a>
                </div>
                <div class="card-body p-0">
                    <div th:if="${config == null || config.brokers.isEmpty()}" class="text-center text-muted py-4">
                        <i class="fas fa-inbox fa-3x mb-3"></i>
                        <p>No channels configured.</p>
                        <p>
                            <a href="/admin/messaging/add-channel" class="btn btn-primary btn-sm me-2">
                                <i class="fas fa-plus me-1"></i>Add Channel
                            </a>
                            <a href="/admin/brokers" class="btn btn-outline-info btn-sm">
                                <i class="fas fa-server me-1"></i>Manage Brokers
                            </a>
                        </p>
                        <p class="small">Channels reference brokers from the <a href="/admin/brokers">Broker Registry</a>. 
                        If no brokers exist, <a href="/admin/brokers/add">add one</a> first.</p>
                    </div>
                    
                    <div th:if="${config != null && !config.brokers.isEmpty()}" class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>Channel</th>
                                    <th>Broker</th>
                                    <th>Type</th>
                                    <th>Status</th>
                                    <th>Request Topics</th>
                                    <th>Stats</th>
                                    <th class="text-end">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="entry : ${config.brokers}" 
                                    th:classappend="${!entry.value.enabled} ? 'table-secondary' : ''">
                                    <!-- Channel Name -->
                                    <td>
                                        <strong th:text="${entry.key}">channel</strong>
                                    </td>
                                    <!-- Broker Name (from registry) -->
                                    <td>
                                        <a th:href="@{/admin/brokers}" class="text-decoration-none" title="View in Broker Registry">
                                            <i class="fas fa-server text-muted me-1"></i>
                                            <span th:text="${entry.value.displayName} ?: ${entry.key}">broker</span>
                                        </a>
                                    </td>
                                    <!-- Broker Type -->
                                    <td>
                                        <span class="badge" 
                                              th:classappend="${entry.value.type == 'kafka' or entry.value.type == 'confluent-kafka'} ? 'bg-warning text-dark' : (${entry.value.type == 'rabbitmq'} ? 'bg-success' : (${entry.value.type == 'activemq'} ? 'bg-info' : (${entry.value.type == 'ibmmq'} ? 'bg-danger' : 'bg-secondary')))"
                                              th:text="${entry.value.type}">kafka</span>
                                    </td>
                                    <!-- Connection Status -->
                                    <td>
                                        <span th:if="${brokerStats != null && brokerStats.containsKey(entry.key) && brokerStats.get(entry.key).connected && !(brokerStats.get(entry.key).paused)}" 
                                              class="badge bg-success">
                                            <i class="fas fa-link me-1"></i>Connected
                                        </span>
                                        <span th:if="${brokerStats != null && brokerStats.containsKey(entry.key) && brokerStats.get(entry.key).paused}" 
                                              class="badge bg-warning">
                                            <i class="fas fa-pause me-1"></i>Paused
                                        </span>
                                        <span th:if="${entry.value.enabled && (brokerStats == null || !brokerStats.containsKey(entry.key) || !brokerStats.get(entry.key).connected)}" 
                                              class="badge bg-danger">
                                            <i class="fas fa-unlink me-1"></i>Disconnected
                                        </span>
                                        <span th:if="${!entry.value.enabled}" 
                                              class="badge bg-secondary">
                                            <i class="fas fa-power-off me-1"></i>Disabled
                                        </span>
                                    </td>
                                    <!-- Request Topics -->
                                    <td>
                                        <div th:if="${entry.value.requestTopics.isEmpty()}" class="text-muted small">None</div>
                                        <div th:each="topic : ${entry.value.requestTopics}" class="mb-1">
                                            <span class="badge bg-primary me-1" th:text="${topic}">topic</span>
                                            <i class="fas fa-arrow-right text-muted small mx-1"></i>
                                            <span class="badge bg-secondary" th:text="${T(com.kuber.server.messaging.MessagingConfig).getResponseTopic(topic)}">response</span>
                                            <button class="btn btn-link btn-sm text-danger p-0 ms-1"
                                                    th:data-channel="${entry.key}"
                                                    th:data-topic="${topic}"
                                                    onclick="removeTopic(this.getAttribute('data-channel'), this.getAttribute('data-topic'))"
                                                    title="Remove topic">
                                                <i class="fas fa-times"></i>
                                            </button>
                                        </div>
                                        <button class="btn btn-outline-primary btn-sm mt-1"
                                                th:data-channel="${entry.key}"
                                                onclick="addTopic(this.getAttribute('data-channel'))"
                                                title="Add request topic">
                                            <i class="fas fa-plus"></i>
                                        </button>
                                    </td>
                                    <!-- Stats -->
                                    <td>
                                        <div th:if="${brokerStats != null && brokerStats.containsKey(entry.key) && brokerStats.get(entry.key).connected}">
                                            <small class="text-muted">
                                                <i class="fas fa-inbox text-primary me-1"></i><span th:text="${brokerStats.get(entry.key).messagesReceived}">0</span>
                                                <i class="fas fa-check text-success ms-2 me-1"></i><span th:text="${brokerStats.get(entry.key).messagesPublished}">0</span>
                                                <i class="fas fa-exclamation-triangle text-danger ms-2 me-1"></i><span th:text="${brokerStats.get(entry.key).errors}">0</span>
                                            </small>
                                        </div>
                                        <small th:if="${brokerStats == null || !brokerStats.containsKey(entry.key) || !brokerStats.get(entry.key).connected}" class="text-muted">—</small>
                                    </td>
                                    <!-- Actions -->
                                    <td class="text-end text-nowrap">
                                        <!-- Connect (Enable) -->
                                        <button th:if="${!entry.value.enabled}" 
                                                class="btn btn-sm btn-outline-success"
                                                th:data-channel="${entry.key}"
                                                onclick="enableChannel(this.getAttribute('data-channel'))"
                                                title="Connect to broker">
                                            <i class="fas fa-plug me-1"></i>Connect
                                        </button>
                                        <!-- Disconnect (Disable) -->
                                        <button th:if="${entry.value.enabled}" 
                                                class="btn btn-sm btn-outline-danger"
                                                th:data-channel="${entry.key}"
                                                onclick="disableChannel(this.getAttribute('data-channel'))"
                                                title="Disconnect from broker">
                                            <i class="fas fa-unlink me-1"></i>Disconnect
                                        </button>
                                        <!-- Pause -->
                                        <button th:if="${entry.value.enabled && brokerStats != null && brokerStats.containsKey(entry.key) && brokerStats.get(entry.key).connected && !brokerStats.get(entry.key).paused}" 
                                                class="btn btn-sm btn-outline-warning ms-1"
                                                th:data-channel="${entry.key}"
                                                onclick="pauseChannel(this.getAttribute('data-channel'))"
                                                title="Pause consumption">
                                            <i class="fas fa-pause"></i>
                                        </button>
                                        <!-- Resume -->
                                        <button th:if="${entry.value.enabled && brokerStats != null && brokerStats.containsKey(entry.key) && brokerStats.get(entry.key).paused}" 
                                                class="btn btn-sm btn-outline-info ms-1"
                                                th:data-channel="${entry.key}"
                                                onclick="resumeChannel(this.getAttribute('data-channel'))"
                                                title="Resume consumption">
                                            <i class="fas fa-play"></i>
                                        </button>
                                        <!-- Reconnect -->
                                        <button th:if="${entry.value.enabled && (brokerStats == null || !brokerStats.containsKey(entry.key) || !brokerStats.get(entry.key).connected)}" 
                                                class="btn btn-sm btn-outline-primary ms-1"
                                                th:data-channel="${entry.key}"
                                                onclick="enableChannel(this.getAttribute('data-channel'))"
                                                title="Reconnect">
                                            <i class="fas fa-sync"></i>
                                        </button>
                                        <!-- Logs -->
                                        <a th:href="@{/admin/messaging/logs(broker=${entry.key})}" 
                                           class="btn btn-sm btn-outline-secondary ms-1"
                                           title="View logs">
                                            <i class="fas fa-file-alt"></i>
                                        </a>
                                        <!-- Remove -->
                                        <button class="btn btn-sm btn-outline-danger ms-1" 
                                                th:data-channel="${entry.key}"
                                                onclick="removeChannel(this.getAttribute('data-channel'))"
                                                title="Remove channel">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            
            <!-- Failed Subscriptions -->
            <div th:if="${failedSubscriptions != null && !failedSubscriptions.isEmpty()}" class="card mb-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h5 class="mb-0"><i class="fas fa-exclamation-triangle me-2"></i>Failed Subscriptions</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-danger mb-3">
                        <strong>Warning:</strong> The following channels failed to connect. Check broker availability and credentials on the <a href="/admin/brokers" class="alert-link">Brokers</a> page.
                    </div>
                    <div class="table-responsive">
                        <table class="table table-hover">
                            <thead class="table-light">
                                <tr>
                                    <th>Channel</th>
                                    <th>Type</th>
                                    <th>Error</th>
                                    <th>Topics</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr th:each="failed : ${failedSubscriptions}">
                                    <td th:text="${failed.brokerName}">channel</td>
                                    <td><span class="badge bg-info" th:text="${failed.brokerType}">kafka</span></td>
                                    <td class="text-danger" th:text="${failed.errorMessage}">Error message</td>
                                    <td>
                                        <span th:each="topic : ${failed.topics}" class="badge bg-secondary me-1" th:text="${topic}">topic</span>
                                    </td>
                                    <td>
                                        <button class="btn btn-sm btn-warning" 
                                                th:data-channel="${failed.brokerName}"
                                                onclick="retrySubscription(this.getAttribute('data-channel'))">
                                            <i class="fas fa-redo me-1"></i>Retry
                                        </button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Page Relationship Diagram -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-project-diagram me-2"></i>How Brokers, Event Publishing &amp; Messaging Relate</h5>
            </div>
            <div class="card-body">
                <div class="row align-items-center text-center">
                    <div class="col-md-3">
                        <div class="card border-primary">
                            <div class="card-body py-3">
                                <i class="fas fa-server fa-2x text-primary mb-2"></i>
                                <h6><a href="/admin/brokers">Broker Registry</a></h6>
                                <p class="small text-muted mb-0">Define broker connections <em>once</em> in <code>message_brokers.json</code></p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1"><i class="fas fa-long-arrow-alt-right fa-2x text-muted"></i></div>
                    <div class="col-md-3">
                        <div class="card border-success">
                            <div class="card-body py-3">
                                <i class="fas fa-broadcast-tower fa-2x text-success mb-2"></i>
                                <h6><a href="/admin/event-publishing">Event Publishing</a></h6>
                                <p class="small text-muted mb-0">Cache mutations → broker topics (one-way, fire-and-forget)</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-1"></div>
                    <div class="col-md-1"><i class="fas fa-long-arrow-alt-left fa-2x text-muted"></i></div>
                    <div class="col-md-3">
                        <div class="card border-info">
                            <div class="card-body py-3">
                                <i class="fas fa-exchange-alt fa-2x text-info mb-2"></i>
                                <h6><a href="/admin/messaging">Request/Response</a> <span class="badge bg-info">This page</span></h6>
                                <p class="small text-muted mb-0">Clients send cache operations via broker → Kuber responds</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="alert alert-light border mt-3 mb-0">
                    <i class="fas fa-lightbulb text-warning me-2"></i>
                    <strong>Key principle:</strong> Broker connections are defined once in the <a href="/admin/brokers">Broker Registry</a>. 
                    Both Event Publishing and Request/Response Messaging <em>reference</em> those shared broker definitions &mdash; they never define their own connections.
                </div>
            </div>
        </div>
        
        <!-- Glossary -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-book me-2"></i>Glossary</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3">Channel Concepts</h6>
                        <dl>
                            <dt><i class="fas fa-plug text-primary me-2"></i>Channel</dt>
                            <dd class="text-muted mb-3">A messaging endpoint that connects to a broker from the <a href="/admin/brokers">Broker Registry</a>, listens on request topics, and sends responses. Each channel has its own enable/pause state.</dd>
                            
                            <dt><i class="fas fa-server text-info me-2"></i>Broker Registry</dt>
                            <dd class="text-muted mb-3">Central list of broker connections at <a href="/admin/brokers">/admin/brokers</a>. Channels reference these brokers by name — they do not define their own connections.</dd>
                            
                            <dt><i class="fas fa-envelope text-info me-2"></i>Request Topic</dt>
                            <dd class="text-muted mb-3">Topic/queue where clients send cache operation requests (JSON messages). Each channel can listen on multiple request topics.</dd>
                            
                            <dt><i class="fas fa-reply text-success me-2"></i>Response Topic</dt>
                            <dd class="text-muted mb-3">Auto-derived topic where Kuber publishes results. Convention: replace <code>_request</code> suffix with <code>_response</code>.</dd>
                            
                            <dt><i class="fas fa-exclamation-triangle text-danger me-2"></i>Failed Subscription</dt>
                            <dd class="text-muted mb-3">Channel that could not connect — check broker status on the <a href="/admin/brokers">Brokers</a> page. Can be retried after fixing the issue.</dd>
                        </dl>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3">Channel Controls</h6>
                        <dl>
                            <dt><i class="fas fa-play text-success me-2"></i>Enable Channel</dt>
                            <dd class="text-muted mb-3">Connect to the referenced broker and start consuming messages from all configured request topics.</dd>
                            
                            <dt><i class="fas fa-stop text-danger me-2"></i>Disable Channel</dt>
                            <dd class="text-muted mb-3">Disconnect from the broker. Messages queue at the broker until re-enabled.</dd>
                            
                            <dt><i class="fas fa-pause text-warning me-2"></i>Pause Channel</dt>
                            <dd class="text-muted mb-3">Temporarily stop consuming while keeping the broker connection open. Useful for maintenance windows.</dd>
                            
                            <dt><i class="fas fa-sync text-primary me-2"></i>Reconnect</dt>
                            <dd class="text-muted mb-3">Re-establish a dropped connection without changing the channel's enabled state.</dd>
                            
                            <dt><i class="fas fa-trash text-danger me-2"></i>Remove Channel</dt>
                            <dd class="text-muted mb-3">Delete this channel from <code>request_response.json</code>. Does NOT delete the broker from the Broker Registry.</dd>
                        </dl>
                    </div>
                    <div class="col-md-4">
                        <h6 class="text-primary border-bottom pb-2 mb-3">Flow Control</h6>
                        <dl>
                            <dt><i class="fas fa-list-ol text-primary me-2"></i>Request Queue</dt>
                            <dd class="text-muted mb-3">Internal buffer for incoming requests. Size set by <code>max_queue_depth</code>. Backpressure activates at 80% capacity.</dd>
                            
                            <dt><i class="fas fa-pause-circle text-danger me-2"></i>Backpressure</dt>
                            <dd class="text-muted mb-3">Automatic flow control: pauses consumption at 80% queue capacity, resumes at 50%. No messages are dropped.</dd>
                            
                            <dt><i class="fas fa-cogs text-secondary me-2"></i>Thread Pool</dt>
                            <dd class="text-muted mb-3">Worker threads that dequeue and execute requests. Set by <code>thread_pool_size</code>.</dd>
                            
                            <dt><i class="fas fa-sync-alt text-info me-2"></i>Hot Reload</dt>
                            <dd class="text-muted mb-3">Changes to <code>request_response.json</code> are auto-detected. New channels connect, removed channels disconnect.</dd>
                            
                            <dt><i class="fas fa-key text-danger me-2"></i>Auth Failures</dt>
                            <dd class="text-muted mb-3">Requests rejected due to missing or invalid API keys. Clients must include a valid key in the message payload.</dd>
                        </dl>
                    </div>
                </div>
            </div>
        </div>

        <!-- Examples -->
        <div class="card mb-4">
            <div class="card-header bg-light">
                <h5 class="mb-0"><i class="fas fa-code me-2"></i>Example: Request/Response Message Format</h5>
            </div>
            <div class="card-body">
                <div class="row">
                    <div class="col-md-6">
                        <h6><i class="fas fa-arrow-right text-primary me-2"></i>Request (sent to request topic)</h6>
                        <pre class="bg-dark text-light p-3 rounded"><code>{
  "api_key": "kub_abc123...",
  "operation": "PUT",
  "region": "employees",
  "key": "employee/EMP001",
  "value": {
    "name": "Jane Doe",
    "department": "Engineering"
  }
}</code></pre>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-arrow-left text-success me-2"></i>Response (published to response topic)</h6>
                        <pre class="bg-dark text-light p-3 rounded"><code>{
  "correlation_id": "req-001",
  "status": "OK",
  "operation": "PUT",
  "region": "employees",
  "key": "employee/EMP001",
  "message": "Value stored successfully"
}</code></pre>
                    </div>
                </div>
                <div class="row mt-3">
                    <div class="col-md-6">
                        <h6><i class="fas fa-arrow-right text-primary me-2"></i>GET Request</h6>
                        <pre class="bg-dark text-light p-3 rounded"><code>{
  "api_key": "kub_abc123...",
  "operation": "GET",
  "region": "employees",
  "key": "employee/EMP001"
}</code></pre>
                    </div>
                    <div class="col-md-6">
                        <h6><i class="fas fa-arrow-left text-success me-2"></i>GET Response</h6>
                        <pre class="bg-dark text-light p-3 rounded"><code>{
  "correlation_id": "req-002",
  "status": "OK",
  "operation": "GET",
  "region": "employees",
  "key": "employee/EMP001",
  "value": {
    "name": "Jane Doe",
    "department": "Engineering"
  }
}</code></pre>
                    </div>
                </div>
            </div>
        </div>

        <!-- Test Request Section -->
        <div class="card border-0 shadow-sm mb-4" th:if="${serviceAvailable && config != null && !config.brokers.isEmpty()}">
            <div class="card-header bg-warning text-dark py-3">
                <h4 class="mb-0"><i class="fas fa-flask me-2"></i>Test Request</h4>
            </div>
            <div class="card-body">
                <p class="text-muted mb-3">
                    Send a test cache request to a connected channel. Kuber will process it and publish the response to the corresponding response topic.
                    Use a consumer (e.g. <code>kafka-console-consumer</code>, RabbitMQ Management UI, etc.) on the response topic to see results.
                </p>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="testBroker" class="form-label fw-semibold"><i class="fas fa-server me-1"></i>Channel</label>
                        <select id="testBroker" class="form-select" onchange="onTestBrokerChange()">
                            <option value="">-- Select Channel --</option>
                            <th:block th:each="entry : ${config.brokers}">
                                <option th:if="${entry.value.enabled}" th:value="${entry.key}" 
                                        th:text="${entry.key + ' (' + entry.value.type + ')'}"
                                        th:data-topics="${#strings.listJoin(entry.value.requestTopics, ',')}">channel</option>
                            </th:block>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label for="testTopic" class="form-label fw-semibold"><i class="fas fa-tag me-1"></i>Request Topic</label>
                        <select id="testTopic" class="form-select" onchange="onTestTopicChange()">
                            <option value="">-- Select Topic --</option>
                        </select>
                    </div>
                    <div class="col-md-4">
                        <label class="form-label fw-semibold"><i class="fas fa-reply me-1"></i>Response Topic</label>
                        <input type="text" id="testResponseTopic" class="form-control" readonly placeholder="(auto-derived)">
                    </div>
                </div>
                
                <div class="row mb-3">
                    <div class="col-md-4">
                        <label for="testTemplate" class="form-label fw-semibold"><i class="fas fa-clipboard-list me-1"></i>Load Example</label>
                        <select id="testTemplate" class="form-select" onchange="loadTestTemplate()">
                            <option value="">-- Select Example --</option>
                            <option value="ping">PING - Health Check</option>
                            <option value="info">INFO - Server Info</option>
                            <option value="regions">REGIONS - List Regions</option>
                            <option value="set">SET - Store Value</option>
                            <option value="get">GET - Retrieve Value</option>
                            <option value="del">DELETE - Delete Key</option>
                            <option value="keys">KEYS - List Keys</option>
                            <option value="exists">EXISTS - Check Key</option>
                            <option value="ttl">TTL - Get Time-To-Live</option>
                            <option value="expire">EXPIRE - Set TTL</option>
                            <option value="mget">MGET - Multi Get</option>
                            <option value="mset">MSET - Multi Set</option>
                            <option value="jset">JSET - Store JSON</option>
                            <option value="jget">JGET - Get JSON</option>
                            <option value="jupdate">JUPDATE - Merge JSON</option>
                            <option value="jremove">JREMOVE - Remove JSON Attrs</option>
                            <option value="jsearch">JSEARCH - Search JSON</option>
                            <option value="hset">HSET - Set Hash Field</option>
                            <option value="hget">HGET - Get Hash Field</option>
                            <option value="hgetall">HGETALL - Get All Hash Fields</option>
                        </select>
                    </div>
                </div>
                
                <div class="mb-3">
                    <label for="testRequestJson" class="form-label fw-semibold"><i class="fas fa-code me-1"></i>Request JSON</label>
                    <textarea id="testRequestJson" class="form-control font-monospace" rows="12" 
                              placeholder="Paste or compose a JSON request..."
                              spellcheck="false" style="tab-size: 2;"></textarea>
                    <div id="testJsonError" class="text-danger small mt-1" style="display:none;"></div>
                </div>
                
                <div class="d-flex align-items-center">
                    <button id="testSendBtn" class="btn btn-warning" onclick="sendTestRequest()" disabled>
                        <i class="fas fa-paper-plane me-1"></i> Send Test Request
                    </button>
                    <span id="testResultMsg" class="ms-3 small"></span>
                </div>
                
                <div class="alert alert-light mt-3 small mb-0">
                    <i class="fas fa-info-circle text-info me-1"></i>
                    <strong>How it works:</strong> The test message is published to the selected request topic.
                    Kuber's own consumer picks it up, authenticates via <code>api_key</code>, executes the operation,
                    and publishes the response to the response topic (request topic with <code>_request</code> suffix replaced by <code>_response</code>).
                    You need a valid API key &mdash; create one at <a href="/admin/apikeys">/admin/apikeys</a>.
                </div>
            </div>
        </div>

        <!-- Footer -->
        <footer class="py-4 mt-5 border-top">
            <div class="row">
                <div class="col-md-6">
                    <h6><i class="fas fa-database me-2"></i><span th:text="${appName} ?: 'Kuber'">Kuber</span> Distributed Cache</h6>
                    <p class="text-muted small mb-0">Version 2.6.4</p>
                </div>
                <div class="col-md-6 text-end">
                    <p class="text-muted small mb-0">
                        Copyright &copy; <span th:text="${appCopyright} ?: '2025-2030'">2025-2030</span>, All Rights Reserved<br>
                        <span th:text="${appAuthor} ?: 'Ashutosh Sinha'">Ashutosh Sinha</span> | <a th:href="'mailto:' + ${appEmail}" href="mailto:ajsinha@gmail.com"><span th:text="${appEmail} ?: 'ajsinha@gmail.com'">ajsinha@gmail.com</span></a><br></p>
                </div>
            </div>
        </footer>
    </div>
</main>

<footer th:replace="~{layout :: footer}"></footer>
<th:block th:replace="~{layout :: scripts}"></th:block>

<script>
function toggleMessaging(enabled) {
    fetch('/api/v1/messaging/toggle', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({enabled: enabled})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
        else alert('Error: ' + data.error);
    });
}

function removeChannel(name) {
    if (!confirm('Remove channel "' + name + '"?\n\nThis removes the channel from request_response.json.\nThe broker connection in the Broker Registry is NOT affected.')) return;
    fetch('/api/v1/messaging/brokers/' + encodeURIComponent(name), { method: 'DELETE' })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
        else alert('Error: ' + data.error);
    });
}

function addTopic(channelName) {
    const topic = prompt('Enter request topic/queue name for channel "' + channelName + '":\n(Response topic will be derived automatically)');
    if (!topic || !topic.trim()) return;
    fetch('/api/v1/messaging/brokers/' + encodeURIComponent(channelName) + '/topics', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({topic: topic.trim()})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
        else alert('Error: ' + data.error);
    });
}

function removeTopic(channelName, topic) {
    if (!confirm('Remove topic "' + topic + '" from channel "' + channelName + '"?')) return;
    fetch('/api/v1/messaging/brokers/' + encodeURIComponent(channelName) + '/topics/' + encodeURIComponent(topic), { method: 'DELETE' })
    .then(r => r.json())
    .then(data => {
        if (data.success) location.reload();
        else alert('Error: ' + data.error);
    });
}

function drainQueue(count) {
    const msg = count === 0 ? 'Drain ALL requests from queue?' : 'Drain ' + count + ' requests from queue?';
    if (!confirm(msg + '\n\nDrained requests will receive error responses.')) return;
    fetch('/api/v1/messaging/queue/drain', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({count: count})
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) { alert('Drained ' + data.drained + ' request(s)'); location.reload(); }
        else alert('Error: ' + data.error);
    });
}

function retrySubscription(channelName) {
    fetch('/api/v1/messaging/retry/' + encodeURIComponent(channelName), { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if (data.success) { showToast('success', data.message); location.reload(); }
        else showToast('error', 'Error: ' + data.error);
    });
}

// ==================== Channel Control Functions ====================

function enableChannel(channelName) {
    fetch('/api/v1/messaging/brokers/' + encodeURIComponent(channelName) + '/enable', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if (data.success) { showToast('success', data.message); location.reload(); }
        else showToast('error', 'Error: ' + data.error);
    })
    .catch(err => showToast('error', 'Request failed: ' + err.message));
}

function disableChannel(channelName) {
    if (!confirm('Disable channel "' + channelName + '"?\n\nThis will disconnect from the broker and stop processing messages.')) return;
    fetch('/api/v1/messaging/brokers/' + encodeURIComponent(channelName) + '/disable', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if (data.success) { showToast('success', data.message); location.reload(); }
        else showToast('error', 'Error: ' + data.error);
    })
    .catch(err => showToast('error', 'Request failed: ' + err.message));
}

function pauseChannel(channelName) {
    if (!confirm('Pause channel "' + channelName + '"?\n\nMessages will queue at the broker until resumed.')) return;
    fetch('/api/v1/messaging/brokers/' + encodeURIComponent(channelName) + '/pause', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if (data.success) { showToast('success', data.message); location.reload(); }
        else showToast('error', 'Error: ' + data.error);
    })
    .catch(err => showToast('error', 'Request failed: ' + err.message));
}

function resumeChannel(channelName) {
    fetch('/api/v1/messaging/brokers/' + encodeURIComponent(channelName) + '/resume', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if (data.success) { showToast('success', data.message); location.reload(); }
        else showToast('error', 'Error: ' + data.error);
    })
    .catch(err => showToast('error', 'Request failed: ' + err.message));
}

// Global Service Enable/Disable
function enableService() {
    if (!confirm('Enable Request/Response Messaging globally?\n\nThis will activate processing and connect all enabled channels.')) return;
    fetch('/api/v1/messaging/enable', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if (data.success) { showToast('success', data.message); location.reload(); }
        else showToast('error', 'Error: ' + data.error);
    })
    .catch(err => showToast('error', 'Request failed: ' + err.message));
}

function disableService() {
    if (!confirm('Disable Request/Response Messaging globally?\n\nThis will disconnect all channels and stop processing.\nMessages will queue at the brokers until re-enabled.')) return;
    fetch('/api/v1/messaging/disable', { method: 'POST' })
    .then(r => r.json())
    .then(data => {
        if (data.success) { showToast('success', data.message); location.reload(); }
        else showToast('error', 'Error: ' + data.error);
    })
    .catch(err => showToast('error', 'Request failed: ' + err.message));
}

// Toast notification helper
function showToast(type, message) {
    let container = document.getElementById('toast-container');
    if (!container) {
        container = document.createElement('div');
        container.id = 'toast-container';
        container.className = 'position-fixed bottom-0 end-0 p-3';
        container.style.zIndex = '11';
        document.body.appendChild(container);
    }
    const bgClass = type === 'success' ? 'bg-success' : 'bg-danger';
    const icon = type === 'success' ? 'fa-check-circle' : 'fa-exclamation-circle';
    const toastHtml = `
        <div class="toast align-items-center text-white ${bgClass} border-0" role="alert">
            <div class="d-flex">
                <div class="toast-body"><i class="fas ${icon} me-2"></i>${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
            </div>
        </div>`;
    const wrapper = document.createElement('div');
    wrapper.innerHTML = toastHtml;
    const toastEl = wrapper.firstElementChild;
    container.appendChild(toastEl);
    const toast = new bootstrap.Toast(toastEl, {delay: 3000});
    toast.show();
    toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
}

// Auto-refresh every 10 seconds
setInterval(() => {
    fetch('/api/v1/messaging/status').then(r => r.json()).then(data => {});
}, 10000);

// ==================== Test Request ====================

function onTestBrokerChange() {
    const sel = document.getElementById('testBroker');
    const topicSel = document.getElementById('testTopic');
    topicSel.innerHTML = '<option value="">-- Select Topic --</option>';
    document.getElementById('testResponseTopic').value = '';
    document.getElementById('testSendBtn').disabled = true;
    
    if (!sel.value) return;
    
    const opt = sel.options[sel.selectedIndex];
    const topics = opt.dataset.topics ? opt.dataset.topics.split(',') : [];
    topics.forEach(t => {
        if (t.trim()) {
            const o = document.createElement('option');
            o.value = t.trim();
            o.textContent = t.trim();
            topicSel.appendChild(o);
        }
    });
    
    if (topics.length === 1 && topics[0].trim()) {
        topicSel.value = topics[0].trim();
        onTestTopicChange();
    }
}

function onTestTopicChange() {
    const topic = document.getElementById('testTopic').value;
    const respField = document.getElementById('testResponseTopic');
    const sendBtn = document.getElementById('testSendBtn');
    
    if (!topic) {
        respField.value = '';
        sendBtn.disabled = true;
        return;
    }
    
    // Derive response topic
    respField.value = topic.endsWith('_request') 
        ? topic.substring(0, topic.length - '_request'.length) + '_response'
        : topic + '_response';
    sendBtn.disabled = false;
}

const testTemplates = {
    ping: {
        api_key: "YOUR_API_KEY",
        message_id: "test-ping-001",
        operation: "PING"
    },
    info: {
        api_key: "YOUR_API_KEY",
        message_id: "test-info-001",
        operation: "INFO"
    },
    regions: {
        api_key: "YOUR_API_KEY",
        message_id: "test-regions-001",
        operation: "REGIONS"
    },
    set: {
        api_key: "YOUR_API_KEY",
        message_id: "test-set-001",
        operation: "SET",
        region: "default",
        key: "test:user:1001",
        value: "{\"name\":\"John Doe\",\"email\":\"john@example.com\",\"age\":30}"
    },
    get: {
        api_key: "YOUR_API_KEY",
        message_id: "test-get-001",
        operation: "GET",
        region: "default",
        key: "test:user:1001"
    },
    del: {
        api_key: "YOUR_API_KEY",
        message_id: "test-del-001",
        operation: "DELETE",
        region: "default",
        key: "test:user:1001"
    },
    keys: {
        api_key: "YOUR_API_KEY",
        message_id: "test-keys-001",
        operation: "KEYS",
        region: "default",
        pattern: "test:*"
    },
    exists: {
        api_key: "YOUR_API_KEY",
        message_id: "test-exists-001",
        operation: "EXISTS",
        region: "default",
        key: "test:user:1001"
    },
    ttl: {
        api_key: "YOUR_API_KEY",
        message_id: "test-ttl-001",
        operation: "TTL",
        region: "default",
        key: "test:user:1001"
    },
    expire: {
        api_key: "YOUR_API_KEY",
        message_id: "test-expire-001",
        operation: "EXPIRE",
        region: "default",
        key: "test:user:1001",
        ttl: 3600
    },
    mget: {
        api_key: "YOUR_API_KEY",
        message_id: "test-mget-001",
        operation: "MGET",
        region: "default",
        keys: ["test:user:1001", "test:user:1002", "test:user:1003"]
    },
    mset: {
        api_key: "YOUR_API_KEY",
        message_id: "test-mset-001",
        operation: "MSET",
        region: "default",
        entries: {
            "test:user:1001": "{\"name\":\"John Doe\"}",
            "test:user:1002": "{\"name\":\"Jane Smith\"}",
            "test:user:1003": "{\"name\":\"Bob Wilson\"}"
        }
    },
    jset: {
        api_key: "YOUR_API_KEY",
        message_id: "test-jset-001",
        operation: "JSET",
        region: "default",
        key: "test:employee:E001",
        value: {
            name: "Alice Johnson",
            department: "Engineering",
            skills: ["Java", "Python", "Kafka"],
            address: { city: "San Francisco", state: "CA" }
        }
    },
    jget: {
        api_key: "YOUR_API_KEY",
        message_id: "test-jget-001",
        operation: "JGET",
        region: "default",
        key: "test:employee:E001"
    },
    jupdate: {
        api_key: "YOUR_API_KEY",
        message_id: "test-jupdate-001",
        operation: "JUPDATE",
        region: "default",
        key: "test:employee:E001",
        value: {
            title: "Senior Engineer",
            skills: ["Java", "Python", "Kafka", "Go"]
        }
    },
    jremove: {
        api_key: "YOUR_API_KEY",
        message_id: "test-jremove-001",
        operation: "JREMOVE",
        region: "default",
        key: "test:employee:E001",
        keys: ["address"]
    },
    jsearch: {
        api_key: "YOUR_API_KEY",
        message_id: "test-jsearch-001",
        operation: "JSEARCH",
        region: "default",
        query: "$.department == 'Engineering'"
    },
    hset: {
        api_key: "YOUR_API_KEY",
        message_id: "test-hset-001",
        operation: "HSET",
        region: "default",
        key: "test:config:app",
        field: "max_connections",
        value: "100"
    },
    hget: {
        api_key: "YOUR_API_KEY",
        message_id: "test-hget-001",
        operation: "HGET",
        region: "default",
        key: "test:config:app",
        field: "max_connections"
    },
    hgetall: {
        api_key: "YOUR_API_KEY",
        message_id: "test-hgetall-001",
        operation: "HGETALL",
        region: "default",
        key: "test:config:app"
    }
};

function loadTestTemplate() {
    const sel = document.getElementById('testTemplate');
    const textarea = document.getElementById('testRequestJson');
    const errDiv = document.getElementById('testJsonError');
    errDiv.style.display = 'none';
    
    if (!sel.value) return;
    
    const tpl = testTemplates[sel.value];
    if (tpl) {
        textarea.value = JSON.stringify(tpl, null, 2);
    }
}

function sendTestRequest() {
    const broker = document.getElementById('testBroker').value;
    const topic = document.getElementById('testTopic').value;
    const json = document.getElementById('testRequestJson').value.trim();
    const errDiv = document.getElementById('testJsonError');
    const resultMsg = document.getElementById('testResultMsg');
    const btn = document.getElementById('testSendBtn');
    
    errDiv.style.display = 'none';
    resultMsg.textContent = '';
    
    if (!broker || !topic) {
        errDiv.textContent = 'Select a channel and topic first.';
        errDiv.style.display = 'block';
        return;
    }
    if (!json) {
        errDiv.textContent = 'Request JSON cannot be empty.';
        errDiv.style.display = 'block';
        return;
    }
    
    // Validate JSON
    try {
        JSON.parse(json);
    } catch (e) {
        errDiv.textContent = 'Invalid JSON: ' + e.message;
        errDiv.style.display = 'block';
        return;
    }
    
    const originalHtml = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin me-1"></i> Sending...';
    
    fetch('/api/v1/messaging/test', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ broker: broker, topic: topic, request: json })
    })
    .then(r => r.json())
    .then(data => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        if (data.success) {
            resultMsg.innerHTML = '<span class="text-success"><i class="fas fa-check-circle me-1"></i>' + data.message + 
                '</span><br><small class="text-muted">Listen on: <code>' + data.responseTopic + '</code></small>';
            showToast('success', 'Test request published successfully');
        } else {
            resultMsg.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle me-1"></i>' + data.error + '</span>';
            showToast('error', data.error);
        }
    })
    .catch(err => {
        btn.innerHTML = originalHtml;
        btn.disabled = false;
        resultMsg.innerHTML = '<span class="text-danger"><i class="fas fa-times-circle me-1"></i>Request failed: ' + err.message + '</span>';
    });
}
</script>

</body>
</html>
