# ==============================================================================
# Kuber Distributed Cache - Application Configuration
# Copyright (c) 2025-2030, All Rights Reserved
# Ashutosh Sinha | Email: ajsinha@gmail.com
# ==============================================================================

# Application Branding
server.app.name=Kuber

# Spring Application
spring.application.name=kuber-cache

# Thymeleaf Configuration
spring.thymeleaf.cache=false
spring.thymeleaf.mode=HTML
spring.thymeleaf.encoding=UTF-8
spring.thymeleaf.prefix=classpath:/templates/
spring.thymeleaf.suffix=.html
spring.thymeleaf.check-template-location=true

# Server Configuration
server.port=8080
server.servlet.session.timeout=30m
server.shutdown=graceful
spring.lifecycle.timeout-per-shutdown-phase=30s

# Actuator Endpoints
management.endpoints.web.exposure.include=health,info,metrics
management.endpoint.health.show-details=always

# Logging Configuration
logging.level.root=INFO
logging.level.com.kuber=DEBUG
logging.level.org.apache.mina=WARN
logging.level.org.springframework.security=WARN
logging.pattern.console=%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level %logger{36} - %msg%n

# ==============================================================================
# Kuber Cache Configuration
# ==============================================================================

# Network Configuration
kuber.network.port=6380
kuber.network.bind-address=0.0.0.0
kuber.network.decoder-max-line-length=1048576
kuber.network.connection-timeout-ms=30000
kuber.network.read-timeout-ms=30000
kuber.network.read-buffer-size=2048
kuber.network.write-buffer-size=2048
kuber.network.max-connections=10000
kuber.network.io-processor-count=0

# Cache Configuration
kuber.cache.max-memory-entries=100000
# persistent-mode: true = sync writes to MongoDB, false = async writes
# Note: Regions are ALWAYS persisted to MongoDB regardless of this setting
kuber.cache.persistent-mode=false
kuber.cache.persistence-batch-size=100
kuber.cache.persistence-interval-ms=1000
kuber.cache.default-ttl-seconds=-1
kuber.cache.eviction-policy=LRU
kuber.cache.ttl-cleanup-interval-seconds=60
kuber.cache.enable-statistics=true

# Off-Heap Key Index Configuration (v1.2.2)
# Store keys in direct memory (DRAM) outside Java heap for zero GC pressure
# Recommended for millions of keys to eliminate GC pauses affecting key lookups
kuber.cache.off-heap-key-index=false
# Initial buffer size per region in MB (grows automatically up to max)
kuber.cache.off-heap-key-index-initial-size-mb=16
# Maximum buffer size per region in MB (supports >2GB using segmented buffers - v1.3.2)
kuber.cache.off-heap-key-index-max-size-mb=8192

# MongoDB Configuration
kuber.mongo.uri=mongodb://localhost:27017
kuber.mongo.database=kuber
kuber.mongo.connection-pool-size=50
kuber.mongo.connect-timeout-ms=10000
kuber.mongo.socket-timeout-ms=30000
kuber.mongo.server-selection-timeout-ms=30000
kuber.mongo.write-concern=ACKNOWLEDGED

# ==============================================================================
# Persistence Configuration
# ==============================================================================
# Supported types: mongodb, sqlite, postgresql, rocksdb, lmdb, memory
kuber.persistence.type=rocksdb

# Individual write mode for PUT/SET operations (v1.3.10)
# false (default) = ASYNC: Memory updated first, disk write in background
#                   Faster (10-100x), eventually consistent, slight data loss risk on crash
# true = SYNC: Wait for disk write before returning
#        Slower (~1-5ms per write), maximum durability
# Note: Batch operations (autoload) always use async mode regardless of this setting
kuber.persistence.sync-individual-writes=false

# SQLite Configuration (used when persistence.type=sqlite)
kuber.persistence.sqlite.path=./data/kuber.db

# PostgreSQL Configuration (used when persistence.type=postgresql)
kuber.persistence.postgresql.url=jdbc:postgresql://localhost:5432/kuber
kuber.persistence.postgresql.username=kuber
kuber.persistence.postgresql.password=kuber
kuber.persistence.postgresql.pool-size=10
kuber.persistence.postgresql.min-idle=2
kuber.persistence.postgresql.connection-timeout-ms=30000
kuber.persistence.postgresql.idle-timeout-ms=600000
kuber.persistence.postgresql.max-lifetime-ms=1800000

# RocksDB Configuration (used when persistence.type=rocksdb)
kuber.persistence.rocksdb.path=./data/rocksdb
# Enable automatic compaction to reclaim disk space
kuber.persistence.rocksdb.compaction-enabled=true
# Cron expression for scheduled compaction (default: 2:00 AM daily)
# Format: second minute hour day-of-month month day-of-week
# Examples: "0 0 2 * * ?" (2AM daily), "0 0 3 * * SUN" (3AM Sundays), "0 0 */6 * * ?" (every 6 hours)
kuber.persistence.rocksdb.compaction-cron=0 0 2 * * ?

# ZooKeeper Configuration (for replication)
kuber.zookeeper.enabled=false
kuber.zookeeper.connect-string=localhost:2181
kuber.zookeeper.session-timeout-ms=30000
kuber.zookeeper.connection-timeout-ms=10000
kuber.zookeeper.base-path=/kuber
kuber.zookeeper.retry-base-sleep-ms=1000
kuber.zookeeper.retry-max-attempts=3

# Replication Configuration
kuber.replication.sync-batch-size=1000
kuber.replication.sync-timeout-ms=30000
kuber.replication.heartbeat-interval-ms=5000
kuber.replication.primary-check-interval-ms=10000

# Security Configuration
kuber.security.users-file=classpath:users.json
# API Keys file location (default: config/apikeys.json)
kuber.security.api-keys-file=config/apikeys.json
kuber.security.session-timeout-minutes=30
kuber.security.redis-password=

# ==============================================================================
# Autoload Configuration
# ==============================================================================
# Automatically load data from CSV and JSON files placed in inbox folder
# Files are processed sequentially for data consistency (v1.3.8)
# Batch writes used for better performance (v1.3.9)
kuber.autoload.enabled=true
kuber.autoload.directory=./autoload
kuber.autoload.scan-interval-seconds=60
kuber.autoload.max-records-per-file=0
kuber.autoload.create-directories=true
kuber.autoload.file-encoding=UTF-8
# Batch size for bulk writes to persistence store (default: 8192)
# Records are accumulated and written in batches for better performance
kuber.autoload.batch-size=32768

# ==============================================================================
# Backup and Restore Configuration (v1.4.1)
# ==============================================================================
# Automatic backup and restore for RocksDB and LMDB persistence stores.
# SQL databases (SQLite, PostgreSQL) have their own backup mechanisms.

# Enable periodic backup of all regions
kuber.backup.enabled=true

# Directory where backup files are stored
# Each backup file: <region>.<timestamp>.backup.gz
kuber.backup.backup-directory=./backup

# Directory to monitor for restore files
# Place backup files here to trigger automatic restore
kuber.backup.restore-directory=./restore

# Cron expression for scheduled backups (default: 11:00 PM daily)
# Format: second minute hour day-of-month month day-of-week
# Examples:
#   0 0 23 * * *    - 11:00 PM daily (default)
#   0 0 2 * * *     - 2:00 AM daily
#   0 0 */6 * * *   - Every 6 hours
#   0 30 1 * * SUN  - 1:30 AM every Sunday
kuber.backup.cron=0 0 23 * * *

# Maximum number of backup files to keep per region (0 = keep all)
kuber.backup.max-backups-per-region=10

# Whether to create directories if they don't exist
kuber.backup.create-directories=true

# Batch size for reading/writing entries during backup/restore
kuber.backup.batch-size=10000

# File encoding for backup files
kuber.backup.file-encoding=UTF-8

# Whether to compress backup files (gzip)
kuber.backup.compress=true

# ==============================================================================
# Graceful Shutdown Configuration (v1.3.4)
# ==============================================================================
# Kuber supports multiple shutdown methods for graceful termination:
# 1. File-based: Create a shutdown signal file (touch kuber.shutdown)
# 2. REST API: POST /api/admin/shutdown with API key
# 3. SIGTERM: Standard Unix signal (handled by Spring)

# Enable file-based shutdown monitoring
# When enabled, Kuber watches for a shutdown signal file
kuber.shutdown.file-enabled=true

# Path to the shutdown signal file (relative or absolute)
# Create this file to trigger graceful shutdown: touch kuber.shutdown
# The file is automatically deleted after shutdown is initiated
kuber.shutdown.file-path=kuber.shutdown

# How often to check for the shutdown file (milliseconds)
# Minimum: 1000ms, Default: 5000ms (5 seconds)
kuber.shutdown.check-interval-ms=5000

# Enable REST API shutdown endpoint
# When enabled, POST /api/admin/shutdown triggers graceful shutdown
# Requires valid API key in X-API-Key header
kuber.shutdown.api-enabled=true

# Delay between shutdown phases (seconds)
# Each phase waits this long before proceeding to ensure clean resource release
# Phases: Signal → Stop Autoload → Stop Redis → Stop Publishing → Sync → Persist → Close
# Total shutdown time ≈ (number of phases) × phase-delay-seconds
# Default: 5 seconds (total ~35-40 seconds for complete shutdown)
kuber.shutdown.phase-delay-seconds=5

# ==============================================================================
# LMDB Configuration (used when persistence.type=lmdb)
# ==============================================================================
# LMDB (Lightning Memory-Mapped Database) - extremely fast reads via mmap
kuber.persistence.lmdb.path=./data/lmdb
# Maximum database size (bytes). LMDB pre-allocates this space.
# Default: 1GB. Increase for larger datasets.
kuber.persistence.lmdb.map-size=1073741824

# Memory Management Configuration
# Enable automated memory watcher for 24x7 operation
kuber.cache.memory-watcher-enabled=true
# High watermark - start evicting when heap exceeds this percentage
kuber.cache.memory-high-watermark-percent=85
# Low watermark - stop evicting when heap drops below this percentage
kuber.cache.memory-low-watermark-percent=50
# Number of entries to evict per batch
kuber.cache.memory-eviction-batch-size=1000
# Interval between memory checks (milliseconds)
kuber.cache.memory-watcher-interval-ms=5000

# ==============================================================================
# Event Publishing Configuration (v1.2.7)
# ==============================================================================
# 
# Kuber supports publishing cache events to multiple destinations.
# The configuration is designed for flexibility and reuse:
#
# 1. CENTRALIZED BROKER DEFINITIONS (Recommended)
#    - Define brokers/destinations once in kuber.publishing.brokers.*
#    - Regions reference brokers by name with their specific topic/queue
#
# 2. LEGACY PER-REGION CONFIGURATION (Still Supported)
#    - Configure each publisher directly under kuber.publishing.regions.{region}.*
#
# ==============================================================================

# Global publishing settings
kuber.publishing.thread-pool-size=4
kuber.publishing.queue-capacity=10000

# ==============================================================================
# CENTRALIZED BROKER DEFINITIONS
# ==============================================================================
# Define brokers once, reuse across multiple regions.
# Each broker has a name (the key), a type, and must be explicitly enabled.
# Brokers are only initialized when enabled=true.

# ============== KAFKA BROKERS ==============

# Production Kafka cluster
kuber.publishing.brokers.kafka-prod.enabled=false
kuber.publishing.brokers.kafka-prod.type=kafka
kuber.publishing.brokers.kafka-prod.bootstrap-servers=kafka1.prod:9092,kafka2.prod:9092,kafka3.prod:9092
kuber.publishing.brokers.kafka-prod.partitions=6
kuber.publishing.brokers.kafka-prod.replication-factor=3
kuber.publishing.brokers.kafka-prod.retention-hours=720
kuber.publishing.brokers.kafka-prod.acks=all
kuber.publishing.brokers.kafka-prod.batch-size=32768
kuber.publishing.brokers.kafka-prod.linger-ms=10

# Analytics Kafka cluster (different cluster for analytics workloads)
kuber.publishing.brokers.kafka-analytics.enabled=false
kuber.publishing.brokers.kafka-analytics.type=kafka
kuber.publishing.brokers.kafka-analytics.bootstrap-servers=kafka-analytics.internal:9092
kuber.publishing.brokers.kafka-analytics.partitions=12
kuber.publishing.brokers.kafka-analytics.replication-factor=2
kuber.publishing.brokers.kafka-analytics.retention-hours=168
kuber.publishing.brokers.kafka-analytics.acks=1

# ============== ACTIVEMQ BROKERS ==============

# Legacy ActiveMQ broker (for legacy system integration)
kuber.publishing.brokers.activemq-legacy.enabled=false
kuber.publishing.brokers.activemq-legacy.type=activemq
kuber.publishing.brokers.activemq-legacy.broker-url=tcp://activemq.legacy.corp:61616
kuber.publishing.brokers.activemq-legacy.username=kuber_svc
kuber.publishing.brokers.activemq-legacy.password=secret123
kuber.publishing.brokers.activemq-legacy.ttl-seconds=172800
kuber.publishing.brokers.activemq-legacy.persistent=true

# ============== RABBITMQ BROKERS ==============

# Main RabbitMQ cluster
kuber.publishing.brokers.rabbitmq-main.enabled=false
kuber.publishing.brokers.rabbitmq-main.type=rabbitmq
kuber.publishing.brokers.rabbitmq-main.host=rabbitmq.internal
kuber.publishing.brokers.rabbitmq-main.port=5672
kuber.publishing.brokers.rabbitmq-main.virtual-host=/kuber
kuber.publishing.brokers.rabbitmq-main.username=kuber_publisher
kuber.publishing.brokers.rabbitmq-main.password=rabbitsecret
kuber.publishing.brokers.rabbitmq-main.exchange-type=topic
kuber.publishing.brokers.rabbitmq-main.durable=true
kuber.publishing.brokers.rabbitmq-main.ttl-seconds=86400

# ============== IBM MQ BROKERS ==============

# Enterprise IBM MQ for financial systems
kuber.publishing.brokers.ibm-finance.enabled=false
kuber.publishing.brokers.ibm-finance.type=ibmmq
kuber.publishing.brokers.ibm-finance.host=mq.finance.corp
kuber.publishing.brokers.ibm-finance.port=1414
kuber.publishing.brokers.ibm-finance.queue-manager=FINANCE.QM
kuber.publishing.brokers.ibm-finance.channel=KUBER.SVRCONN
kuber.publishing.brokers.ibm-finance.username=kuber_mq
kuber.publishing.brokers.ibm-finance.password=mqsecret
kuber.publishing.brokers.ibm-finance.ssl-cipher-suite=TLS_RSA_WITH_AES_256_CBC_SHA256
kuber.publishing.brokers.ibm-finance.persistent=true
kuber.publishing.brokers.ibm-finance.ttl-seconds=0

# ============== FILE DESTINATIONS ==============

# Audit log files (compliance requirement)
kuber.publishing.brokers.audit-files.enabled=false
kuber.publishing.brokers.audit-files.type=file
kuber.publishing.brokers.audit-files.directory=./log/kuber/audit
kuber.publishing.brokers.audit-files.max-file-size-mb=100
kuber.publishing.brokers.audit-files.rotation-policy=daily
kuber.publishing.brokers.audit-files.retention-days=365
kuber.publishing.brokers.audit-files.compress=true

# Archive files (long-term storage)
kuber.publishing.brokers.archive-files.type=file
kuber.publishing.brokers.archive-files.directory=./archive/kuber-events
kuber.publishing.brokers.archive-files.max-file-size-mb=500
kuber.publishing.brokers.archive-files.rotation-policy=daily
kuber.publishing.brokers.archive-files.retention-days=730

# ==============================================================================
# REGION CONFIGURATIONS
# ==============================================================================
# Each region references one or more brokers defined above.
# Specify topic/queue names specific to this region.

# ============== CUSTOMERS REGION ==============
# Publishes to: Kafka (real-time) + File (audit)
kuber.publishing.regions.customers.enabled=true
kuber.publishing.regions.customers.destinations[0].broker=kafka-prod
kuber.publishing.regions.customers.destinations[0].topic=kuber.customers.events
kuber.publishing.regions.customers.destinations[1].broker=audit-files
kuber.publishing.regions.customers.destinations[1].topic=customers

# ============== ORDERS REGION ==============
# Publishes to: Kafka (analytics) + RabbitMQ (microservices) + File (audit)
kuber.publishing.regions.orders.enabled=true
kuber.publishing.regions.orders.destinations[0].broker=kafka-analytics
kuber.publishing.regions.orders.destinations[0].topic=orders-stream
kuber.publishing.regions.orders.destinations[1].broker=rabbitmq-main
kuber.publishing.regions.orders.destinations[1].topic=orders.events
kuber.publishing.regions.orders.destinations[1].routing-key=orders.#
kuber.publishing.regions.orders.destinations[1].queue=orders-events-queue
kuber.publishing.regions.orders.destinations[2].broker=audit-files
kuber.publishing.regions.orders.destinations[2].topic=orders

# ============== PRODUCTS REGION ==============
# Publishes to: Kafka (prod cluster) + ActiveMQ (legacy ERP)
kuber.publishing.regions.products.enabled=true
kuber.publishing.regions.products.destinations[0].broker=kafka-prod
kuber.publishing.regions.products.destinations[0].topic=product-catalog-events
kuber.publishing.regions.products.destinations[1].broker=activemq-legacy
kuber.publishing.regions.products.destinations[1].topic=PRODUCT.UPDATES.QUEUE

# ============== TRANSACTIONS REGION ==============
# Publishes to: IBM MQ (financial systems) + Kafka (analytics) + File (compliance)
kuber.publishing.regions.transactions.enabled=true
kuber.publishing.regions.transactions.destinations[0].broker=ibm-finance
kuber.publishing.regions.transactions.destinations[0].topic=KUBER.TRANSACTIONS.QUEUE
kuber.publishing.regions.transactions.destinations[1].broker=kafka-analytics
kuber.publishing.regions.transactions.destinations[1].topic=transactions-analytics
kuber.publishing.regions.transactions.destinations[2].broker=archive-files
kuber.publishing.regions.transactions.destinations[2].topic=transactions

# ============== INVENTORY REGION ==============
# Publishes to: RabbitMQ (warehouse system)
kuber.publishing.regions.inventory.enabled=true
kuber.publishing.regions.inventory.destinations[0].broker=rabbitmq-main
kuber.publishing.regions.inventory.destinations[0].topic=inventory.exchange
kuber.publishing.regions.inventory.destinations[0].routing-key=inventory.*
kuber.publishing.regions.inventory.destinations[0].queue=warehouse-updates

# ============== SESSION REGION (File only - for debugging) ==============
kuber.publishing.regions.sessions.enabled=true
kuber.publishing.regions.sessions.destinations[0].broker=audit-files
kuber.publishing.regions.sessions.destinations[0].topic=sessions

# ==============================================================================
# LEGACY CONFIGURATION EXAMPLE (Still Supported)
# ==============================================================================
# You can still use the traditional per-region configuration format.
# This is useful for simple setups or migrating from older versions.

# Legacy Kafka configuration (alternative to destinations[])
# kuber.publishing.regions.simple.enabled=true
# kuber.publishing.regions.simple.kafka.enabled=true
# kuber.publishing.regions.simple.kafka.bootstrap-servers=localhost:9092
# kuber.publishing.regions.simple.kafka.topic=simple-events
# kuber.publishing.regions.simple.kafka.partitions=3
# kuber.publishing.regions.simple.kafka.retention-hours=168

# Legacy ActiveMQ configuration
# kuber.publishing.regions.simple.activemq.enabled=true
# kuber.publishing.regions.simple.activemq.broker-url=tcp://localhost:61616
# kuber.publishing.regions.simple.activemq.destination=simple.events.queue

# Legacy File configuration
# kuber.publishing.regions.simple.file.enabled=true
# kuber.publishing.regions.simple.file.directory=./events/simple
# kuber.publishing.regions.simple.file.rotation-policy=daily
